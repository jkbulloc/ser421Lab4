var EntityPreviewConfig,__extends,EntityPanePreview;(function(n){var u="a",i,r,t;n.DivTag="div";n.ClickEvent="click";n.MouseUpEvent="mouseup";n.SidParamName="sid";n.AnchorHookName="h";n.HoverHookName="hover-data";n.HideClassName="b_hidden";n.LogEventType="EPWindow";n.LogFeatureName="EntityPreview";n.PreviewWindowLinkTrait="&epw=1";n.EventShow="Show";n.EventHide="Hide";n.PixelSuffix="px";n.EpvCaptionClassName="epv_caption";i=function(){function i(n,t){this._container=n;this._popOver=t}return i.prototype.initLinks=function(){var e,f,r,i,o;if(this._container!=null)for(e=this._container.getElementsByTagName(u),f=0;f<e.length;f++)if((r=e[f],i=t.decodeUrl(r.href),i)&&(o=r.getAttribute(n.HoverHookName),r.className.indexOf("b_moreLink")===-1&&i!=null&&i.search(/\Wsid:"/i)!==-1&&(i.search("&eeptype=Entity")!==-1||i.search(/&eeptype=\w+?/i)===-1)||o)){if(o==="-")continue;this.hookHandlers(r)}},i.prototype.showPreview=function(n){n!=null&&this._popOver.show(n)},i.prototype.hookHandlers=function(){},i}();n.EntityPreviewBaseController=i;r=function(){function i(){this._cache={}}return i.prototype.GetContent=function(n,i,r,u){var o=this,f,e;this._popOver=r;f=t.getSidFromUrl(n);!u&&f&&f in this._cache?(this.renderContent(this._cache[f],f),this._cache[f]==null&&t.Log("CacheFail",f)):(e=this.buildLink(n,f,i),f=u?null:f,sj_ajax(e,{callback:function(n,t){return o.requestCallback(f,n,t)}}))},i.prototype.requestCallback=function(n,i,r){n?i?(r.request.status===200?this._cache[n]=r:(this._cache[n]=null,t.Log("Fail",n)),this.renderContent(r,n)):(this._cache[n]=null,this.renderContent(this._cache[n],n),t.Log("Fail",n)):i&&r.request.status===200&&this.renderContent(r,null)},i.prototype.renderContent=function(i,r){var u=sj_ce(n.DivTag,null);i&&(i.appendTo(u),u.innerHTML==""&&t.Log("NoContent",r));this._popOver.displayContent(u,r)},i.prototype.buildLink=function(n,t,i){var r,u;return t?(u=this.parseQuery(n),r="/entitypreview?q="+(u?u:"query")+("&entityid="+t)+("&psid="+i)):r=n,EntityPreviewConfig&&EntityPreviewConfig.featureList&&(r+="&features="+EntityPreviewConfig.featureList),r},i.prototype.parseQuery=function(n){if(!n)return null;var t=/search\?q=(.+?)[&$]/.exec(n);return t?t[1]:null},i}();n.EntityPreviewContentLoader=r;t=function(){function t(){}return t.decodeUrl=function(n){try{return decodeURIComponent(n)}catch(t){return null}},t.getSidFromUrl=function(n){var r=t.decodeUrl(n),i;return r?(i=/\Wsid:"(.+?)"/i.exec(t.decodeUrl(n)),i?i[1]:null):null},t.getEntityNameFromUrl=function(n){var r=t.decodeUrl(n),i;return r?(i=/[&?]q=(.+?)&/i.exec(t.decodeUrl(n)),i?i[1].replace(/\+/g," "):null):null},t.Log=function(t,i){Log.Log(n.LogEventType,t,n.LogFeatureName,!1,n.SidParamName,i)},t.LogCiHover=function(n,t){var r,u,i,f,e;if(n){r=null;u=null;t&&(i=t.split(","),i&&i.length===2&&(u=i[1],r=i[0].toUpperCase().indexOf("SERP")!==-1?"SERP":null));f='{"T":"CI.Hover","AppNS":"'+r+'","K":"'+u+'","Name":"EntityPreview","HType":"'+n+'","TS":'+sb_gt()+"}";e=new Image;try{e.src="/fd/ls/ls.gif?IG="+_G.IG+"&Type=Event.ClientInst&DATA="+f+"&log=UserEvent"}catch(o){}}},t}();n.Util=t})(EntityPanePreview||(EntityPanePreview={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){function y(n){if(!n)return null;return n.nextElementSibling&&n.nextElementSibling.className.indexOf(e)>=0?n.nextElementSibling.getAttribute("psid"):""}function p(t){sj_evt.bind("EPReady",function(){var i=_d.getElementsByClassName(t),u,f,e,r,o;if(i!=null&&i.length!=0)for(u=new n.EntityPreviewContentLoader,r=0;r<i.length;r++)o=y(i[r]),f=new v("tpPreview",o,u),e=new l(i[r],f),e.initLinks()},!0)}var i="mouseover",r="mouseout",u="scroll",f="epv_content",e="epv_meta",o="epvRup",s="epvLup",h="epvRdown",c="epvLdown",t="hidden",l=function(t){function u(n,i){return t.call(this,n,i)||this}return __extends(u,t),u.prototype.hookHandlers=function(t){var u=this,f,e;sj_be(t,i,function(t){n.Util.Log("Trigger");sj_pd(t);sj_sp(t);u._popOver.setTargetElement(t.currentTarget);u.showPreview(t.currentTarget)});sj_be(t,r,function(n){n.currentTarget&&(sj_pd(n),sj_sp(n),u._popOver.setTargetElement(null),u._popOver.hide())});t.title="";t.children&&t.children.length>0&&(f=t.children[0],f.className.indexOf("rms_img")!==-1&&f.hasChildNodes()&&(e=f.children[0],e&&(e.title="")))},u}(n.EntityPreviewBaseController),a=function(){function n(){this.mouseOnLink=!1;this.mouseOnPreviewWindow=!1;this.windowVisible=!1}return n.prototype.shouldShow=function(){return this.mouseOnLink&&!this.mouseOnPreviewWindow&&(!this.windowVisible||this.windowVisible&&!this.sameEntity)},n.prototype.shouldHide=function(){return this.windowVisible&&!this.mouseOnPreviewWindow&&(!this.sameEntity||this.sameEntity&&!this.mouseOnLink)},n}(),v=function(){function e(n,t,i){this.EventDelay=500;this.D2Timeout=2e3;this.D5Timeout=5e3;this._loader=i;this._psid=t;this.popOverStatus=new a;this.init(n)}return e.prototype.hide=function(){var n=this;(sb_ct(this.eventTimer),this.popOverStatus.shouldHide())&&(this.eventTimer=sb_st(function(){n.popOverStatus.shouldHide()&&(n.clearDwellTimers(),n.popOverStatus.windowVisible=!1,n.hideWindow(n.currentSid),n.currentElement=null)},this.EventDelay))},e.prototype.show=function(t){var i=this;(sb_ct(this.eventTimer),this.popOverStatus.shouldShow())&&(this.eventTimer=sb_st(function(){i.popOverStatus.shouldShow()&&(i.popOverStatus.windowVisible=!0,i.currentElement=t,i.currentSid=n.Util.getSidFromUrl(t.href),i.container.setAttribute(n.AnchorHookName,t.getAttribute(n.AnchorHookName)),i.destinationUrl=t.href,i.container.href=i.destinationUrl+n.PreviewWindowLinkTrait,i.showContainer())},this.EventDelay))},e.prototype.init=function(t){var e=this;this.container=_ge(t);this.contentPane=_d.getElementsByClassName(f).item(0);this.arrowRightUp=_ge(o);this.arrowRightDown=_ge(h);this.arrowLeftUp=_ge(s);this.arrowLeftDown=_ge(c);sj_be(this.container,i,function(){e.popOverStatus.mouseOnPreviewWindow=!0});sj_be(this.container,r,function(){e.popOverStatus.mouseOnPreviewWindow=!1;e.hide()});sj_be(this.container,n.MouseUpEvent,function(){return e.hideWindow(e.currentSid)});sj_be(_w,u,function(){sb_ct(e.eventTimer);e.clearDwellTimers();e.popOverStatus.windowVisible=!1;e.hideWindow(e.currentSid);e.currentElement=null})},e.prototype.showContainer=function(){sa_cl(this.container,n.HideClassName,!0);this.displayContent(null)},e.prototype.displayContent=function(t,i){if(!i||i===this.currentSid){var r=this.currentElement?this.currentElement.getAttribute(n.HoverHookName):null;this.contentPane.innerHTML="";t==null?r?this._loader.GetContent(r,null,this,!0):this._loader.GetContent(this.destinationUrl,this._psid,this):t.innerHTML!=""&&this.currentElement&&(this.contentPane.appendChild(t),this.updateTitlePadding(),this.placeWindow(this.currentElement.getBoundingClientRect()),sa_cl(this.container,n.HideClassName,!1),this.clearDwellTimers(),this.startDwellTimers(),n.Util.Log(n.EventShow,this.currentSid),n.Util.LogCiHover("h",this.currentElement.getAttribute(n.AnchorHookName)))}},e.prototype.setTargetElement=function(n){this.popOverStatus.sameEntity=n===this.currentElement;this.popOverStatus.mouseOnLink=n===null?!1:!0},e.prototype.updateTitlePadding=function(){var t,r=_d.getElementsByClassName(n.EpvCaptionClassName),i,u;(r&&r.length>0&&(t=r.item(0)),t)&&(i=t.previousElementSibling,i)&&(t.offsetHeight>=i.offsetHeight&&t.parentElement?t.parentElement.style.height=t.offsetHeight+n.PixelSuffix:(u=(i.offsetHeight-t.offsetHeight)/2,t.style.padding=u+"px 0"))},e.prototype.startDwellTimers=function(){var t=this;this.dwell2Timer=sb_st(function(){n.Util.LogCiHover("d2",t.currentElement.getAttribute(n.AnchorHookName))},this.D2Timeout);this.dwell5Timer=sb_st(function(){n.Util.LogCiHover("d5",t.currentElement.getAttribute(n.AnchorHookName))},this.D5Timeout)},e.prototype.clearDwellTimers=function(){sb_ct(this.dwell2Timer);sb_ct(this.dwell5Timer)},e.prototype.hideWindow=function(t){this.container.className.indexOf(n.HideClassName)===-1&&(n.Util.Log(n.EventHide,t),sa_cl(this.container,n.HideClassName,!0))},e.prototype.placeWindow=function(i){var f=_w.innerWidth,v=_w.innerHeight,e=i.right-i.left,a=this.container.offsetHeight,o=300,h=15,u=30,y=v-i.bottom,c=0,l=!0,r,s;i.right<o&&i.right<f-i.left?(r=i.right,c=r<u*2?r-u:r<e/2+u*2?r-u:r-e/2-u,l=!1):(r=f-i.left,c=r<u*2?f-o+u-r:r<e/2+u*2?f-o-u:f-r+e/2-o+u);this.container.style.left=c+n.PixelSuffix;this.arrowRightUp.style.visibility=t;this.arrowRightDown.style.visibility=t;this.arrowLeftUp.style.visibility=t;this.arrowLeftDown.style.visibility=t;s=0;y>a+h?(s=i.bottom+h,l?this.arrowRightUp.style.visibility="":this.arrowLeftUp.style.visibility=""):(s=i.top-a-h,l?this.arrowRightDown.style.visibility="":this.arrowLeftDown.style.visibility="");this.container.style.top=s+n.PixelSuffix},e}();n.init=p}(EntityPanePreview||(EntityPanePreview={}))