(function(){try{var i=window.$MicrosoftMaps8,r=i.Internal,er=i.Tasks=i.Tasks||{},h=i.Traffic=i.Traffic||{},or=r.TaskData=r.TaskData||{},st=i.Anchor,ht=r.BaseTask,ct=r.BaseTaskViewModel,sr=r._BaseMapTemplateSelector,ri=i.BitmapImageTemplate,ui=i.BucketPrimitiveTemplateSelector,lt=r.ControlTemplate,fi=r.Control,d=i.DataHandlerKeys,hr=i.Internal._Debug,ei=i.DefaultTemplateSelector,w=i.GlobalConfig,g=i.GlobalDataEventHandler,cr=r._EntityHelper,lr=r._EntryPoints,ar=r._FeatureNames,rt=r._Gimme,c=r._Helper,oi=i.ImageryMapLayer,si=i.ImageFromCssHelper,vr=i.InfoboxOptions,et=r._JSEvent,hi=r._LatLonCrs,at=r._LocalStorageCache,vt=i.LocationRect,yr=i.MapView,b=i.Location,f=r.MapHelper,ci=i.MapsInfobox,li=r.MapInteractionBehavior,yt=i.MapMath,pt=i.MapTypeId,wt=r._Network,pr=r._Observable,bt=r._ObservableObject,kt=r._ObservableCollection,ai=r._Overlay,dt=r._OverlayEntity,vi=r.CameraMiniOverlayTemplate,gt=i.Point,it=i.PrimitiveOverlayHelper,yi=r.PyramidTileSpatialIndex,pi=i.RasterImageryScene,wr=i.Rectangle,n=i.ResourceManager.MapDelay,br=r._TaskDataHandlerHelper,ut=i.TaskTypes,t=w.features.traffic,wi=i.VectorMapLayer,kr=i.ZoomLevel,l=r._MapAuthentication,bi='<div data-tag="cameraCardRoot">    <div class="backArrowDiv cameraBack">            <a class="commonButton backArrowButton trafficBackButton" event:click="onBackClick" href="#" role="button" data-tag="backToProblemTypeSelectButton">                <div class="trafficBackButtonText">                    <TextBlock Text="{Binding resources.L_TrafficBackButtonText}" />                <\/div>            <\/a>    <\/div>    <div class="cameraImgHolder">        <img src="{Binding cameraImageUrl}" style:display="{Binding IsImageError Converter=boolToNotDisplay}" class="cameraImg" data-tag="cameraImg" event:error="onImageError" />        <div style:display="{Binding IsImageError Converter=boolToDisplay}" class="cameraImageError">            <TextBlock Text="{Binding resources.L_CameraImageErrorText}"/>        <\/div>    <\/div>      <div class="copyright">        <TextBlock Text="{Binding copyright}"/>    <\/div>    <div class="cameraDisclaimer" style:display="{Binding disclaimer Converter=nullToDisplayNone}">        <TextBlock Text="{Binding disclaimer}"/>    <\/div><\/div>',ki='<div id="{Binding primitive.entity.id}" class="infoboxOverlay trafficInfoboxOverlay">\t<a href="#" class="dialogClose closeIcon" data-tag="Infobox.Close" event:click="onCloseClick" title="{StaticBinding resources.L_NavBarCloseRadialMenuToolTip_Text}" role="button" ><\/a>\t<div class="infoboxTitle">\t\t<TextBlock Text="{Binding primitive.entity.title}" />\t<\/div>\t    <img src="{Binding primitive.entity.cameraImageUrl}" width="320" /><\/div>',di='<div data-tag="incidentPopupRoot">    <div>        <div class="incidentTitleRoot">            <div class="incidentTitle" data-tag="incidentTitle"> <TextBlock Text="{Binding incidentTitle}" />            <\/div>            <p class="{Binding severityType Converter=severityTypeToClass}" data-tag="severity">                <span>                    <TextBlock Text="{Binding severity}" />                <\/span>            <\/p>        <\/div>        <div class="incidentDescriptionRoot">            <p class="incidentDescription"  data-tag="trafficDescription">                <TextBlock Text="{Binding trafficDescription}" />            <\/p>                        <p class="incidentTime" data-tag="start" style:display="{Binding start Converter=nullToDisplayNone}">                <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupStartTime_Text}" /><\/span><span><TextBlock Text="{Binding start}" /><\/span>            <\/p>            <p class="incidentTime" data-tag="end" style:display="{Binding end Converter=nullToDisplayNone}">                <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupEstEndTime_Text}" /><\/span><span><TextBlock Text="{Binding end}" /><\/span>            <\/p>                    <\/div>    <\/div><\/div>',gi='<div data-tag="incidentCardRoot">   <div class="backArrowDiv cameraBack">            <a class="commonButton backArrowButton trafficBackButton" event:click="onBackClick" href="#" role="button" data-tag="backToProblemTypeSelectButton">                <div class="trafficBackButtonText">                    <TextBlock Text="{Binding resources.L_TrafficBackButtonText}" />                <\/div>            <\/a>    <\/div>    <div>        <div class="incidentTitleRoot">            <div class="incidentTitle" data-tag="incidentTitle"> <TextBlock Text="{Binding incidentTitle}" /><\/div>            <p class="{Binding severityType Converter=severityTypeToClass}" data-tag="severity"><span><TextBlock Text="{Binding severity}" /><\/span><\/p>        <\/div>        <div class="incidentDescriptionRoot">            <p class="incidentDescription"  data-tag="trafficDescription">            <TextBlock Text="{Binding trafficDescription}" /><\/p>            <p class="incidentTime" data-tag="start">            <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupStartTime_Text}" /><\/span><span><TextBlock Text="{Binding start}" /><\/span><\/p>            <p class="incidentTime" data-tag="end">            <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupEstEndTime_Text}" /><\/span><span><TextBlock Text="{Binding end}" /><\/span><\/p>        <\/div>    <\/div><\/div>',nr='<div data-tag="trafficCardRoot">    <div class="contentRoot trafficCard">        <div class="moduleRoot" data-tag="legendRoot">            <p class="moduleTitle" data-tag="legendTitle"><TextBlock Text="{Binding resources.L_TrafficLegendsTitle}" /><\/p>            <div class="legendTable" data-tag="legendContainer">                <table>                    <tbody>                        <tr>                            <td>                                <div class="tableRow">                                    <div class="tableCell">                                        <div class="legendHeavy" data-tag="legendHeavy"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendHeavyText"><TextBlock Text="{Binding resources.L_TrafficLegendsHeavy}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                            <td>                                <div class="tableRow">                                    <div class="tableCell">                                        <div class="legendLight" data-tag="legendLight"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendLightText"><TextBlock Text="{Binding resources.L_TrafficLegendsLight}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                        <\/tr>                        <tr>                            <td>                                <div class="tableRow">                                    <div class="tableCell">                                        <div class="legendModerate" data-tag="legendModerate"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendModerateText"><TextBlock Text="{Binding resources.L_TrafficLegendsModerate}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                            <td>                                <div class="tableRow">                                    <div class="tableCell">                                        <div class="legendNoTraffic" data-tag="legendNoTraffic"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendNoTrafficText"><TextBlock Text="{Binding resources.L_TrafficLegendsNoTraffic}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                        <\/tr>                        <tr>                            <td>                                <div class="tableRow">                                    <div class="tableCell">                                        <div class="legendClosed" data-tag="legendClosed"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendClosedText"><TextBlock Text="{Binding resources.L_TrafficLegendsClosed}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                        <\/tr>                    <\/tbody>                <\/table>            <\/div>        <\/div>            <\/div>    <ItemsControl ItemsSource="{Binding modules}" PanelTagName="ul">      <ItemsControl.ItemTemplate>        <DataTemplate>                <div class="contentRoot trafficCard" style:display="{Binding showModule Converter=boolToDisplay}">                    <div class="moduleRoot recentCameras" data-tag="moduleRoot">                        <p class="moduleTitle" data-tag="moduleTitle"><TextBlock Text="{Binding title}" /><\/p>                        <div>                            <ItemsControl ItemsSource="{Binding collection}" PanelTagName="ul">                                <ItemsControl.ItemTemplate>                                    <DataTemplate>                                        <a href="#" event:click="onModuleItemClick" role="button" class="{Binding incidentType Converter=typeToClass}" style:display="{Binding show Converter=boolToDisplay}" data-tag="moduleItem {Binding incidentType Converter=typeToClass}" aria-label="{Binding resources.trafficCameraAriaLabel}">                                            <div style:display="{Binding incidentType Converter=cameraTypeToDisplay}">                                                <a href="#" class="removeRecentCamera" role="button" tabindex="0" event:click="onRemoveRecentCameraClick" style:display="{Binding showRemoveRecentCamera Converter=boolToDisplay}" aria-label="{Binding resources.L_TrafficRemoveRecentCameraToolTip_Text}" data-tag="removeRecentCameraLink">                                                <\/a>                                                <div class="{Binding IsImageError Converter=errorToImagePaneClass}" data-tag="imgPreviewPlaceHolder">                                                    <img src="{Binding cameraImageUrl}" class="imgPreview" style:display="{Binding IsImageError Converter=boolToNotDisplay}" event:error="onImageError" />                                                <\/div>                                                <div class="cameraTitle" data-tag="cameraTitle">                                                    <TextBlock Text="{Binding incidentTitle}" />                                                <\/div>                                            <\/div>                                            <div style:display="{Binding incidentType Converter=incidentTypeToDisplay}" class="incidentContainer" data-tag="incidentContainer">                                                <div class="tableCell">                                                    <div class="{Binding incidentType Converter=incidentTypeToIconClass}" data-tag="incidentIcon"><\/div>                                                <\/div>                                                <div class="tableCell">                                                    <div class="trafficDescriptionText" data-tag="incidentTrafficDescription"><TextBlock Text="{Binding trafficDescription}" /><\/div>                                                    <div class="trafficDescriptionText" data-tag="incidentSeverity"><TextBlock Text="{Binding severity}" /><\/div>                                                <\/div>                                            <\/div>                                        <\/a>                                    <\/DataTemplate>                                <\/ItemsControl.ItemTemplate>                            <\/ItemsControl>                        <\/div>                        <a href="#" class="removeAllRecentCameras" style:display="{Binding showRemoveAllRecentCameras Converter=boolToDisplay}" event:click="onRemoveAllRecentCamerasClick" data-tag="removeAllRecentCamerasLink" role="button">                            <div class="removeAllRecentCamerasText" data-tag="removeAllRecentCamerasText"><TextBlock Text="{Binding resources.L_TrafficRemoveAllRecentCamerasLink}" /><\/div>                        <\/a>                        <a href="#" class="moreLink" style:display="{Binding showMoreLink Converter=boolToDisplay}" event:click="onMoreClick" data-tag="moreLink" role="button">                            <div class="moreLinkText" data-tag="moreLinkText"><TextBlock Text="{Binding moreLinkText}" /><\/div>                            <div data-tag="arrow" class="{Binding arrowClass}"><\/div>                        <\/a>                        <div class="clear"><\/div>                    <\/div>                <\/div>            <\/DataTemplate>                  <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <div class="clear"><\/div>    <div class="cameraSettings" tabindex="0" event:keyup="onCamerasKeyUp" event:click="onCamerasClick" role="checkbox" aria-checked="{Binding ariaChecked}">        <div class="switchSlot labelToggle" for="cameraToggleInput">            <div class="labelToggle_Container labelStyle">                <input id="cameraToggleInput" type="checkbox" class="labelToggle_Input" checked="checked" tabindex="-1" />                <label class="labelToggle_label" role="button" />                <label class="labelStyleSwitch" title="{Binding resources.L_TrafficsToggleCameras}" data-tag="cameraToggleSwitch">                    <TextBlock Text="{Binding resources.L_TrafficsToggleCameras}" />                <\/label>            <\/div>        <\/div>        <div class="zoomInNotification" style:display="{Binding showCameraNotification Converter=boolToDisplay}" data-tag="zoomInNotification">            <TextBlock Text="{Binding cameraNotification}" />        <\/div>    <\/div><\/div>',tr='<div class="trafficLegend" data-tag="trafficLegend">    <div class="tlGroup">        <div class="tlLegend">            <span class="tlSlow" data-tag="tlSlow"><TextBlock Text="{StaticBinding resources.L_TrafficLegendsSlow}" /><\/span>            <span class="tlFast" data-tag="tlFast"><TextBlock Text="{StaticBinding resources.L_TrafficLegendsFast}" /><\/span>            <div class="tlKey" data-tag="tlKey"><\/div>        <\/div>    <\/div><\/div>',ir='<div class="infoboxOverlay trafficMiniInfobox">    <p>        <span><TextBlock Text="{Binding primitive.entity.trafficDescription}" /><\/span>    <\/p>    <p>        <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupStartTime_Text}" /><\/span>        <span><TextBlock Text="{Binding primitive.entity.start}" /><\/span>    <\/p>    <p>        <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupEstEndTime_Text}" /><\/span>        <span><TextBlock Text="{Binding primitive.entity.end}" /><\/span>    <\/p><\/div>',rr='<div id="{Binding primitive.entity.id}" class="infoboxOverlay trafficInfoboxOverlay">\t<a href="#" class="dialogClose closeIcon" data-tag="Infobox.Close" event:click="onCloseClick" title="{StaticBinding resources.L_NavBarCloseRadialMenuToolTip_Text}" role="button" ><\/a>\t<div class="infoboxTitle">\t\t<TextBlock Text="{Binding primitive.entity.title}" />\t<\/div>\t<div class="trafficInfo">\t\t<p>\t\t\t<span><TextBlock Text="{StaticBinding resources.L_TrafficPopupSeverity_Text}" /><\/span>\t\t\t<span><TextBlock Text="{Binding primitive.entity.severity}" /><\/span>\t\t<\/p>\t\t<p>\t\t\t<span><TextBlock Text="{StaticBinding resources.L_TrafficPopupDescription_Text}" /><\/span>\t\t\t<span><TextBlock Text="{Binding primitive.entity.trafficDescription}" /><\/span>\t\t<\/p>\t\t<p>\t\t\t<span><TextBlock Text="{StaticBinding resources.L_TrafficPopupStartTime_Text}" /><\/span>\t\t\t<span><TextBlock Text="{Binding primitive.entity.start}" /><\/span>\t\t<\/p>\t\t<p>\t\t\t<span><TextBlock Text="{StaticBinding resources.L_TrafficPopupEstEndTime_Text}" /><\/span>\t\t\t<span><TextBlock Text="{Binding primitive.entity.end}" /><\/span>\t\t<\/p>\t<\/div><\/div>',a=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ft=function(n){function t(i){var r=n.call(this,i.description,null)||this;return r.id="TCAM"+t._cameraId++,r.trafficDescription=i.description,r.cameraImageUrl=i.images&&i.images.length&&i.images[0].imageUrl,r.collisionBehavior=2,r}return a(t,n),t._cameraId=1,t}(dt),p=function(){function i(){}return i.getInstance=function(){return i._instance||(i._instance=new i),i._instance},i.prototype.initialize=function(t,i){var r=this;this._initialized||(this._map=t,this._controlTemplateFactory=i,this._hoverInstatiated=!1,this.resources=n,l.instance.authenticateClientAndRetrieveSessionId(function(){r._trafficCameraCreds=l.instance.getSessionId()}),t.mapTapped.add(function(){return r.hide()}),this._initialized=!0)},i.prototype.hide=function(n){this._currentCamera&&(!n||n&&this._hoverInstatiated)&&(this._currentCamera.setOptions({visible:!1,closeDelayTime:300}),this._hoverInstatiated=!1)},i.prototype.show=function(n,r,u){var f,o,s,h,c,e;this._currentCamera&&this.hide();n&&n.incident&&(this._hoverInstatiated=r,f={showCloseButton:!1,zIndex:1006,showPointer:!0,visible:!0,htmlContent:null,location:null,autoAlignment:!0},o=i.isCamera(n)?null:this._getHtmlContentForIncident(n.incident),o?(e='<div class="bm_trfcIncidentWrapper">{0}<\/div>',f.htmlContent=e.replace("{0}",o)):(s=n.incident.images&&n.incident.images.length>0?n.incident.images[0]:null,h=t.cameraUrlFormat.replace("{imageUrl}",s?s.imageUrl:"").replace("{credentials}",this._trafficCameraCreds).replace("{culture}",w.dynamicProperties.uiLanguage),u&&(h+=i._routeCameraParam),c='<div class="trfcLoading loading"><\/div><img src="'+h+"\" class=\"cameraImg loading\" data-tag=\"cameraImg\" onload=\"(function(){g=Microsoft.Maps.Internal._Gimme; g('.MicrosoftMap .bm_trfcCamWrapper .trfcLoading').swap_class('loading','loaded'); g('.MicrosoftMap .bm_trfcCamWrapper .cameraImg').swap_class('loading', 'loaded');})()\" />",e='<div class="bm_trfcCamWrapper"><div class="cameraDesc">{0}<\/div>{1}<div class="trfCamAgencyAttrib">{2}<\/div><\/div>',f.htmlContent=e.replace("{1}",c).replace("{0}",n.incident.description).replace("{2}",n.incident.copyright)),f.visible=!0,f.location=new Microsoft.Maps.Location(n.geometry.y,n.geometry.x),f.offset=new gt(6,6),this._currentCamera?this._currentCamera.setOptions(f):(this._currentCamera=new Microsoft.Maps.Infobox(location,f),this._currentCamera.setMap(this._map)),rt(".bm_trfcCamWrapper").getParent().add_class("bm_trfcCam"),!r&&v&&v.saveIncident(n.incident))},i.isCamera=function(n){return n.incident.images&&n.incident.images.length>0},i.prototype.nullToDisplayNone=function(n){return n?"":"none"},i.prototype._getHtmlContentForIncident=function(n){var u=this,i="",f={severityTypeToClass:function(n){return tt.ConvertSeverityTypeToClass(n)},nullToDisplayNone:function(n){return u.nullToDisplayNone(n)},resources:this.resources},r,t;return n&&(r=new lt(di,f),t=r.applyDataTemplate(new tt(this._controlTemplateFactory,n,this._map)),t&&t.length>0&&(i=t[0].outerHTML)),i},i._routeCameraParam="&routeCamera=1",i}(),nt=function(n){function t(t){var i=n.call(this)||this;return i.type=ut.trafficFlipTask,i._controlTemplateFactory=t,i.displayState={colorIndex:6,groupName:"Traffic"},i}return a(t,n),t.prototype.activate=function(i,r){var u,f;r&&(this._taskState=r,u=r.incident,u&&u.type===12&&(this._taskState.location=new b(u.point.coordinates[0],u.point.coordinates[1]),this._taskState.description=u.description));this.setTitle(this._taskState.incident.description);n.prototype.activate.call(this,i,r);s.trafficTaskId=this.id;f=this._viewModel=new tt(this._controlTemplateFactory,this._taskState.incident,i);o.selectedPin||(o.selectedPin=new k(this._taskState.incident),o.selectedPin.updatePinIcon(!0));f.pin=o.selectedPin;this.addControl(f.getControl());t.trafficTaskId=this.id;this._taskState.incident.type===12&&(v.saveIncident(this._taskState.incident),s.mostRecentCameras.push(f));this.setPercentLoaded(1)},t.close=function(){var n={action:"remove",id:t.trafficTaskId};g.invokeHandler(d.taskDataHandlerKey,n)},t.prototype.deactivate=function(){var t=o.selectedPin;t&&this._viewModel.incidentData&&this._viewModel.incidentData.incidentId===t.incident.incidentId&&(t.updatePinIcon(!1),o.selectedPin=null);n.prototype.deactivate.call(this)},t.prototype.processCallback=function(){},t.prototype.serialize=function(){return this._taskState},t.prototype.setDisplayState=function(i){n.prototype.setDisplayState.call(this,i);t.trafficTaskId=this.id},t.prototype.getMenuList=function(){return[]},t.prototype.getCardIconInfo=function(){return{iconClass:"trfkTsk"}},t.prototype.isSharable=function(){return!1},t.prototype.hasDefaultFocusElement=function(){return!0},t}(ht),o=function(){function r(i,r,u,f){var o=this,s,e;this._map=i;this._perfLog=u;s=c._isCoreConfigSettingEnabled("poiRefresh");this._layer=new wi("TrafficIncidents_"+li.getUniqueId(),this,s?new ui(i):new ei(i),t.incidentsLayerZIndex);this._layer.setRenderTarget(1);this.inflateRegionOnDataFetch=!0;this._refreshInterval=t.incidentsLayerRefreshInterval;this._incidentPins={};this._incidentExpirationTimes={};this.invalidated=new et;this.resources=n;this.spatialIndex=new yi(2);this._trafficLayer=f;this._controlTemplateFactory=r;this._cameraOverlay=this._constructOverlay(r,ki);this._primitiveOverlay=this._constructOverlay(r,rr);this._primitiveMiniOverlay=this._constructOverlay(r,ir);this._cameraMiniOverlay=this._constructOverlay(r,vi);this._infoboxOptions={showCloseButton:!1,zIndex:1006,showPointer:!1,visible:!0,htmlContent:null,location:null,autoAlignment:!0};e=[];e.push(this._layer.primitiveTapped.add(function(n){o._onPrimitiveTapped(n)}));e.push(this._layer.primitiveHoverStarted.add(function(n){o._onPrimitiveHoverChanged(n,!0)}));e.push(this._layer.primitiveHoverStopped.add(function(n){o._onPrimitiveHoverChanged(n,!1)}));this._layer.overlayEvent=0;this._disposables=e}return r.prototype._constructOverlay=function(n,t){return{overlayTemplate:n({templateText:t,staticResources:this}),overlayAnchor:new st(-10,-10)}},r.prototype._onPrimitiveHoverChanged=function(n,i){var r=n&&n.primitive,f,s,u,e,o;i?!w.isMapsVertical||r.entity instanceof ft?(this._overlayPrimitive&&it.hideOverlay(this._map,this._overlayPrimitive),t.trafficCameraV2Enabled?(f=r,p.getInstance().show(f,!0),this._logTrafficInstrumentation(f.incident,2)):(s=r.entity instanceof ft?this._cameraMiniOverlay:this._primitiveMiniOverlay,it.showOverlay(this._map,s,r)),this._overlayPrimitive=r):(u=r.entity,e=new b(u.point.coordinates[0],u.point.coordinates[1]),this._infoboxOptions.offset=new gt(10,10),this._infoboxOptions.location=e,this._infoboxOptions.htmlContent=this._getInfoBoxHtmlContent(u),t.trafficIncidentV2Enabled?(o=r,p.getInstance().show(o,!0),this._logTrafficInstrumentation(o.incident,1)):this._infobox?this._infobox.setOptions(this._infoboxOptions):(this._infobox=new ci(e,this._infoboxOptions),this._infobox.setMap(this._map))):(this._infobox&&this._infobox.getVisible()&&(this._infobox.preventAutoClose||this._infobox.setOptions({visible:!1,closeDelayTime:800})),this._overlayPrimitive&&(t.trafficCameraV2Enabled?p.getInstance().hide(!0):(it.hideOverlay(this._map,r),this._overlayPrimitive=null)))},r.prototype._logTrafficInstrumentation=function(n,t,i){var u=t===2||t===3?i?e.CAMCLK:e.CAMHVR:i?e.INCCLK:e.INCHVR,r={};r.IUT=t;r.Z=f.getMercatorZoomLevel(this._map);t===1&&(r.ST=n.severity,r.IT=n.type,r.IC=n.roadClosed,r.IID=n.incidentId);y.logInstrumentationEvent(u,r)},r.prototype._onPrimitiveTapped=function(n){var s,r,h,o,c,u;t.incidentsClickable&&(s=n.primitive,r=s,this._overlayPrimitive&&(it.hideOverlay(this._map,this._overlayPrimitive),this._overlayPrimitive=null),o=r.incident,o.type===12?(h=2,c=this._cameraOverlay):(h=1,c=this._primitiveOverlay),t.enableTrafficCard?(this._overlayPrimitive&&i.PrimitiveOverlayHelper.hideOverlay(this._map,this._overlayPrimitive),this._overlayPrimitive=null,r.select(!0),this._logTrafficInstrumentation(r.incident,p.isCamera(r)?2:1,!0),t.trafficCameraV2Enabled&&this._trafficLayer&&this._trafficLayer.updateRecentCameras&&r.incident&&r.incident.type===12&&this._trafficLayer.updateRecentCameras.invoke(r.incident)):(it.showOverlay(this._map,c,s),this._overlayPrimitive=s),u={},u.IUT=h,u.Z=f.getMercatorZoomLevel(this._map),u.ST=o.severity,u.IT=o.type,u.IC=o.roadClosed,u.IID=o.incidentId,y.logInstrumentationEvent(e.ID,u))},r.prototype.onCloseClick=function(n){n.preventDefault();i.PrimitiveOverlayHelper.hideOverlay(this._map,this._overlayPrimitive);this._overlayPrimitive=null},r.prototype.show=function(){this._map.getLayers().insert(this._layer)},r.prototype.hide=function(){this._overlayPrimitive&&i.PrimitiveOverlayHelper.hideOverlay(this._map,this._overlayPrimitive);this._overlayPrimitive=null;r.selectedPin&&r.selectedPin.updatePinIcon(!1);r.selectedPin=null;this._infobox&&(this._infobox.setOptions({visible:!1}),this._infobox.preventAutoClose=!1);this._map.getLayers().remove(this._layer)},r.prototype.toggleCameras=function(){this._hideCameras=!this._hideCameras;this._incidentExpirationTimes={};this._map.getLayers().remove(this._layer);this._map.getLayers().insert(this._layer);y.logInstrumentationEvent(e.TC,{CTO:!this._hideCameras})},r.prototype.getCamerasHidden=function(){return this._hideCameras},r.prototype.getPrimitives=function(n,i){var r=f.getMercatorZoomLevel(this._map);r>=t.minZoomLevelToShowIncidents?this._updateTraffic(n,i,r):i({primitives:[]})},r.prototype.getDataUniquenessKey=function(n){var i=vt.fromRegionId(n),t=this._getBoundingBoxKey(i),r=this._incidentExpirationTimes[t];return t+"_"+r},r.prototype._updateTraffic=function(n,i,r){var u=this,o=this._getSeverityFilters(),e=vt.fromRegionId(n),f=this._getBoundingBoxKey(e);this._isIncidentFileExpired(f)?l.instance.authenticateClientAndRetrieveSessionId(function(){var s=t.incidentsUrlFormat.replace("{bounds}",f).replace("{sev}",o).replace("{credentials}",l.instance.getSessionId()),n;t.enableCameras&&r>t.minZoomForAllCameras&&!u._hideCameras&&(s+="&includeItems=cameras|incidents");u._perfLog&&(n=null,n=u._perfLog.start("T_IR"));wt.downloadJsonp(s,"trfinc",function(n,t){return u._processIncidents(n,t,r,e)},function(n){return u._processErrors(n)},null,!1,{key:f,callback:i,state:n},3)}):this._addIncidentPins(f,i,r,e)},r.prototype._processIncidents=function(n,t,i,r){var s=t.state,f,e,o,u,h;for(s&&s.end(),f=t.key,this._incidentExpirationTimes[f]=Date.now()+this._refreshInterval,e=n.resourceSets&&n.resourceSets.length>0&&n.resourceSets[0].resources,o=[],u=0,h=e.length;u<h;u++)o[u]=new k(e[u]);this._incidentPins[f]=o;this._addIncidentPins(f,t.callback,i,r)},r.prototype._processErrors=function(n){var t=n.state;t&&t.end()},r.prototype._addIncidentPins=function(n,i,r,f){var s=this._incidentPins[n],h=[],l,c,o,e;if(s){for(l=s.length,o=0;o<l;o++)e=s[o],c=u.findExistingRecentCamera(e.incident),c>=0&&(e=u.recentCameraVMs[c].pin),this._shouldShowIncident(e.incident,r)&&(e.layer=this._layer,h.push(e));if(r<=t.minZoomForAllCameras&&!this._hideCameras)for(o=0;o<u.recentCameraVMs.length;o++)e=u.recentCameraVMs[o].pin,e&&f.contains(e.getLocation())&&(e.layer=this._layer,h.push(e));i({primitives:h})}},r.prototype._shouldShowIncident=function(n,i){var r=!0;switch(n.type){case 12:r=!0;break;case 2:r=!1;break;case 4:r=n.severity!=1;break;case 11:r=n.severity>2}return r&&(i<=9&&n.severity!==4?r=!1:i<=10&&(n.severity===1||n.severity===2)?r=!1:i<=t.minZoomForAllCameras&&n.severity===0?r=!1:i<=12&&n.severity===1&&(r=!1)),r},r.prototype._getSeverityFilters=function(){var n="",t=f.getMercatorZoomLevel(this._map);return t<=9?n="4":t<=10?n="3,4":t<=12&&(n="0,2,3,4"),n},r.prototype._isIncidentFileExpired=function(n){var t=this._incidentExpirationTimes[n];return!t||Date.now()>t},r.prototype._getBoundingBoxKey=function(n){return[n.getSouth(),n.getWest(),n.getNorth(),n.getEast()].join(",")},r.prototype._getInfoBoxHtmlContent=function(n){return'<div class="trafficInfobox" data-tag="trafficInfobox"><div class="bm_ib_title" data-tag="trafficInfoBoxTitle"><span>'+n.trafficDescription+'<\/span><\/div><div class="bm_ib_metadata_noImg" data-tag="trafficInfoboxData"><span>'+this.resources.L_TrafficPopupStartTime_Text+"<\/span> <span>"+n.start+'<\/span><\/div><div class="bm_ib_metadata_noImg" data-tag="trafficInfoboxData"><span>'+this.resources.L_TrafficPopupEstEndTime_Text+"<\/span><span>"+n.end+"<\/span><\/div><\/div>"},r.prototype.dispose=function(){this.hide();c._clearDisposables(this._disposables)},r._mouseoverTimeout=800,r}(),e;(function(n){n[n.A=1]="A";n[n.D=2]="D";n[n.ID=3]="ID";n[n.IH=4]="IH";n[n.ML=5]="ML";n[n.TC=6]="TC";n[n.TCF=7]="TCF";n[n.CAMCLK=8]="CAMCLK";n[n.CAMHVR=9]="CAMHVR";n[n.INCCLK=10]="INCCLK";n[n.INCHVR=11]="INCHVR"})(e||(e={}));var y=function(){function n(){}return n.logInstrumentationEvent=function(t,i){var r={logData:{feature:n.featureName,action:e[t],data:i}};g.invokeHandler(d.instrumentationDataHandlerKey,r)},n.callMapSnRInstrumentation=function(){g.invokeHandler(d.callServerInstrumentationDataHandlerKey,{logData:{feature:"trfc",data:"traffic"}})},n.featureName="T",n}(),ur=function(n){function i(i,r,u){var f=this,e={},o;return f=n.call(this,e)||this,e.defineProperty("isShowing",null,null,{defaultValue:!1}),f._map=i,f._controlTemplateFactory=r,f._perfLog=u,f.updateRecentCameras=new et,o=f._map.getMapOptions(),o.trafficOptions.legendVisible&&f._addTrafficLegend(),f._trafficLayerOpacity=f._map.getConfig().liteMode?t.defaultTrafficLayerOpacityLiteMode:t.defaultTrafficLayerOpacity,f._disposables=[],f._disposables.push(i.mapTypeChanged.add(function(n){n.newMapTypeId===pt.birdseye?(f._wasTrafficShowing=f.getIsShowing(),f._wasTrafficShowing&&f.toggle()):n.oldMapTypeId===pt.birdseye&&f._wasTrafficShowing&&f.toggle()})),f}return a(i,n),i.prototype.getTrafficLayer=function(){return this.getIsShowing()?this._trafficMapLayer:null},i.prototype.show=function(n){var r,u,i;this.getIsShowing()||(this.setIsShowing(!0),this._perfLog&&(r=this._perfLog.start("T_LD"),u=this._map.getFrameManager(),r&&u&&u.frameRendered.addOne(function(){r.end()})),t.enableTrafficCard&&!s.isCardShowing&&w.isMapsVertical&&(i={},i.type=ut.trafficTask,i.id=s.trafficTaskId,g.invokeHandler(d.taskDataHandlerKey,i),s.isCardShowing=!0),this.showTrafficMapLayer(),this.showIncidentsLayer(),y.logInstrumentationEvent(e.A,{EP:n,C:t.enableTrafficCard}),(n===1||n===3)&&y.callMapSnRInstrumentation(),this.showTrafficLegend())},i.prototype.hide=function(n){this.getIsShowing()&&(this.setIsShowing(!1),this._trafficMapLayer&&(this.hideTrafficMapLayer(),w.isMapsVertical&&t.fireTapEventWhileHidingTraffic&&this._map.mapTapped.invoke(),this.hideIncidentsLayer()),v.commitChanges(),t.enableTrafficCard&&!n&&s.isCardShowing&&w.isMapsVertical&&s.close(),this.hideTrafficLegend(),y.logInstrumentationEvent(e.D,{}))},i.prototype.toggle=function(n){this.getIsShowing()?this.hide():this.show(n)},i.prototype.toggleCameras=function(){this._trafficIncidentLayer&&this._trafficIncidentLayer.toggleCameras()},i.prototype.getCamerasHidden=function(){return this._trafficIncidentLayer&&this._trafficIncidentLayer.getCamerasHidden()},i.prototype.showTrafficLegend=function(){this._trafficLegendControl&&this._map.getMapOptions().trafficOptions.legendVisible&&this._trafficLegendControl.setVisible(!0)},i.prototype.hideTrafficLegend=function(){this._trafficLegendControl&&this._trafficLegendControl.setVisible(!1)},i.prototype.hideIncidentsLayer=function(){this._trafficIncidentLayer&&this._trafficIncidentLayer.hide()},i.prototype.showIncidentsLayer=function(){this._map.getMapOptions().trafficOptions.incidentsVisible&&(this._trafficIncidentLayer||this.createTrafficIncidentsLayer(),this._trafficIncidentLayer&&this._trafficIncidentLayer.show())},i.prototype.hideTrafficMapLayer=function(){this._trafficMapLayer&&this._map.getLayers().indexOf(this._trafficMapLayer)>=0&&this._map.getLayers().remove(this._trafficMapLayer)},i.prototype.showTrafficMapLayer=function(){this._map.getMapOptions().trafficOptions.flowVisible&&(this._trafficMapLayer||this.createTrafficMapLayer(),this._trafficMapLayer&&this._map.getLayers().indexOf(this._trafficMapLayer)<0&&this._map.getLayers().insert(this._trafficMapLayer))},i.prototype.setOpacity=function(n){this._trafficLayerOpacity!=n&&(this._trafficLayerOpacity=n,this._trafficMapLayer&&this._trafficMapLayer.setOpacity(n))},i.prototype.dispose=function(){if(this.hideTrafficMapLayer(),n.prototype.dispose.call(this),c._clearDisposables(this._disposables),this._trafficIncidentLayer&&this._trafficIncidentLayer.dispose(),this._trafficIncidentLayer=null,this._trafficMapLayer&&this._trafficMapLayer.dispose(),this._trafficMapLayer=null,this._trafficLegendControl&&this._trafficLegendControl.dispose(),this._trafficLegendControl=null,this._map&&this._trafficLegendOverlay){var t=this._map.getOverlays();t&&t.remove(this._trafficLegendOverlay)}this._trafficLegendOverlay=null;this._perfLog=null},i.prototype._addTrafficLegend=function(){var n=this;this._trafficLegendControl=new ni;this.getIsShowing()||this.hideTrafficLegend();this._trafficLegendOverlay=new ti(this._trafficLegendControl);this._map.getOverlayManager().then(function(){n._map.getOverlays().insert(n._trafficLegendOverlay)})},i.prototype.createTrafficMapLayer=function(){var n=this;this._trafficMapLayer=new oi("Microsoft.Maps.Traffic",t.trafficLayerZIndex,this._trafficLayerOpacity,!1,!0,2,t.trafficTileCacheDuration,this._map.getMapOptions().enableCORS,!0,"TrafficLayer");l.instance.authenticateClientAndRetrieveSessionId(function(){var i=t.trafficUriFormat.replace("{credentials}",l.instance.getSessionId());n._trafficMapLayer.addScene(10,pi.createMercatorImageryScene("TrafficLayerV2",i,"",null,n._map),0)})},i.prototype.createTrafficIncidentsLayer=function(){this._trafficIncidentLayer=new o(this._map,this._controlTemplateFactory,this._perfLog,this)},i}(bt),ni=function(t){function i(){var i=t.call(this)||this;return i.setTemplate(new lt(tr,{resources:n})),i}return a(i,t),i}(fi),ti=function(n){function t(t){var i=this;return t&&(i=n.call(this,t.getRootElement(),null,null)||this),i}return a(t,n),t}(ai),v=function(){function n(){}return n.saveIncident=function(t){var r,i,u;if(n.getIncidents(),n.recentlyUsed){for(r=-1,i=0;i<n.recentlyUsed.length;i++)if(u=n.recentlyUsed[i],u.description===t.description){r=i;break}r!==-1?n.recentlyUsed.splice(r,1):n.recentlyUsed.length===n.Max_limit&&n.recentlyUsed.splice(0,1);n.recentlyUsed.push(t)}n.commitChanges()},n.commitChanges=function(){var r,i,t,u;if(n.recentlyUsed){for(r="",i=0;i<n.recentlyUsed.length;i++)t=n.recentlyUsed[i],t.usedCount||(t.usedCount=0),u=n.SerializedCameraFormat.replace("{lat}",t.point.coordinates[0].toString()).replace("{long}",t.point.coordinates[1].toString()).replace("{description}",t.description).replace("{usage}",t.usedCount.toString()),i!==n.recentlyUsed.length-1&&(u+="$"),r+=u;at.setItem(n.TrafficLocalStorageKey,r)}},n.getIncidents=function(){var u,f,r,i,t;if(!n.recentlyUsed&&(u=at.getItem(n.TrafficLocalStorageKey),n.recentlyUsed=[],u))for(f=u.split("$"),r=0;r<f.length;r++)i=f[r].split("|"),t={},t.point={coordinates:[parseFloat(i[0]),parseFloat(i[1])]},t.description=i[2],t.usedCount=parseInt(i[3]),t.recentlyUsed=!0,n.recentlyUsed.push(t);return n.recentlyUsed},n.removeIncident=function(t){var i,r;if(n.recentlyUsed){for(i=0;i<n.recentlyUsed.length;i++)if(r=n.recentlyUsed[i],r.description===t.description){n.recentlyUsed.splice(i,1);break}n.commitChanges()}},n.removeAllIncidents=function(){n.recentlyUsed&&(n.recentlyUsed.splice(0,n.recentlyUsed.length),n.commitChanges())},n.TrafficLocalStorageKey="TrafficCameras",n.Max_limit=10,n.SerializedCameraFormat="{lat}|{long}|{description}|{usage}",n}(),fr=function(t){function i(n){var r=t.call(this,i._getIncidentTypeTitle(n.type),null)||this;return r.id=n.incidentId,r.point=n.point,r.trafficDescription=n.description,r.end=r._getFormattedDateTime(n.end),r.roadClosed=n.roadClosed,r.severity=r._getSeverityTitle(n.severity),r.start=r._getFormattedDateTime(n.start),r.toPoint=n.toPoint,r.incidentType=n.type,r.verified=n.verified,r}return a(i,t),i._getIncidentTypeTitle=function(t){switch(t){case 9:return n.L_TrafficScheduledConstruction_Text;case 6:return n.L_TrafficOtherNews_Text;case 2:return n.L_TrafficCongestion_Text;case 1:return n.L_TrafficAccident_Text;case 3:return n.L_TrafficDisabledVehicle_Text;case 8:return n.L_TrafficRoadHazard_Text;case 10:return n.L_TrafficUnScheduledContruction_Text;case 7:return n.L_TrafficPlannedEvent_Text;case 4:return n.L_TrafficMassTransit_Text;case 11:return n.L_TrafficWeather_Text;case 5:return n.L_TrafficMiscellaneous_Text;default:return""}},i.prototype._getSeverityTitle=function(t){switch(t){case 1:return n.L_TrafficSeverityLowImpact_Text;case 2:return n.L_TrafficSeverityMinor_Text;case 3:return n.L_TrafficSeverityModerate_Text;case 4:return n.L_TrafficSeveritySerious_Text;default:return""}},i.prototype._getFormattedDateTime=function(t){var u="",f,i,r;return t&&(f=/\(([\d]+)\)/,i=f.exec(t),i&&i.length>1&&(r=new Date(parseInt(i[1],10)),u=c._formatString(n.L_TrafficDateTimeFormat,c._formatShortDateString(r),c._formatTimeString(r)))),u},i}(dt),k=function(){function i(t,i,r){this.geometryType=1;this._poiRefresh=c._isCoreConfigSettingEnabled("poiRefresh");this.crs=hi.instance;this.geometry={x:0,y:0,bounds:null};this.geometryType=1;this.layer=i;this._location=new b(t.point.coordinates[0],t.point.coordinates[1]);this._updatePointGeometry(this._location);this.incident=t;this._isDirectionsTrafficPin=r;this.resources=n;this.incident.type===12?(this.entity=new ft(t),this.entity.collisionBehavior=r?0:2):this.entity=new fr(t);this.entity.poiType=9;this.bucket=this.incident.type===12?"1441":this.incident.severity===4?"1443":this.incident.severity===3?"1442":"344";this.updatePinIcon(!1)}return i.prototype.updatePinIcon=function(n){var i,t,r;this._isDirectionsTrafficPin&&(this.entity.collisionBehavior=n?2:0);this._poiRefresh?this.viewState=n?2:0:(i=n?"trafficPoiSelected":this.incident.type===12?"camera":this.incident.severity===4?"trafficIncidentSevere":this.incident.severity===3?"trafficIncidentModerate":"trafficIncidentMinor",t=si.getImageFromCss(i),r=new st(Math.ceil(t.width/2),Math.ceil(t.height/2),1),this._template=new ri(t,1,r));this.zIndex=n?1:0;this.entity.changed.invoke()},i.prototype.isTapEnabled=function(){return!0},i.prototype.isHoverEnabled=function(){return!0},i.prototype.getLocation=function(){return this._location},i.prototype.getTemplate=function(){return this._template},i.prototype.select=function(){var n,i;t.trafficCameraV2Enabled&&this.incident&&this.incident.type===12?p.getInstance().show(this):t.trafficIncidentV2Enabled&&this.incident&&this.incident.type!==12?p.getInstance().show(this):(n={},n.activateOptions={parentId:s.trafficTaskId},n.type=ut.trafficFlipTask,i={},i.incident=this.incident,n.state=i,g.invokeHandler(d.taskDataHandlerKey,n),o.selectedPin&&o.selectedPin.updatePinIcon(!1),o.selectedPin=this,o.selectedPin.updatePinIcon(!0))},i.prototype._updatePointGeometry=function(n){var t=n.latitude,i=n.longitude;this.geometry.x=i;this.geometry.y=t;this.geometry.bounds=[t,i,t,i]},i}(),u=function(i){function r(u,e,o){var s=this,h={};return s=i.call(this,h,u,nr)||this,s._map=e,s.resources=n,s._controlTemplateFactory=u,s.modules=new kt,s._maxRecentlyUsedCamerasPreviews=4,h.defineProperty("showCameraNotification",null,null,{defaultValue:!1}),h.defineProperty("hideCamera",function(){o&&o.invoke()},null,{defaultValue:!1}),h.defineProperty("cameraNotification",null,null,{defaultValue:n.L_TrafficsZoomInNotification}),h.defineProperty("ariaChecked",null,null,{defaultValue:!0}),s.setShowCameraNotification(f.getMercatorZoomLevel(e)<=t.minZoomForAllCameras),t.enableCameras&&(r.recentCamerasModule=new ot(s._map,s._maxRecentlyUsedCamerasPreviews,n.L_TrafficRecentCamerasTitle),s.modules.insert(r.recentCamerasModule)),s}return a(r,i),r.prototype.initializeRecentCameras=function(){var n,i,u,f;if(t.enableCameras){if(r.recentCameraVMs=[],n=v.getIncidents(),n&&n.length)for(i=n.length-1;i>=0;i--)u=n[i],u.type=12,f=new tt(this._controlTemplateFactory,u,this._map),f.pin=new k(u),r.recentCameraVMs.push(f);this.updateCameraImages()}},r.prototype.updateRecentCameras=function(){for(var t,n=0;n<s.mostRecentCameras.length;n++)t=r.findExistingRecentCamera(s.mostRecentCameras[n].incidentData),t>=0&&r.recentCameraVMs.splice(t,1),r.recentCameraVMs.unshift(s.mostRecentCameras[n]);r.recentCameraVMs=r.recentCameraVMs.slice(0,v.Max_limit);this.updateCameraImages();s.mostRecentCameras=[]},r.prototype.addCameraToRecentCameras=function(n){var i=r.findExistingRecentCamera(n),t;i>=0&&r.recentCameraVMs.splice(i,1);n.type=12;t=new tt(this._controlTemplateFactory,n,this._map);t.pin=new k(n);r.recentCameraVMs.unshift(t);r.recentCameraVMs=r.recentCameraVMs.slice(0,v.Max_limit);this.updateCameraImages()},r.prototype.updateCameraImages=function(){var u,n,i;if(t.enableCameras){for(r.recentCamerasModule.collection.clear(),u=[],n=0;n<r.recentCameraVMs.length;n++)i=r.recentCameraVMs[n],i.incidentWithinMap()?r.recentCamerasModule.collection.insert(i):u.push(i);r.recentCamerasModule.collection.insertAll(u)}},r.findExistingRecentCamera=function(n){for(var i,t=0;t<r.recentCameraVMs.length;t++)if(i=r.recentCameraVMs[t].pin&&r.recentCameraVMs[t].pin.incident,i&&n.description&&i.description===n.description)return t;return-1},r.prototype.typeToClass=function(n){return n===12?"moduleItem":"moduleItem notificationItem"},r.prototype.incidentTypeToIconClass=function(n){switch(n){case 9:return"notification construction";case 1:return"notification accident";default:return"notification otherincident"}},r.prototype.cameraTypeToDisplay=function(n){return n===12?"":"none"},r.prototype.errorToImagePaneClass=function(n){return n?"imgErrorPlaceHolder":"imgPreviewPlaceHolder"},r.prototype.incidentTypeToDisplay=function(n){return n!==12?"":"none"},r.prototype.onCamerasKeyUp=function(n){var t=n,i=t.keyCode||t.which;i===13&&this._toggleCameras()},r.prototype.onCamerasClick=function(n){n.stopPropagation();this._toggleCameras()},r.prototype._toggleCameras=function(){this.setHideCamera(!this.getHideCamera());this.updateCameraMessage();var n=rt("#cameraToggleInput")[0];n.checked=!this.getHideCamera();this.setAriaChecked(!this.getHideCamera())},r.prototype.isCameraAvailable=function(){for(var n,r=this._map.getFrameManager(),u=r.getFrameData(),i=u.getPrimitives(2,!0),t=0;t<i.length;t++)if(n=i[t],n instanceof k&&n.incident.type===12&&this._map.isLocationInView(n.getLocation()))return!0;return!1},r.prototype.updateCameraMessage=function(i){i===void 0&&(i=!1);var r=this.isCameraAvailable();this.getHideCamera()?this.setShowCameraNotification(!1):f.getMercatorZoomLevel(this._map)<=t.minZoomForAllCameras?(this.setShowCameraNotification(!0),this.setCameraNotification(n.L_TrafficsZoomInNotification)):i&&!r?(this.setShowCameraNotification(!0),this.setCameraNotification(n.L_TrafficsNoCameraNotification)):this.setShowCameraNotification(!1)},r.recentCameraVMs=[],r}(ct),s=function(i){function r(n,u,f){var e=i.call(this)||this;return e.type=ut.trafficTask,e.map=f,e.toggleCameras=new et,r.controlTemplateFactory=n,e._cameraListenerAdded=!1,t.trafficCameraV2Enabled&&p.getInstance().initialize(f,n),e.displayState={colorIndex:6,groupName:"Traffic"},u.instanceAsync("TrafficLayerV2",function(n){e._trafficLayer=n;e._taskState&&e._trafficLayer.show(3);e._trafficLayer.getCamerasHidden()&&e._trafficLayer.toggleCameras();t.trafficCameraV2Enabled&&e._addRecentCameraListener()}),e.disposables.push(f.viewChanged.add(function(){var n=e.map.getFrameManager();n.frameRendered.addOne(function(){Microsoft.Maps.setTimeout(function(){e._viewModel&&e._viewModel.updateCameraMessage(!0)},0)})})),e.disposables.push(e.toggleCameras.add(function(){e._trafficLayer&&e._trafficLayer.toggleCameras()})),e}return a(r,i),r.prototype.activate=function(e,s){var h,c;r.isCardShowing=!0;this.setTitle(n.L_TrafficTaskTitle_Text);this._taskState=s||{taskTitle:this.getTitle()};i.prototype.activate.call(this,e,s);r.trafficTaskId=this.id;this._viewModel=new u(r.controlTemplateFactory,e,this.toggleCameras);this.addControl(this._viewModel.getControl());this.map=e;t.enableCameras&&this._viewModel.initializeRecentCameras();this._taskState&&this._trafficLayer&&this._trafficLayer.show(3);this._taskState.description&&this._taskState.location&&(h={},h.point={coordinates:[this._taskState.location.latitude,this._taskState.location.longitude]},h.description=this._taskState.description,h.type=12,c=new k(h),o.selectedPin=c,f.setMapCenter(e,this._taskState.location),c.select());t.trafficCameraV2Enabled&&this._addRecentCameraListener();this.setPercentLoaded(1)},r.prototype.deactivate=function(){i.prototype.deactivate.call(this);this._trafficLayer.hide()},r.close=function(){r.isCardShowing=!1;var n={action:"remove",id:r.trafficTaskId};g.invokeHandler(d.taskDataHandlerKey,n)},r.prototype.processCallback=function(){},r.prototype.serialize=function(){return this._taskState},r.prototype.setDisplayState=function(n){i.prototype.setDisplayState.call(this,n);r.trafficTaskId=this.id;n.activationState&&n.prominence&&(this._trafficLayer&&this._trafficLayer.show(3),r.mostRecentCameras&&r.mostRecentCameras.length&&t.enableCameras&&this._viewModel&&this._viewModel.updateRecentCameras());n.prominence===3&&this._trafficLayer.hide(!0)},r.prototype.getMenuList=function(){return[]},r.prototype.getCardIconInfo=function(){return{iconClass:"trfkTsk"}},r.prototype.isSharable=function(){return!0},r.prototype.hasDefaultFocusElement=function(){return!1},r.prototype._addRecentCameraListener=function(){var n=this;!this._cameraListenerAdded&&this._trafficLayer&&this._viewModel&&t.trafficCameraV2Enabled&&(this._trafficLayer.updateRecentCameras.add(function(t){n._viewModel.addCameraToRecentCameras(t)}),this._cameraListenerAdded=!0)},r.mostRecentCameras=[],r}(ht),tt=function(i){function r(r,u,f){var e=this,o={},s=u.recentlyUsed||u.type===12?bi:gi;return e=i.call(this,o,r,s)||this,e._map=f,e.resources=n,o.defineProperty("cameraImageUrl"),o.defineProperty("isImageError"),e.setIncident(u),o.defineProperty("show",null,null,{defaultValue:!1}),o.defineProperty("showRemoveRecentCamera",null,null,{defaultValue:t.showRemoveRecentlyViewedCameras}),u.type!==12||u.images||e.getCamera(),e}return a(r,i),r.prototype.setIncident=function(i){var r=this;this.incidentType=i.type;this.incidentData=i;this.pin&&(this.pin.incident=i);i.recentlyUsed||i.type===12?(this.id=i.incidentId,this.point=i.point,this.incidentTitle=i.description,this.copyright=i.copyright,this.trafficDescription=i.description,this.cameraDirection=i.view,i.images&&i.images.length&&l.instance.authenticateClientAndRetrieveSessionId(function(){var n=t.cameraUrlFormat.replace("{imageUrl}",i.images[0].imageUrl).replace("{credentials}",l.instance.getSessionId()).replace("{culture}",w.dynamicProperties.uiLanguage);n=r.updateUrlInstrumentation(n);r.setCameraImageUrl(n);r.setIsImageError(!1)}),t.showCameraDisclaimer&&(this.disclaimer=n.L_TrafficCameraDisclaimer_Text)):(this.id=i.incidentId,this.point=i.point,this.copyright=i.copyright,this.trafficDescription=i.description,this.end=this._getFormattedDateTime(i.end),this.roadClosed=i.roadClosed,this.severityType=i.severity,this.severity=this._getSeverityTitle(i.severity),this.start=this._getFormattedDateTime(i.start),this.toPoint=i.toPoint,this.verified=i.verified,this.incidentTitle=this._getIncidentTypeTitle(i.type))},r.prototype.severityTypeToClass=function(n){return r.ConvertSeverityTypeToClass(n)},r.ConvertSeverityTypeToClass=function(n){switch(n){case 4:return"incidentSeverity high";case 3:return"incidentSeverity moderate";default:return"incidentSeverity mild"}},r.prototype.onImageError=function(){this.setIsImageError(!0);var n={};n.IID=this.incidentData.incidentId;y.logInstrumentationEvent(e.TCF,n)},r.prototype.onBackClick=function(n){n.preventDefault();nt.close()},r.prototype.onModuleItemClick=function(n){var i,r,s;n.preventDefault();this.pin.select();i={};r=5;var u=this.incidentData.point.coordinates,h=f.getMapBounds(this._map),o=new b(u[0],u[1]);h.contains(o)||(s=Math.max(t.minZoomLevelToShowIncidents,f.getMercatorZoomLevel(this._map)),f.setMapCenter(this._map,o,s));t.trafficCameraV2Enabled||Microsoft.Maps.setTimeout(function(){var t=rt(".trfkTsk.titleIcon"),n;t.length>1&&(n=rt(t[1]).get_ancestor(1,0)[0],n.focus(),n.style.border="none")},500);i.IUT=r;i.Z=f.getMercatorZoomLevel(this._map);y.logInstrumentationEvent(e.ID,i)},r.prototype.onRemoveRecentCameraClick=function(n){if(n.preventDefault(),ot.removeCamera(this),this._map&&o&&f.getMercatorZoomLevel(this._map)<=t.minZoomForAllCameras){var i=this._map.getFrameManager();i&&i.hackHackSetFrame()}nt&&u.recentCameraVMs&&u.recentCameraVMs.length===0&&nt.close()},r.prototype.incidentWithinMap=function(){var n=this.incidentData.point.coordinates,t=f.getMapBounds(this._map);return t.contains(new b(n[0],n[1]))},r.prototype._getCameraDirection=function(t){switch(t){case"N":return n.L_TrafficCameraDirectionNorth_Text;case"S":return n.L_TrafficCameraDirectionSouth_Text;case"E":return n.L_TrafficCameraDirectionEast_Text;case"W":return n.L_TrafficCameraDirectionWest_Text;default:return null}},r.prototype._getIncidentTypeTitle=function(t){if(t)switch(t){case 9:return n.L_TrafficScheduledConstruction_Text;case 6:return n.L_TrafficOtherNews_Text;case 2:return n.L_TrafficCongestion_Text;case 1:return n.L_TrafficAccident_Text;case 3:return n.L_TrafficDisabledVehicle_Text;case 8:return n.L_TrafficRoadHazard_Text;case 10:return n.L_TrafficUnScheduledContruction_Text;case 7:return n.L_TrafficPlannedEvent_Text;case 4:return n.L_TrafficMassTransit_Text;case 11:return n.L_TrafficWeather_Text;case 5:return n.L_TrafficMiscellaneous_Text;default:return""}return""},r.prototype._getSeverityTitle=function(t){switch(t){case 1:return n.L_TrafficSeverityLowImpact_Text;case 2:return n.L_TrafficSeverityMinor_Text;case 3:return n.L_TrafficSeverityModerate_Text;case 4:return n.L_TrafficSeveritySerious_Text;default:return""}},r.prototype._getFormattedDateTime=function(t){var u="",f,i,r;return t&&(f=/\(([\d]+)\)/,i=f.exec(t),i&&i.length>1&&(r=new Date(parseInt(i[1],10)),u=c._formatString(n.L_TrafficDateTimeFormat,c._formatShortDateString(r),c._formatTimeString(r)))),u},r.prototype.getCamera=function(){var i=this,n=this.incidentData,r=yt.getMapLocationFromLocationHeadingAndDistance(new b(n.point.coordinates[0],n.point.coordinates[1]),Math.PI*3/4,5),u=yt.getMapLocationFromLocationHeadingAndDistance(new b(n.point.coordinates[0],n.point.coordinates[1]),Math.PI*7/4,5),f=r.latitude+","+u.longitude+","+u.latitude+","+r.longitude;l.instance.authenticateClientAndRetrieveSessionId(function(){var n=t.cameraByLocationUrlFormat.replace("{bounds}",f).replace("{credentials}",l.instance.getSessionId());n=i.updateUrlInstrumentation(n);wt.downloadJsonp(n,"trfcam",function(n,t){return i._processCameraDetails(n,t)},function(n){return i._processErrors(n)},null,!1,{})})},r.prototype.updateUrlInstrumentation=function(n){return n},r.prototype._processCameraDetails=function(n){var r=n.resourceSets&&n.resourceSets.length>0&&n.resourceSets[0].resources||[],u=this.incidentData,f=!1,i,t;if(r.length)for(i=0;i<r.length;i++)if(t=r[i],t.description===u.description){t.recentlyUsed=u.recentlyUsed;this.setIncident(t);this.pin&&(this.pin.incident=t);f=!0;break}f||ot.removeCamera(this)},r.prototype._processErrors=function(){},r}(ct),ot=function(i){function r(r,u,f){var e=this,o={};return e=i.call(this,o)||this,e._map=r,e.resources=n,e.collection=new kt,e.collection.changed.add(function(n){e._onCollectionChanged(n)}),o.defineProperty("showModule",null,null,{defaultValue:!1}),o.defineProperty("showMoreLink",null,null,{defaultValue:!1}),o.defineProperty("moreLinkText",null,null,{defaultValue:n.L_TrafficModuleMoreLink}),o.defineProperty("arrowClass",null,null,{defaultValue:"downArrow trafficArrow"}),o.defineProperty("showRemoveAllRecentCameras",null,null,{defaultValue:t.showRemoveRecentlyViewedCameras?!0:!1}),e.title=f,e._maxItemsPreviews=u,e}return a(r,i),r.prototype.onMoreClick=function(t){var r,u;t.preventDefault();var i=this.getMoreLinkText()===n.L_TrafficModuleMoreLink,f=this.collection.length>this._maxItemsPreviews,o=i?n.L_TrafficModuleLessLink:n.L_TrafficModuleMoreLink,s=i?"upArrow trafficArrow":"downArrow trafficArrow";if(f)for(this.setMoreLinkText(o),this.setArrowClass(s),r=this._maxItemsPreviews;r<this.collection.length;r++)this.collection[r].setShow(i);this.title===n.L_TrafficRecentCamerasTitle&&(u=1);y.logInstrumentationEvent(e.ML,{M:u,ILM:i})},r.prototype._onCollectionChanged=function(){var i,t;if(this.collection.length)for(this.getShowModule()||this.setShowModule(!0),this.setShowMoreLink(this.collection.length>this._maxItemsPreviews),i=this.getMoreLinkText()===n.L_TrafficModuleMoreLink,t=0;t<this.collection.length;t++)this.collection[t].setShow(!(t>=this._maxItemsPreviews&&i));else this.setShowModule(!1)},r.prototype.onRemoveAllRecentCamerasClick=function(n){if(n.preventDefault(),r.removeAllCameras(),f.getMercatorZoomLevel(this._map)<=t.minZoomForAllCameras){var i=this._map.getFrameManager();i&&i.hackHackSetFrame()}nt&&u.recentCameraVMs&&u.recentCameraVMs.length===0&&nt.close()},r.removeAllCameras=function(){u.recentCamerasModule.collection.clear();u.recentCameraVMs.splice(0,u.recentCameraVMs.length);v.removeAllIncidents()},r.removeCamera=function(n){var t,i;if(n&&v.removeIncident(n.incidentData),u.recentCameraVMs&&u.recentCamerasModule)for(u.recentCamerasModule.collection.remove(n),t=0;t<u.recentCameraVMs.length;t++)i=u.recentCameraVMs[t],i.id===n.id&&u.recentCameraVMs.splice(t,1)},r}(bt);h.TrafficLegendControl=ni;h.TrafficLegendOverlay=ti;h.TrafficLayerV2=ur;h.TrafficTask=s;h.TrafficFlipTask=nt;h.TrafficPinV2=k;h.CameraOverlayEntity=ft;h.IncidentViewModel=tt;h.TrafficIncidentPopup=p;h.TrafficLocalStorageHelper=v}catch(ii){if(i.logger)i.logger.logCriticalError(ii);else throw ii;}}).call(window)