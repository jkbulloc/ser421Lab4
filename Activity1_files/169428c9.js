(function(){try{(function(){var n={L_AddCollection_Title:"Create a Collection",L_AddToCollection_Title:"Add to My Places",L_Collection_Empty_Message:"To add to your Collection, tap Save from one of your search results.",L_MyPlaces_Title:"My Places",L_MyCollections_BackButton:"My Collections",L_BackToCollections_BackButton:"Back To Collections",L_SignIn_Text:"<link>Sign in<\/link> with your Microsoft account to view your Places.",L_AddCollection_Text:"New Collection",L_AddCollection_Description:"Create a new personalized collection",L_AddItinerary_Text:"New Itinerary",L_AddItinerary_Description:"Create a new personalized travel itinerary",L_EditModeDone_Text:"Done",L_EditMode_Text:"Edit",L_CancelButton_Text:"Cancel",L_CreateButton_Text:"Create",SignInAndSaveButton:"Sign in & Save",SignInTip:"<link>Sign in<\/link> to save",TempCollectionTip:"View your temporary collection, or create a new one.",EmptyTempCollectionLine1:"Your temporary collection is empty.",EmptyTempCollectionLine2:"Save places to your temporary collection from your search results on the map. Just tap ",L_CreateCollection_ToolTip:"Create a Collection",L_DeleteCollection_ToolTip:"Delete this Collection",L_DeleteItinerary_ToolTip:"Delete this Itinerary",L_DeleteEntity_ToolTip:"Delete this place",L_EnterEdit_ToolTip:"Edit My Places",L_ExitEdit_ToolTip:"Exit edit mode",L_FailedEntitySave_Text:"There was a problem adding this place to your Collection Try again.",L_NewCollectionDescription_Text:"Description",L_NewCollectionDescription_Watermark:"Example: Places to visit on my trip",L_NewCollectionName_Text:"Name",L_NewCollectionName_Watermark:"Example: My summer trip",L_NewCollectionPrivacy_Text:"Allow sharing",L_CollectionError_Adding_Text:"There was a problem creating the Collection. Try again.",L_CollectionError_Deleting_Text:"There was a problem deleting the Collection or place. Try again.",L_ItineraryError_Deleting_Text:"There was a problem deleting the Itinerary. Please try again.",L_CollectionError_Retrieving_Text:"There was a problem displaying your Collection. Please try again.",L_ItineraryError_Retrieving_Text:"There was a problem displaying your Itineraries. Please try again.",L_CollectionError_Updating_Text:"There was a problem saving your changes to the Collection. Try again.",L_CollectionError_SaveToExisting:"There was a problem saving these places to your collection. Try again.",L_CollectionNameMissing_Text:"Don't forget to name your Collection.",L_DragToolTip_Text:"Drag to reorder",L_CollectionError_ViewShared_Text:"We can't show you this Collection. Check your network connection, or check with the person who shared them to make sure sharing is allowed.",L_DescLengthError_Text:"Try a shorter description. (1000 character maximum)",L_TitleLengthError_Text:"Try a shorter name. (100 character maximum)",L_Collections_MyLocation:"My location",L_FavoriteDirections_Text:"Get Directions",L_RouteAll_Text:"All my places",L_RouteSelectMessage_Text:"Select places and tap Get Directions",L_RouteSelect_Text:"Select places",L_SeeAllButton:"See all in map view",L_CollectionDirectionButton_Text:"Directions",L_CollectionDirectionButton_ToolTip:"Select route all or select destinations",L_CollectionEditButton_ToolTip:"Click to edit the title or description of this collection",L_CollectionShareButton_Text:"Share",L_CollectionShareButton_ToolTip:"Click to share this collection",L_CollectionSaveButton_ToolTip:"Click to save to a collection",L_AddCollectionWhenNone_Text:"Add to your Collections by tapping the New Collection button.",L_DirectionsCancelToolTip_Text:"Cancel selecting a route",L_GetDirectionsToolTip_Text:"Get Directions for the selected places",L_MakePublicFail_Text:"Our system is unable to share this Collection right now. Please try again.",L_MakePublicSuccess_Text:'You changed "{0}" Collection from private to sharing mode.',L_UndoFail_Text:"Our system is unable to undo the change right now. Please try again.",L_Undo_Text:"Undo",L_ShareOnlySpecificCollection_Text:"Unable to share this My Places card. Try sharing a single Collection.",L_CollectionDescriptionEdit_Text:"You can add a description or notes here (1000 character maximum)",L_EnterEditText_ToolTip:"Edit title or description",L_FavoriteTitle_Text:"Favorites",L_HomeFavorite_Text:"Home",L_WorkFavorite_Text:"Work",L_MissingHomeFavorite_Text:"Click or tap to add your Home",L_MissingWorkFavorite_Text:"Click or tap to add your Work",L_MissingHomeFavorite_Text_V2:"Set a home address",L_MissingWorkFavorite_Text_V2:"Set a work address",L_SetAddress_WaterMark:"Type your address",L_CollectionSubTitle_Text:"Collections",L_ItinerariesSubTitle_Text:"Itineraries",L_AddCollectionMessage_Text:"Organize your favorites by creating Collection",L_AddFavoritesMessage_Text:"Your Favorites list is empty. Add a place to your Favorites by pressing Save in a search card",L_SeeLess_Text:"See Less",L_SeeMore_Text:"See More",L_SeeLess_ToolTip:"See Less {0} ",L_SeeMore_ToolTip:"See More {0}",L_FavoriteErrorMessage_Text:"We were unable to retrieve your Favorites from storage",L_HomeEditText_ToolTip:"Open edit dialog for Home",L_WorkEditText_ToolTip:"Open edit dialog for Work",L_AddHome_Text:"Add your Home",L_AddHome_Title:"Home",L_AddWork_Text:"Add your Work",L_AddWork_Title:"Work",L_AddHomeWork_Button:"Add",L_CreateFavoriteError_AlreadyExists:"We were unable to save this place, as it is already in your favorites.",L_EditHome_Text:"Edit your Home",L_EditWork_Text:"Edit your Work",L_AllowLCAStatement_Text:"Checking this box enables you to share this collection via URL.",L_AutoSuggestSearchFailed_Message:'Couldn\'t find "{0}"',L_FailedSaveFavorite_Message:"There was a problem saving this place to your Favorites. Try again.",L_BackToDetails_Text:"Local search details",L_DeleteFavorite_ToolTip:"Remove this Favorite",L_DeleteHome_ToolTip:"Remove this as your Home",L_DeleteWork_ToolTip:"Remove this as your Work",L_EditFavoriteText_ToolTip:"Edit this Favorite",L_EditHomeText_ToolTip:"Edit your Home",L_EditWorkText_ToolTip:"Edit your Work",L_PlaceTitleEditSuggestion_Text:"Give this place a name",L_PlaceAddressEditSuggestion_Text:"Give this place an address",L_PlaceDescriptionEditSuggestion_Text:"Add a note",L_FormatDescription_Text:"{0}: {1}",L_CollectionCount_Text:"{0} items",L_CollectionCountSingle_Text:"{0} item",L_AddressLabel_Text:"Address",L_NoteLabel_Text:"Notes",L_TitleLabel_Text:"Title",L_AddHomeWorkSearch_Button:"Search",L_ShowHomeWorkCheckbox:"Show this place on my map",L_MaxDirectionsItems_Text:"There is a maximum of 25 waypoints allowed.",L_SignInButton_Text:"Sign In",L_PrintNotes_Watermark:"Type your notes here.",L_SharedTemporaryCollection_Title:"Shared Places",L_TemporaryCollectionTitle:"Temporary Collection",L_TemporaryCollectionDescription:"Places saved locally in your browser",L_TemporaryCollectionSignIn:"Sign in for more saving options and to access your collections from anywhere.",L_TemporaryCollectionClearButton:"Clear",L_TemporaryCollectionClearButton_Cardified:"Clear temporary collection",L_TemporaryCollectionSaveButton:"Save",L_TemporaryCollectionRemoveButton:"Delete",L_TemporaryCollectionDeleteConfirmationMessage:"Are you sure you want to delete this place?",L_CollectionsListDeleteConfirmationMessage:"Are you sure you want to delete this collection?",L_ItineraryDeleteConfirmationMessage:"Are you sure you want to delete this itinerary?",L_TemporaryCollectionClearConfirmationMessage:"Are you sure you want to clear all of your places?",L_TemporaryCollectionSaveMessage:"Save this collection to access it from any device in the future. Save to:",L_TemporaryCollectionSaveToNew:"New Collection",L_RemoveEntity_ToolTip:"Remove this place from the temporary collection",L_ContextMenu_ToolTip:"Additional actions on this entity",L_MeasureMapTask_Title:"Measure Distance & Area",L_MeasureMapTask_InitialInstructions:"Click or tap on the map to create a new point. Tap and drag an existing point to move it. Right-click (or tap and hold) on a point to remove it.",L_MeasureMapTask_PerimeterFormat:"Distance: {primary} ({secondary})",L_MeasureMapTask_AreaFormat:"Area: {primary} ({secondary})",L_MeasureMapTask_NewLink_Text:"Reset",L_MeasureMapTask_DoneLink_Text:"Done",L_MeasureMapTask_EditLink_Text:"Edit",L_MeasureMapTask_AreaLink_Text:"Close shape",L_MeasureMapTask_NewLink_Title:"Clear any current shape and start over",L_MeasureMapTask_DoneLink_Title:"Finish editing the current shape and leave on map",L_MeasureMapTask_EditLink_Title:"Continue editing the current shape",L_MeasureMapTask_AreaLink_Title:"Convert current shape to a polygon and display its contained area",L_MeasureMapTask_DistanceUnitKm_Text:"km",L_MeasureMapTask_DistanceUnitMeter_Text:"m",L_MeasureMapTask_DistanceUnitMile_Text:"mi",L_MeasureMapTask_DistanceUnitFoot_Text:"ft",L_MeasureMapTask_AreaUnitKm_Text:"sq km",L_MeasureMapTask_AreaUnitMeter_Text:"sq m",L_MeasureMapTask_AreaUnitMile_Text:"sq mi",L_MeasureMapTask_AreaUnitFoot_Text:"sq ft",L_MeasureMapTask_ValueUnitFormat:"{value} {unit}",L_Migration_In_Progress_Message:"Server Maintenance, please try again in a few minutes",L_User_Migrated_Message:"Server Maintenance, please refresh your browser and try again",L_Max_Collections_Message:"You have reached the limit of {0} collections in your account. In order to create a new collection, you must delete one or more existing collections.",L_Max_Entities_Message:"You have reached the limit of {0} places in this collection. In order to add a new place to this collection, you must delete one or more existing places.",L_EditSaveButton:"Save",L_EditDoneButton:"Done",L_DeleteDoneButton:"Done",L_NicknameTitle:"Nickname",L_DescriptionTitle:"Description",L_CollectionPrivateMessage:"Make this collection public.",L_CollectionPublicMessage:"Make this collection private.",L_CollectionMadePrivateMessage:"This collection is now private and cannot be shared with others.",L_CollectionMadePublicMessage:"This collection can now be shared with others.",L_AddCollectionPrivateMessage:"This Collection cannot be shared. Tap lock icon to make collection shareable.",L_AddCollectionPublicMessage:"You can share this collection with others. Tap lock icon to make collection private.",L_UpcomingEventsName:"Upcoming Events",L_UpcomingEventEntity_TimeLabelFormat:"{date} @ {time}",L_SeeMoreEventsLink:"See more upcoming events",L_SeeLessEventsLink:"See less upcoming events",L_FlightToText:"Flight to {0}",L_EmptyItinerariesMessage:"Make the most of every day - save Bing itineraries you like, or customize them and make them your own.",L_EmptyItinerariesSearchLink1:'Search to get started (e.g. "',L_EmptyItinerariesSearchLink2:"Seattle itineraries",L_EmptyItinerariesSearchLink3:'").',L_CreateNewItinerary:"Create a new itinerary",SaveOnSerp_ConfirmationLink:"<link>View My Places<\/link>",SaveOnSerp_SavedButtonText:"Saved",SaveOnSerp_HoverTip:"Save to My Places",L_AddNewCollection:"Add new collection",L_AddNewItinerary:"Add new itinerary",AutoCollections_LabeledPlaces:"Labeled Places",AutoCollections_NearHome:"Places near Home",AutoCollections_NearWork:"Places near Work",AutoCollections_Nearby:"Places near {0}",HowManyMoreAttractions:"+{0} more",NumberOfAttractions:"{0} items",L_CollectionEdit:"Edit",L_CollectionRemoveButton:"Delete",L_PlaceholderEmptyDescription:"Add a description",L_PlaceholderEmptyName:"Add a name",L_MoreToolTip:"More",L_NewCollectionTitle:"Name",L_EditCollectionButton:"Edit collection",L_DeleteCollectionButton:"Delete collection",L_ConfirmTitleEdit:"confirm title edit",L_CancelTitleEdit:"cancel title edit",L_ChangePrivacyStatus:"click to change privacy status",L_ConfirmCollectionEntityEdit:"confirm collection entity edit",L_CancelCollectionEntityEdit:"cancel collection entity edit",L_FavoriteEntryOnClickText:"click to open the favorite entry",L_ConfirmFavoriteEntityEdit:"confirm favorite entity edit",L_CancelFavoriteEntityEdit:"cancel favorite entity edit",L_ConfirmItineraryDelete:"confirm itinerary delete",L_CancelItineraryDelete:"cancel itinerary delete",L_ItineraryDeleteButton:"click to delete itinerary",SortBy:"Sort by:",MostRecent:"Most Recent",AtoZ:"A-Z",ZtoA:"Z-A",Custom:"Custom"};window.$MicrosoftMaps8.ResourceManager?window.$MicrosoftMaps8.ResourceManager.init("Collections",n):window.$MicrosoftMaps8.ResourcesObject=n})(),function(){var n={Attribution:"Data from:",GettyImageAttribution:"© {0} Getty Images",TravelGuide:"{0} Travel Guide",ItinTitleSingular:"{0} Itinerary {1} Day",ItinTitlePlural:"{0} Itinerary {1} Days",DayHeader:"Day {0}",DaySingular:"{0} day",DayPlural:"{0} days",AddDay:"Add day",Discover:"Discover",AttractSingular:"{0} attraction",AttractPlural:"{0} attractions",BackToList:"return to list",ItineraryShare_ToolTip:"Click to share this itinerary",ItineraryDrag_ToolTip:"Drag to reorder",PrintNotesWaterMark:"Type your route notes here",PrintDay:"Day {0}",DeleteDay:"Delete this day",NicknameTitle:"Nickname",DescriptionTitle:"Description",CancelButton_Text:"Cancel",EditSaveButton:"Save",EditButton_ToolTip:"Edit Name",SaveButton_ToolTip:"Save",ShareButton_ToolTip:"Share",DeleteButton_ToolTip:"Remove",ContextMenuButton_ToolTip:"More",NewItineraryDescription_Watermark:"Example: Summer escape to Paris",Add_Attractions:"Find attractions",Attractions_Query:"{0} attractions",Restaurants_Query:"{0} restaurants",Hotels_Query:"{0} hotels",AddToDay_ToolTip:"{0} has been added to day {1} of your <link>itinerary<\/link>",AddToDayOfItinerary_ToolTip:"{0} has been added to day {1} of <link>{2}<\/link>",DeleteDay_ToolTip:"A day has been removed from your itinerary",AddDay_ToolTip:"Day {0} has been added to your itinerary",DeleteItem_ToolTip:"{0} has been removed from your itinerary.",MoveToDay_ToolTip:"{0} has been moved to day {1}",OperationFailed_ToolTip:"Operation Failed",ItinerarySaved_ToolTip:"All edits you make will be automatically saved to My Places.",SaveItinerary_ToolTip_Line1:"Save a copy - keep your edits",SaveItinerary_ToolTip_Line2:"Save a copy of this itinerary to view your edits later.",SavedCopyName:"{0} - copy",L_SignInRequiredItinerary:"<link>Sign in<\/link> to save a copy",EmptyRecommendationsMessage:"No recommendations are available for this destination. ",EmptyRecommendationsMessageLink1:"Search for ",AttractionsSuggestionLink:"attractions",EmptyRecommendationsMessageLink2:", ",RestaurantsSuggestionLink:"restaurants",EmptyRecommendationsMessageLink3:", ",HotelsSuggestionLink:"hotels",EmptyRecommendationsMessageLink4:" and more to find places to add to your itinerary.",EmptyDayMessage:" directly from the search results or the map to save to your itinerary.",EmptyDaySuggestionLink1:"In addition to ",EmptyDaySuggestionLink2:"attractions",EmptyDaySuggestionLink3:", you can find ",EmptyDaySuggestionLink4:"restaurants",EmptyDaySuggestionLink5:", ",EmptyDaySuggestionLink6:"hotels",EmptyDaySuggestionLink7:", and more to add to your itinerary by searching on the map.",L_DeleteDayConfirmationMessage:"Are you sure you want to permanently delete this day?",L_ConfirmDeleteDayButton:"Delete",L_CancelDeleteDayButton:"Cancel",New_Itinerary_Title:"New Itinerary",New_Itinerary_Title_One_Destination:"{0} Itinerary",New_Itinerary_Title_Multiple_Destinations:"{0} - {1} Itinerary",Destinations_Title:"Where do you want to go?",Destinations_WaterMark:"City, State, National Park, etc.",Travel_Dates_CheckBox:"I know my dates",Add_Location:"Add location",Get_Started:"Get Started",Trip_Summary:"Trip summary",Destinations_Summary:"{0} (+{1})",Separator:" · ",Add_Dates_Hint:"Know your dates?",Edit_Destinations:"Edit",Directions_Not_Available:"Directions not available"};window.$MicrosoftMaps8.ResourceManager?window.$MicrosoftMaps8.ResourceManager.init("Travel",n):window.$MicrosoftMaps8.ResourcesObject=n}();var r=window.$MicrosoftMaps8,u=r.Internal,lt=u.TaskData=u.TaskData||{},f=r.CloudGraphDataManager=r.CloudGraphDataManager||{},di=r.Anchor,gi=r.CommonControls.AutosuggestV2,nr=r.CommonControls.AutosuggestViewModel,tr=u.BaseTask,ir=u.BaseTaskViewModel,rr=r.BitmapImageTemplate,at=r.BasicTemplate,ur=lt.CollectionActions,fr=r.CommonControls.CollectionsAutosuggestDataModel,n=r.GlobalConfig.features.collections,er=r.CollectionsTaskPoiManager,or=r.Constants,sr=u.ControlTemplate,ii=r.DataHandlerKeys,e=r.Internal._Debug,hr=lt.DistanceUnit,ri=u._EntryPoints,cr=u.GeolocationProvider,b=u._Gimme,ft=r.GlobalConfig,ui=r.GlobalDataEventHandler,lr=r.ImageFromCssHelper,it=u._JSEvent,d=u._Helper,vt=u._LatLonCrs,p=u._LocalStorageCache,ar=r.LocationRect,vr=u._LoggerConstants,yr=u.MapHelper,pr=r.MapLayer,y=r.Location,ut=r.MapMath,wr=r.MapTypeId,br=r.MapView,dt=r.Module,fi=u._Network,kr=u._Observable,h=u._ObservableCollection,rt=u._ObservableObject,dr=u._ObservableObjectChangedArgs,gr=u._OverlayEntity,nu=r.GlobalConfig.features.print,tu=u.PrintContent,iu=u.PrintManager,v=r.ResourceManager.Collections,ei=u.SaveOnSerpConfirmationTip,oi=r.SignInState,si=r.SimplePointPrimitive,ru=r.TabControlRequester,hi=r.TaskTypes,uu=u.TransientLensActions,ci=lt.TravelAttractionEntity,li=r.GlobalConfig.features.travel,ai=u.UserTipControl,fu=r.VectorMapLayer,eu=lt.Waypoint,ou=r.ZoomLevel,vi='<div class="{Binding ShowSaveButton Converter=saveRootClass}" data-tag="saveRoot">    <div class="auxillaryButtons" style:display="{Binding ShowSaveButton Converter=boolToDisplay}">        <a class="saveButton" data-tag="saveButton" event:click="onSaveClick" href="#">            <span class="saveButtonIcon"><\/span>        <\/a>    <\/div>    <div class="saveDropdown popOutTop" style:display="{Binding ShowDropdown Converter=boolToDisplay}" style:top="{Binding TopPosition}" style:left="{Binding LeftPosition}">        <div class="popOutInner" data-tag="popOutInner">            <a class="saveEntry dropdownEntry" data-tag="saveEntry" event:click="onFavoritesClick" href="#" style:display="{Binding signInState.IsSignedIn Converter=boolToDisplay}">                <span class="saveButton saveIcon"><\/span>                <TextBlock Text="{Binding resources.L_FavoriteTitle_Text}" />            <\/a>            <div class="transientLensSeparator" style:display="{Binding signInState.IsSignedIn Converter=boolToDisplay}"><\/div>            <ItemsControl ItemsSource="{Binding Itineraries}">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <a class="saveEntry dropdownEntry" data-tag="saveEntry" data-entityid="{Binding collectionId}" event:click="onItineraryClick" href="#">                            <span class="saveButton saveIcon"><\/span>                            <TextBlock Text="{Binding Name}" />                        <\/a>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>            <div class="transientLensSeparator" style:display="{Binding signInState.IsSignedIn Converter=boolToDisplay}"><\/div>            <a class="saveEntry dropdownEntry" data-tag="saveEntry" event:click="onTemporaryCollectionClick" href="#">                <span class="saveButton saveIcon"><\/span>                <TextBlock Text="{Binding resources.L_TemporaryCollectionTitle}" />            <\/a>            <ItemsControl ItemsSource="{Binding Collections}">                <ItemsControl.ItemTemplate>                    <DataTemplate>                        <a class="saveEntry dropdownEntry" data-tag="saveEntry" data-entityid="{Binding id}" event:click="onCollectionClick" href="#">                            <span class="saveButton saveIcon"><\/span>                            <TextBlock Text="{Binding name}" />                        <\/a>                    <\/DataTemplate>                <\/ItemsControl.ItemTemplate>            <\/ItemsControl>        <\/div>    <\/div><\/div>',w=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ct=function(t){function i(){var n=t.call(this)||this;return n.geometryType=1,n.crs=vt.instance,n}return w(i,t),i.prototype.dispose=function(){this.entity.dispose();this.entity=null;this.geometry=null;this.crs=null},i.prototype.getGeometry=function(){return this.geometry},i.prototype.setGeometry=function(n){this.geometry=n;this.entity&&this.entity.setGeometry(n)},i.prototype.getArea=function(){return 0},i.prototype.getLength=function(){return 0},i.prototype.createPointFromSimplePoint=function(n){return this.entity=new yt,this.entity.createFavoriteFromCollectionEntity(n.entity),this.setGeometry(n.getGeometry()),this.geometry!==null},i.prototype.createPointFromPlace=function(n){return this.entity=new yt,this.entity.createFavoriteFromPlace(n),this.geometry=this.entity.getGeometry(),this.geometry!==null},i.prototype.isTapEnabled=function(){return n.simplePointTapEnabled},i}(rt),c=function(r){function u(n,t){var u=r.call(this)||this;return u.primitives=new h,u._privates.defineProperty("itemCount"),u.id=n,u.name=t,u.disposed=new it,u.eTag="0",u.dateCreated=i.convertJavascriptDateToDateInTicks(new Date),u.dateModified=u.dateCreated,u.dateAccessed=u.dateCreated,u.primitives.changed.add(function(){u.setItemCount(u.primitives.length)}),u.collageImages=new h,u}return w(u,r),u.deserialize=function(n,t){var i,o,e,r,f;if(t)return u.deserializeCgCollection(n);if(n&&n.id&&n.name&&(i=new u(n.id,n.name),i.description=n.description,i.isPublic=n.isPublic,n.primitives))for(o=n.primitives.length,e=0;e<o;e++){r=n.primitives[e];switch(r.geometryType){case 1:f=nt.deserialize(r);break;case 2:f=ht.deserialize(r);i.containsPolyshapes=!0;break;case 3:f=st.deserialize(r);i.containsPolyshapes=!0}f&&i.primitives.insert(f)}return i},u.deserializeCgCollection=function(t){var i,o,s,c,l,r,f,e;if(t&&t.CollectionId&&(t.Name||t.CollectionId===u.upcomingEventsId)){if(i=new u(t.CollectionId,t.Name||v.L_UpcomingEventsName),i.description=t.Description,i.isPublic=t.CanShare,i.eTag=t.ETag,i.dateAccessed=t.DateAccessed,i.dateCreated=t.DateCreated,i.dateModified=t.DateModified,i.setItemCount(t.ItemsCount),n.enableMyPlacesUxRedesign&&(o=t.Properties&&t.Properties.ImageUrls,o&&o.length)){for(s=b.Internals.parseJSON(o),c=new h,r=0;r<s.length;r++)c.insert(s[r]);i.collageImages=c}if(t.Items)for(l=t.Items.length,i.setItemCount(l),r=0;r<l;r++){if(f=t.Items[r],f.Geometry)switch(f.Geometry.$type){case"GeometryPoint":e=nt.deserialize(f,!0);break;case"GeometryLine":e=ht.deserialize(f,!0);i.containsPolyshapes=!0;break;case"GeometryPolygon":e=st.deserialize(f,!0);i.containsPolyshapes=!0}else e=nt.deserialize(f,!0);e&&i.primitives.insert(e)}}return i},u.serialize=function(n,i){var r,s,o,f,e;if(i)return u.serializeCgCollection(n);if(n&&(r={},r[t.id]=n.id,r[t.nameField]=n.name,r[t.description]=n.description,r[t.isPublic]=n.isPublic,r[t.primitives]=[],n.primitives))for(s=n.primitives.length,o=0;o<s;o++){f=n.primitives[o];switch(f[t.geometryType]){case 1:e=nt.serialize(f);break;case 2:e=ht.serialize(f);break;case 3:e=st.serialize(f)}e&&r[t.primitives].push(e)}return r},u.serializeCgCollection=function(r){var u,s,h,o,f,e;if(r){if(s=i.convertJavascriptDateToDateInTicks(new Date),u={$type:"GeoAnnotationsCollection",Name:r.name,Description:r.description,CanShare:r.isPublic,Items:[],AlwaysShowPOI:!0,CopyAllowed:!0,DisplayOrder:1,DateCreated:r.dateCreated,DateModified:s,DateAccessed:s},n.enableMyPlacesUxRedesign&&(u.Properties={ImageUrls:b.Internals.stringify(r.collageImages.slice())}),r.id&&(u.CollectionId=r.id),r.primitives)for(h=r.primitives.length,o=0;o<h;o++){f=r.primitives[o];switch(f[t.geometryType]){case 1:e=nt.serialize(f,!0);break;case 2:e=ht.serialize(f,!0);break;case 3:e=st.serialize(f,!0)}e&&u.Items.push(e)}u.ItemsCount=u.Items.length}return u},u.prototype.copy=function(){var n=new u(this.id,this.name);return n.description=this.description,n.isPublic=this.isPublic,n.primitives=new h,n},u.localCollectionId="0",u.upcomingEventsId="default.user.upcomingevents",u}(rt),bt=function(){function n(){this.collections=new h;this.autocollections=new h}return n.prototype.sortCollections=function(){var n,t,r,u,i;if(this.collections.length!==0)for(n=this.collections,t=1;t<n.length;t++)if(r=n[t],u=r.dateModified,!(u<n[t-1].dateModified)){for(n.removeAt(t),i=t-2,i;i>=0;i--)if(u<n[i].dateModified)break;n.insert(r,i+1)}},n.deserialize=function(t,i){var u,e,r,f;if(t)for(u=new n,e=t.length,r=0;r<e;r++)f=c.deserialize(t[r],i),f&&u.collections.insert(f);return u},n.serialize=function(n,t){var r=[],u,i;if(n&&n.collections)for(u=n.collections.length,i=0;i<u;i++)r[i]=c.serialize(n.collections[i],t);return r},n.getAllCollectionNamesAndIds=function(n){var i=[],r,t,u;if(n&&n.collections)for(r=n.collections.length,t=0;t<r;t++)u={name:n.collections[t].name,id:n.collections[t].id},i[t]=u;return i},n}(),i=function(){function n(){}return n.logAction=function(n,i){var r={logData:{feature:t.logFeatureName,action:n,data:i},impressionGuid:ft.dynamicProperties.mapsIG};ui.invokeHandler(ii.instrumentationDataHandlerKey,r)},n.perfLog=function(n,t){return n?n.start("CX_"+t):null},n._getLocations=function(n){var r,t,i;return n&&(t=n,t.rings&&t.rings.length>0?r={x:t.rings[0].x,y:t.rings[0].y}:(i=n,i.x&&i.y&&(r={x:i.x,y:i.y}))),r},n.calculateLength=function(t){var u=0,i,f,r;if(t&&(i=n._getLocations(t),i&&i.x.length>=2))for(f=i.x.length,r=0;r<f-1;r++)u+=n._greatCircleDistance(i.y[r],i.x[r],i.y[r+1],i.x[r+1]);return u},n.calculateArea=function(t){var l=0,i,r;if(t&&(i=n._getLocations(t),i&&i.x.length>=3)){var u=n.getMedianCentroid(t),o=n._getUnitSpherePoint(u[0],u[1]),a=n._getTangentPlaneBasis(o),v=a[0],y=a[1],s=0,p=0,h=n._greatCircleDistance(u[0],u[1],i.y[p],i.x[p])/ut.earthRadiusMajorAxis,c,f=n._getProjectedCoordinates(o,v,y,i.y[0],i.x[0]),e;if(f.length===0)return-1;var b=h,k=f,w=i.x.length;for(r=1;r<w;r++){if(c=n._greatCircleDistance(u[0],u[1],i.y[r],i.x[r])/ut.earthRadiusMajorAxis,e=n._getProjectedCoordinates(o,v,y,i.y[r],i.x[r]),e.length===0)return-1;s=s+n._signedExcess(n._triangleExcess(i.y[r-1],i.x[r-1],i.y[r],i.x[r],h,c),f,e);f=e;h=c}l=Math.abs(s)*ut.earthRadiusMajorAxis*ut.earthRadiusMajorAxis}return l},n.getMedianCentroid=function(t){var i=[0,0],r=n._getLocations(t);return r&&r.x.length>=3&&(i[0]=(t.bounds[0]+t.bounds[2])/2,i[1]=(t.bounds[1]+t.bounds[3])/2),i},n.hasSearchId=function(t){var i=(t||"").toLowerCase(),r=i.match(n.ypidRegex);return r&&r.length>0||i.indexOf("sid")!==-1||i.indexOf("eventId")!==-1},n.hasSatoriId=function(t){var i=(t||"").toLowerCase(),r=i.match(n.sidRegex);return r&&r.length>0||i.indexOf("sid")!==-1},n.hasEventId=function(t){var i=(t||"").toLowerCase(),r=i.match(n.eventIdRegex)||i.match(n.sidRegex);return r&&r.length>0||i.indexOf("eventId")!==-1},n.addIdPrefix=function(t){return n.hasSatoriId(t)?t.indexOf("sid:")===-1&&(t="sid:"+t):n.hasEventId(t)?t.indexOf("eventId:")===-1&&(t="eventId:"+t):n.hasSearchId(t)&&t.indexOf("ypid:")===-1&&(t="ypid:"+t),t},n.convertDashesToStrokeDashStyle=function(n){for(var i="",t=0;t<n.length;t++)i+=n[t],t<n.length-1&&(i+=",");return i},n.convertStrokeDashStyleToDashes=function(t){var i,r,u,f;if(!t)return n.solidDashStyle;switch(t.toUpperCase()){case"SOLID":i=n.solidDashStyle;break;case"SHORTDASH":i=n.shortDashStyle;break;case"SHORTDOT":i=n.shortDotStyle;break;case"SHORTDASHDOT":i=n.shortDashDotStyle;break;case"SHORTDASHDOTDOT":i=n.shortDashDotDotStyle;break;case"DOT":i=n.dotStyle;break;case"DASH":i=n.dashStyle;break;case"LONGDASH":i=n.longDashStyle;break;case"DASHDOT":i=n.dashDotStyle;break;case"LONGDASHDOT":i=n.longDashDotStyle;break;case"LONGDASHDOTDOT":i=n.longDashDotDotStyle;break;default:if(r=t.split(","),r.length===1||r.length===0||r.length%2!=0)i=n.solidDashStyle;else{for(i=[],u=0;u<r.length;u++)f=parseInt(r[u]),isNaN(f)||i.push(f);i.length===0&&(i=n.solidDashStyle)}}return i},n.convertLineWidthToStrokeWeight=function(n){return n+"px"},n.convertStrokeWeightToLineWidth=function(n){if(!n)return 1;var i,t;return n.indexOf("px")!==-1?(t=parseInt(n.substr(0,n.length-2)),i=t):n.indexOf("em")!==-1?(t=parseFloat(n.substr(0,n.length-2)),i=8*t):n.indexOf("en")!==-1?(t=parseFloat(n.substr(0,n.length-2)),i=6*t):n.indexOf("pt")!==-1?(t=parseFloat(n.substr(0,n.length-2)),i=2*t):n.indexOf("%")!==-1?(t=parseFloat(n.substr(0,n.length-1)),i=1):(t=parseInt(n),i=t),i},n.convertDateInTicksToJavascriptDate=function(t){var i=(new Date).getTimezoneOffset()*6e4;return new Date(t/1e4-n.epochDiff+i)},n.convertJavascriptDateToDateInTicks=function(t){var i=(new Date).getTimezoneOffset()*6e4;return(t.getTime()+n.epochDiff-i)*1e4},n._greatCircleDistance=function(n,t,i,r){return ut.greatCircleDistance(new y(n,t),new y(i,r))},n._getUnitSpherePoint=function(n,t){var i=[0,0,0],r=Math.PI/180;return i[0]=Math.cos(n*r),i[1]=i[0]*Math.sin(t*r),i[0]=i[0]*Math.cos(t*r),i[2]=Math.sin(n*r),i},n._getTangentPlaneBasis=function(n){var t=[0,0,0],u=[0,0,0],e=[t,u],r=0,i=1,f;return Math.abs(n[2])>Math.abs(n[0])?(r=2,Math.abs(n[0])>Math.abs(n[1])&&(i=0)):Math.abs(n[2])>Math.abs(n[1])&&(i=2),f=Math.sqrt(n[r]*n[r]+n[i]*n[i]),t[r]=-n[i]/f,t[i]=n[r]/f,u[0]=n[1]*t[2]-n[2]*t[1],u[1]=n[2]*t[0]-n[0]*t[2],u[2]=n[0]*t[1]-n[1]*t[0],e},n._getProjectedCoordinates=function(t,i,r,u,f){var o=[],e=n._getUnitSpherePoint(u,f),s=e[0]*t[0]+e[1]*t[1]+e[2]*t[2];return s>0&&(e[0]=e[0]-t[0],e[1]=e[1]-t[1],e[2]=e[2]-t[2],o[0]=(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])/s,o[1]=(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])/s),o},n._triangleExcess=function(t,i,r,u,f,e){var s=n._greatCircleDistance(t,i,r,u)/ut.earthRadiusMajorAxis,o=(f+e+s)/2;return o=Math.tan(o/2)*Math.tan((o-f)/2)*Math.tan((o-e)/2)*Math.tan((o-s)/2),o>0?(o=Math.sqrt(o),o=4*Math.atan(o)):o=0,o},n._signedExcess=function(n,t,i){return t[0]*i[1]-i[0]*t[1]>0?n:-n},n.ypidRegex="yn\\d+x[A-Z,a-z,0-9]+",n.eventIdRegex="f\\d{9}",n.sidRegex="^[A-Z,a-z,0-9]{8}-[A-Z,a-z,0-9]{4}-[A-Z,a-z,0-9]{4}-[A-Z,a-z,0-9]{4}-[A-Z,a-z,0-9]{12}",n.solidDashStyle=[0],n.shortDashStyle=[6,2],n.shortDotStyle=[2,2],n.shortDashDotStyle=[6,2,2,2],n.shortDashDotDotStyle=[6,2,2,2,2,2],n.dotStyle=[2,6],n.dashStyle=[10,6],n.longDashStyle=[20,6],n.dashDotStyle=[10,6,2,6],n.longDashDotStyle=[20,6,2,6],n.longDashDotDotStyle=[20,6,2,6,2,6],n.epochDiff=621355968e5,n}(),o=function(){function t(){}return t.makeCgRetrieveAllCollectionsMetadataRequest=function(i,r){var f={RequestType:1,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion},u=null;e.getFunctionalTestHooksEnabled()&&(u=n.retrieveAllCollectionsBag);t._makeCgRequest(i,r,f,u)},t.makeCgRetrieveAllCollectionsRequest=function(i,r){var u={RequestType:2,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion};t._makeCgRequest(i,r,u)},t.makeCgRetrieveCollectionRequest=function(i,r,u,f){var s={RequestType:3,CollectionId:i,ClientETag:r,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion},o=null;e.getFunctionalTestHooksEnabled()&&(o=n.retrieveCollectionBag);t._makeCgRequest(u,f,s,o)},t.makeCgRetrieveUpcomingEventsRequest=function(r,u){var s=i.convertJavascriptDateToDateInTicks(new Date),o={RequestType:3,CollectionId:c.upcomingEventsId,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion},f;n.showOldEvents||(o.EventTimeRangeFilterUTC={StartTime:s});f=null;e.getFunctionalTestHooksEnabled()&&(f=n.retrieveCollectionBag);t._makeCgRequest(r,u,o,f,n.testUser)},t.makeCgRetrieveSharedCollectionRequest=function(i,r,u,f,o){var h={RequestType:10,CollectionId:i,ClientETag:r,ExternalUserId:u,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion},s=null;e.getFunctionalTestHooksEnabled()&&(s=n.retrieveCollectionBag);t._makeCgRequest(f,o,h,s)},t.makeCgCreateCollectionRequest=function(i,r,u){var o={RequestType:5,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:i.eTag,CollectionToBeWritten:c.serialize(i,!0)},f=null;e.getFunctionalTestHooksEnabled()&&(f=n.insertCollectionBag);t._makeCgRequest(r,u,o,f)},t.makeCgUpdateCollectionRequest=function(i,r,u){var o={RequestType:5,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:i.eTag,CollectionId:i.id,CollectionToBeWritten:c.serialize(i,!0)},f=null;e.getFunctionalTestHooksEnabled()&&(f=n.updateCollectionBag);t._makeCgRequest(r,u,o,f)},t.makeCgUpdateCollectionMetadataRequest=function(i,r,u){var o=c.serialize(i,!0),s,f;o.Items=null;s={RequestType:6,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:i.eTag,CollectionId:i.id,MetaToBeWritten:o};f=null;e.getFunctionalTestHooksEnabled()&&(f=n.updateCollectionMetaBag);t._makeCgRequest(r,u,s,f)},t.makeCgAddPrimitiveRequest=function(i,r,u,f,o){var s,h,c;if(r){switch(r.geometryType){case 1:s=nt.serialize(r,!0);break;case 2:s=ht.serialize(r,!0);break;case 3:s=st.serialize(r,!0);break;default:f&&f(1);return}h={RequestType:4,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:i.eTag,CollectionId:i.id,ItemToBeWritten:s};c=null;e.getFunctionalTestHooksEnabled()&&(c=n.insertItemBag);o&&(h.ItemId=r.entity.id);t._makeCgRequest(u,f,h,c)}},t.makeCgDeleteCollectionRequest=function(i,r,u){var o={RequestType:7,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:i.eTag,CollectionId:i.id},f=null;e.getFunctionalTestHooksEnabled()&&(f=n.deleteCollectionBag);t._makeCgRequest(r,u,o,f)},t.makeCgDeletePrimitiveRequest=function(i,r,u,f){var s={RequestType:8,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:r.eTag,CollectionId:r.id,ItemId:i},o=null;e.getFunctionalTestHooksEnabled()&&(o=n.deleteItemBag);t._makeCgRequest(u,f,s,o)},t._getMarket=function(){return ft.dynamicProperties.market},t._makeCgRequest=function(t,r,u,f,e){function h(n){t&&t(b.Internals.parseJSON(n))}function c(n,t,f){r&&(n&&n!==" "&&!!t?(t===404&&f.indexOf("No Collection found for the user")!==-1||i.logAction(a.pdpRequestFailure,{status:t,statusText:f,reqType:u.RequestType,colId:u.CollectionId}),r(1,b.Internals.parseJSON(n),t)):t===304?r(0,null):(i.logAction(a.pdpRequestFailure,{status:t,statusText:f,reqType:u.RequestType,colId:u.CollectionId}),r(1,null)))}var o=n.cgApiUrl,s;f&&(o=f);e&&(s={"Test-User-AuthToken":e});fi.doPost(o,b.Internals.stringify(u),{onError:c,onSuccess:h,headers:s})},t}(),et=function(){function t(i){var r=this;if(this._invalidIndex=-1,this._collectionAlreadyLogged=!1,this._myPlacesAlreadyLogged=!1,this._favoritesAlreadyLogged=!1,t.instance&&!i)return t.instance;this.favoritesLoaded=new it;this.favoritePrimitivesChanged=new it;this.homeOrWorkChanged=new it;this.favoritesFailedToLoad=new it;this.upcomingEventsSet=new it;this.collectionAdded=new it;this._favoritesSynced=!1;n.enableAutoCollections&&this.favoritesLoaded.addOne(function(){r._instantiateAutoCollections()});graph&&(graph.Settings._useSSL=window.location.protocol==="https:",graph.Settings._useProd=n.clientGraphUseProd)}return t.prototype.doesMyPlacesExist=function(){return!!this._myPlaces},t.prototype.findCollectionById=function(n){var r=null,u,t,i;if(n&&this._myPlaces)for(u=this._myPlaces.collections.length,t=0;t<u;t++)if(i=this._myPlaces.collections[t],i.id.toLowerCase()===n.toLowerCase()){r=i;break}return r},t.ensureGraphCommit=function(n){var t,i=0;t=function(r){i++;r!==200?i<=4?graph.Sync(t):n(r):n&&n(r)};e.getFunctionalTestHooksEnabled()||graph.Sync(t)},t.prototype.syncFavorites=function(r){var u=this,f;graph&&(f=function(n){var s,f,l,c;if(n===200){var v=graph.Me.Preferences.Favorites.GetPreferredPlace(graph.Entities.FavoritesCategoryHome),y=graph.Me.Preferences.Favorites.GetPreferredPlace(graph.Entities.FavoritesCategoryWork),p=graph.Me.Preferences.Favorites.Collections.Default.Members,e,o;for(u.favorites=new h,s=p.Count-1;s>=0;s--)if(f=p.GetAt(s),f.IsEntity&&f.Type===graph.Entities.Place){if(v===f&&!e){e=new ct;e.createPointFromPlace(v)&&(u.home=e,u.home.entity.setIsHomeOrWork("home"));continue}if(y===f&&!o){o=new ct;o.createPointFromPlace(y)&&(u.work=o,u.work.entity.setIsHomeOrWork("work"));continue}l=new ct;c=f;(c.Geometry||c.DisplayCoordinates)&&l.createPointFromPlace(c)&&u.favorites.insert(l)}u.favoriteErrorCode=0;u.favoritesLoaded.invoke();u._favoritesAlreadyLogged||(i.logAction(a.itemCounts,{FAV:u.favorites.length}),u._favoritesAlreadyLogged=!0);u.favoritePrimitivesChanged.invoke();u._favoritesSynced=!0;r(0);t.ensureGraphCommit()}else u.favoriteErrorCode=9,u.favoritesFailedToLoad.invoke(),r(9)},e.getFunctionalTestHooksEnabled()?(!n.returnMockFavorites||this.favorites&&this.favorites.length||this._fillGraphWithMockFavorites(),f(200)):this._favoritesSynced?(r(0),t.ensureGraphCommit()):t.ensureGraphCommit(f))},t.prototype.setHome=function(n,r){var u=this,f,o;graph&&(f=function(n,t){if(t===0||t===10&&n!==u.work){var i=n.entity.getPlace();graph.Me.Preferences.Favorites.SetPreferredPlace(graph.Entities.FavoritesCategoryHome,i);u.favorites.indexOf(n)!==-1&&u.favorites.remove(n);u.home&&u.favorites.indexOf(u.home)===-1&&u.home.entity.removePlace();u.home=n;u.home.entity.setIsHomeOrWork("home");u.homeOrWorkChanged.invoke();u.favoritePrimitivesChanged.invoke();r(n,0)}else r(null,t)},n.entity.getPlace()===null?this.createFavorite(n,f):(o=function(r){r===200?(f(n,0),i.logAction(a.favorites,{SHM:"True"}),t.ensureGraphCommit()):(i.logAction(a.favorites,{SHM:"False",ERR:r}),f(n,9))},e.getFunctionalTestHooksEnabled()?o(200):t.ensureGraphCommit(o)))},t.prototype.setWork=function(n,r){var u=this,f,o;graph&&(f=function(n,t){if(t===0||t===10&&n!==u.home){var i=n.entity.getPlace();graph.Me.Preferences.Favorites.SetPreferredPlace(graph.Entities.FavoritesCategoryWork,i);u.favorites.indexOf(n)!==-1&&u.favorites.remove(n);u.work&&u.favorites.indexOf(u.work)===-1&&u.work.entity.removePlace();u.work=n;u.work.entity.setIsHomeOrWork("work");u.homeOrWorkChanged.invoke();u.favoritePrimitivesChanged.invoke();r(n,0)}else r(null,t)},n.entity.getPlace()===null?this.createFavorite(n,f):(o=function(r){r===200?(f(n,0),i.logAction(a.favorites,{SWK:"True"}),t.ensureGraphCommit()):(i.logAction(a.favorites,{SWK:"False",ERR:r}),f(n,9))},e.getFunctionalTestHooksEnabled()?o(200):t.ensureGraphCommit(o)))},t.prototype.createFavorite=function(n,r,u){var f=this,o;graph&&n&&n.entity&&(o=function(e){var o,h,s,c;e===200?(o=n.entity.getPlaceId(),h=f.getExistingFavorite(o),h!==null?r(h,12):(s=f.favorites.length,f.home&&s++,f.work&&s++,s>=t._maxFavorites?r(null,4):(o=i.addIdPrefix(o),n.entity.setBusinesslistingid(o),f.favorites.indexOf(n)===-1&&(f.favorites.insert(n,0),f.favoritePrimitivesChanged.invoke()),c=n.entity.createPlaceFromFavorite(),r(n,0),i.logAction(a.favorites,{CFA:"True",SL:u?u:1}),t.ensureGraphCommit()))):(i.logAction(a.favorites,{CFA:"False",ERR:e}),r(null,9))},e.getFunctionalTestHooksEnabled()?o(200):t.ensureGraphCommit(o))},t.prototype.removeFavorite=function(n,r){var u=this,f;graph&&(f=function(f){f===200?(u.home===n&&(u.home=null,graph.Me.Preferences.Favorites.GetPreferredPlace(graph.Entities.FavoritesCategoryHome).Delete(),u.homeOrWorkChanged.invoke()),u.work===n&&(u.work=null,graph.Me.Preferences.Favorites.GetPreferredPlace(graph.Entities.FavoritesCategoryWork).Delete(),u.homeOrWorkChanged.invoke()),n.entity.removePlace(),u.favorites.remove(n),u.favoritePrimitivesChanged.invoke(),r(0),i.logAction(a.favorites,{DEL:"True"}),t.ensureGraphCommit()):(i.logAction(a.favorites,{DEL:"False",ERR:f}),r(9))},e.getFunctionalTestHooksEnabled()?f(200):t.ensureGraphCommit(f))},t.prototype.isExistingFavorite=function(n){return this.getExistingFavorite(n)?!0:!1},t.prototype.getExistingFavorite=function(n){if(this.home&&this.home.entity.id.indexOf(n)!==-1)return this.home;if(this.work&&this.work.entity.id.indexOf(n)!==-1)return this.work;if(this.favorites)for(var t=0;t<this.favorites.length;t++)if(this.favorites[t]&&this.favorites[t].entity.id.indexOf(n)!==-1)return this.favorites[t];return null},t.prototype.retrieveAllCollectionsMetaData=function(n){var t=this;this._myPlaces?(this._myPlaces.sortCollections(),n&&n(this._myPlaces,0)):o.makeCgRetrieveAllCollectionsMetadataRequest(function(i){return t._handleCollectionsServiceRetrieveAllResponse(i,n)},function(i,r,u){r===null||r.CollectionsMetaMap?n&&n(null,i?9:0):t._handleCollectionsServiceRetrieveAllResponse(r,n,u)});this.home&&this.work&&this.favorites?this.favoritesLoaded.invoke():this.syncFavorites(function(){})},t.prototype.retrieveAllCollections=function(n){var t=this;o.makeCgRetrieveAllCollectionsRequest(function(i){return t._handleCollectionsServiceRetrieveAllResponse(i,n)},function(i,r,u){r===null||r.CollectionsMap?n&&n(null,i?9:0):t._handleCollectionsServiceRetrieveAllResponse(r,n,u)})},t.prototype.retrieveCollection=function(n,t,i){var f=this,r,u,e,s;!n&&t?t(null,7):(r=this._getCollectionIndexFromCache(n),u=null,r!==this._invalidIndex&&this._myPlaces.collections[r].primitivesRetrieved&&(u=this._myPlaces.collections[r].eTag),e=function(n){return f._handleSingleCollectionResponse(n,t,r,!0)},s=function(n,i){i===null||i.CollectionsMap?n===0?t&&t(f._myPlaces.collections[r],0):t&&t(null,n?9:0):f._handleSingleCollectionResponse(i,t,r,!0)},i?o.makeCgRetrieveSharedCollectionRequest(n,u,i,e,s):o.makeCgRetrieveCollectionRequest(n,u,e,s))},t.prototype.retrieveUpcomingEvents=function(n){var t=this,i=function(i){var r=function(i,r){r===0&&(t._sortEvents(i),t.upcomingEvents=i,t.upcomingEventsSet.invoke());n(i,r)};return t._handleSingleCollectionResponse(i,r,-1,!0)},r=function(i,r){r===null||r.CollectionsMap||t._handleSingleCollectionResponse(r,n,-1,!0)};o.makeCgRetrieveUpcomingEventsRequest(i,r)},t.prototype.createCollection=function(i,r){var u=this,f;!i&&r?r(null,7):(f=this._getCollectionIndexFromCache(i.id),this._myPlaces&&this._myPlaces.collections.length>=t._getMaxAllowedCollections()?r&&r(null,2):f===this._invalidIndex?o.makeCgCreateCollectionRequest(i,function(t){u._myPlaces||(u._myPlaces=new bt,u._addAutoCollectionsToMyPlaces());u._myPlaces.collections&&u._myPlaces.collections.insert(i,0);i.id=t.CollectionId;i.eTag=t.ServerETag;i.primitivesRetrieved=!0;i.externalUserId=t.ExternalUserId;n.enableMostRecentlyUsedList&&ot.instance.pushCollection(i);r(i,0)},function(n){r&&r(null,n?9:0)}):r&&r(null,8))},t.prototype.deleteCollection=function(n,t){var i,r;!n&&t?t(7):(i=this._getCollectionIndexFromCache(n),i!==this._invalidIndex?(r=this._myPlaces.collections[i],this._myPlaces.collections.removeAt(i),o.makeCgDeleteCollectionRequest(r,function(){r.disposed.invoke();t(0)},function(n){t&&t(n?9:0)})):t&&t(5))},t.prototype.updateCollection=function(n,t){var r=this,i;!n&&t?t(null,7):(i=this._getCollectionIndexFromCache(n.id),n.primitivesRetrieved?o.makeCgUpdateCollectionRequest(n,function(n){return r._handleUpdateCollectionResponse(n,t,i)},function(n){t&&t(null,n?9:0)}):n.primitives.length?this.retrieveCollection(n.id,function(u,f){if(f===0){for(var e=0;e<u.primitives.length;e++)n.primitives.insert(u.primitives[e]);o.makeCgUpdateCollectionRequest(n,function(u){return r._handleUpdateCollectionResponse(u,t,i,n)},function(n){t&&t(null,n?9:0)})}else t&&t(null,f)}):o.makeCgUpdateCollectionMetadataRequest(n,function(n){return r._handleUpdateCollectionResponse(n,t,i)},function(n){t&&t(null,n?9:0)}))},t.prototype.updateCollectionMeta=function(n,t){var r=this,i;!n&&t?t(null,7):(i=this._getCollectionIndexFromCache(n.id),o.makeCgUpdateCollectionMetadataRequest(n,function(n){return r._handleUpdateCollectionResponse(n,t,i)},function(n){t&&t(null,n?9:0)}))},t.prototype.addPrimitive=function(i,r,u){var h=this,e,f,c;u&&(i?r?(e=this._getCollectionIndexFromCache(i),e===this._invalidIndex?u(null,5):r.entity&&r.entity.id!==s.localEntityId?u(null,10):(f=this._myPlaces.collections[e],c=this._checkIfRequestShouldBeDone(f,r),f.primitivesRetrieved&&f.primitives.length>=t._getMaxAllowedCollectionEntites()||f.getItemCount()>=t._getMaxAllowedCollectionEntites()?u(null,3):c?o.makeCgAddPrimitiveRequest(f,r,function(t){r.entity.id=t.ItemId;f.primitives.insert(r,0);t.ServerETag&&(f.eTag=t.ServerETag);h._filterOutPolylinesAndPolygons(f,!1);n.enableMyPlacesUxRedesign&&h._updateCollectionMetaWithAddedImageCollage(f,r);n.enableMostRecentlyUsedList&&ot.instance.pushCollection(f);u&&u(f,0,t.ItemId)},function(n){u(null,n===0?0:9)}):u(f,12))):u(null,10):u(null,7))},t.prototype.deletePrimitive=function(t,i,r){var s=this,f,e,u;r&&(t?i?(f=this._getPrimitiveIndexFromCollection(t,i),f!==this._invalidIndex?(e=this._getCollectionIndexFromCache(t),u=this._myPlaces.collections[e],o.makeCgDeletePrimitiveRequest(i,u,function(t){t.ServerETag&&(u.eTag=t.ServerETag);var i=u.primitives[f].entity.photoUrl;u.primitives.removeAt(f);n.enableMyPlacesUxRedesign&&s._updateCollectionMetaWithRemovedImageCollage(u,i);u.primitives.changed.invoke();r(0)},function(){r(9)})):r(11)):r(10):r(7))},t.prototype.updatePrimitive=function(n,t,i){if(i)if(n)if(t){var r=this._getPrimitiveIndexFromCollection(n.id,t.entity.id);r===this._invalidIndex?i(11):o.makeCgAddPrimitiveRequest(n,t,function(t){t.ServerETag&&(n.eTag=t.ServerETag);i&&i(0)},function(n){i(n===0?0:9)},!0)}else i(10);else i(7)},t.prototype._updateCollectionMetaWithAddedImageCollage=function(n,t){var i=t.entity.photoUrl;i&&n.collageImages.length<3&&n.collageImages.insert(i,0);this.updateCollectionMeta(n,function(t,i){i===0&&n.changed.invoke()})},t.prototype._updateCollectionMetaWithRemovedImageCollage=function(n,t){var i,r;if(n.collageImages.remove(t),n.collageImages.length<3&&n.primitives.length>=3)for(i=0;i<n.primitives.length;i++)if(r=n.primitives[i].entity.photoUrl,r&&n.collageImages.indexOf(r)===-1){n.collageImages.insert(r);break}this.updateCollectionMeta(n,function(t,i){i===0&&n.changed.invoke()})},t.prototype._handleCollectionsServiceRetrieveAllResponse=function(n,t,r){var u=new bt,f=n.RequestType===1?n.CollectionsMetaMap:n.CollectionsMap,o,s,e;if(f){for(o in f)f.hasOwnProperty(o)&&(s=f[o],e=c.deserialize(s,!0),e&&(e.externalUserId=n.ExternalUserId,u.collections.insert(e)));u.sortCollections();this._myPlaces=u;this._addAutoCollectionsToMyPlaces();this._myPlacesAlreadyLogged||(i.logAction(a.itemCounts,{COL:u.collections.length}),this._myPlacesAlreadyLogged=!0);t&&t(this._myPlaces,0)}else n&&r===404?(this._myPlaces=u,t&&t(this._myPlaces,0)):t&&t(this._myPlaces,9)},t.prototype._handleSingleCollectionResponse=function(n,t,i,r,u){var e=n.CollectionsMap,l=this._myPlaces&&this._myPlaces.collections[i],o=l&&e[l.id],s,f,h;if(!o)for(s in e)if(e.hasOwnProperty(s)){o=e[s];break}if(f=c.deserialize(o,!0),!f){t&&t(null,5);return}f.externalUserId=n.ExternalUserId;h=9;f&&(i!==this._invalidIndex&&(this._myPlaces.collections[i]=f,this._myPlaces.collections[i].primitivesRetrieved=!u,this._myPlaces.collections.changed.invoke()),this._filterOutPolylinesAndPolygons(f,r),h=0);t&&t(f,h)},t.prototype._handleUpdateCollectionResponse=function(n,t,i,r){var u=this._myPlaces.collections[i];r&&(u.primitives=r.primitives);n.ServerETag&&(u.eTag=n.ServerETag);t&&t(u,0)},t.prototype._checkIfRequestShouldBeDone=function(n,t){for(var r,u=!0,f=t.entity,i=0;i<n.primitives.length;i++)if(r=n.primitives[i].entity,r.businesslistingid&&f.businesslistingid&&r.businesslistingid===f.businesslistingid){u=!1;break}return u},t.prototype._getCollectionIndexFromCache=function(n){var i=this._invalidIndex,r,t,u;if(n&&this._myPlaces)for(r=this._myPlaces.collections.length,t=0;t<r;t++)if(u=this._myPlaces.collections[t],u.id.toLowerCase()===n.toLowerCase()){i=t;break}return i},t.prototype._getPrimitiveIndexFromCollection=function(n,t){var u=this._getCollectionIndexFromCache(n),f=this._invalidIndex,r,e,i,o;if(u!==this._invalidIndex)for(r=this._myPlaces.collections[u],e=r.primitives.length,i=0;i<e;i++)if(o=r.primitives[i],o.entity.id.toLowerCase()===t.toLowerCase()){f=i;break}return f},t.prototype._filterOutPolylinesAndPolygons=function(t){var r;if(t&&t.primitives){var f=0,u=t.primitives,e=u.length;for(r=u.length-1;r>=0;r--)u[r].geometryType!==1&&(f++,n.enablePolyshapes||u.removeAt(r));n.enablePolyshapes||(t.containsPolyshapes=!1);this._collectionAlreadyLogged||(i.logAction(a.itemCounts,{PRI:e,DRG:f}),this._collectionAlreadyLogged=!0);i.logAction(a.privacySharingState,{PUB:t.isPublic})}},t.prototype._sortEvents=function(n){for(var u,f,r,t=n.primitives,i=1;i<t.length;i++)if(u=t[i],f=u.entity.startDate,!(f.valueOf()>t[i-1].entity.startDate.valueOf())){for(t.removeAt(i),r=i-2,r;r>=0;r--)if(f.valueOf()>t[r].entity.startDate.valueOf())break;t.insert(u,r+1)}},t._getMaxAllowedCollections=function(){return n.maxAllowedCollections},t._getMaxAllowedCollectionEntites=function(){return n.maxAllowedCollectionEntities},t.prototype._fillGraphWithMockFavorites=function(){var n="47.603569_-122.329498",i=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(n),t,r,f,e,u;i.Name=graph.CreateText("Seattle");i.OriginalName=graph.CreateText("Seattle");i.Address=graph.CreateTyped(graph.Entities.PostalAddress,n);i.Address.AddressSingleLine=graph.CreateText("Seattle, WA");i.BingEntityId=graph.CreateText("5fbba6b8-85e1-4d41-9444-d9055436e473");i.Description=graph.CreateText("My Home City");i.DisplayCoordinates=graph.CreateGeometryPoint(47.603569,-122.329498);graph.Me.Preferences.Favorites.SetPreferredPlace(graph.Entities.FavoritesCategoryHome,i);n="47.61492538452_-122.1939697265625";t=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(n);t.Name=graph.CreateText("Microsoft CCP");t.OriginalName=graph.CreateText("Microsoft Bravern");t.Address=graph.CreateTyped(graph.Entities.PostalAddress,n);t.Address.AddressSingleLine=graph.CreateText("500 108th Ave Ne Ste 1810, Bellevue, WA 98004");t.BingEntityId=graph.CreateText(n);t.Description=graph.CreateText("On the 9th floor");t.DisplayCoordinates=graph.CreateGeometryPoint(47.614925384521484,-122.1939697265625);graph.Me.Preferences.Favorites.SetPreferredPlace(graph.Entities.FavoritesCategoryWork,t);n="YN926x15799544";r=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(n);r.Name=graph.CreateText("Portage Bay Cafe");r.OriginalName=graph.CreateText("Portage Bay Cafe");r.Description=graph.CreateText("My favorite sea food place");r.Address=graph.CreateTyped(graph.Entities.PostalAddress,n);r.Address.AddressSingleLine=graph.CreateText("4130 Roosevelt Way Ne, Seattle, WA, United States");r.BingEntityId=graph.CreateText(n);r.DisplayCoordinates=graph.CreateGeometryPoint(47.657768,-122.317802);n="YN873x112609011";f=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(n);f.Name=graph.CreateText("Space Needle");f.OriginalName=graph.CreateText("Space Needle");f.Address=graph.CreateTyped(graph.Entities.PostalAddress,n);f.Address.AddressSingleLine=graph.CreateText("400 Broad Street, Seattle, WA, United States");f.BingEntityId=graph.CreateText(n);f.DisplayCoordinates=graph.CreateGeometryPoint(47.620491,-122.349297);n="YN926x15812295";e=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(n);e.Name=graph.CreateText("Cafe Flora");e.OriginalName=graph.CreateText("Cafe Flora");e.Address=graph.CreateTyped(graph.Entities.PostalAddress,n);e.Address.AddressSingleLine=graph.CreateText("2901 E Madison St, Seattle, WA 98112");e.BingEntityId=graph.CreateText(n);e.DisplayCoordinates=graph.CreateGeometryPoint(47.624046,-122.295097);n="47.640049_-122.129797";u=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(n);u.Name=graph.CreateText("Microsoft Main Campus");u.OriginalName=graph.CreateText("Microsoft Main Campus");u.Description=graph.CreateText("Microsoft Home office");u.Address=graph.CreateTyped(graph.Entities.PostalAddress,n);u.Address.AddressSingleLine=graph.CreateText("1 Microsoft Way, Redmond, WA");u.BingEntityId=graph.CreateText(n);u.DisplayCoordinates=graph.CreateGeometryPoint(47.640049,-122.129797)},t.prototype._instantiateAutoCollections=function(){var n=this;dt&&dt.container.instanceAsync("AutoCollectionGenerator",function(t){n.autoCollectionGenerator=t;n.autoCollectionGenerator.generateAutoCollections(n.favorites,n.home,n.work);n._autoCollections=[];n._autoCollections.push(n.autoCollectionGenerator.labeledCollection);n._autoCollections.push(n.autoCollectionGenerator.nearHomeCollection);n._autoCollections.push(n.autoCollectionGenerator.nearWorkCollection);for(var i=0,r=n.autoCollectionGenerator.nearbyCollections.length;i<r;i++)n._autoCollections.push(n.autoCollectionGenerator.nearbyCollections[i].collection);n._myPlaces&&n._addAutoCollectionsToMyPlaces()})},t.prototype._addAutoCollectionsToMyPlaces=function(){if(n.enableAutoCollections&&this._autoCollections&&this._myPlaces)for(var t=this._autoCollections.length-1;t>=0;t--)this._myPlaces.autocollections.insert(this._autoCollections[t],0)},t._maxFavorites=300,t.instance=new t,t}(),yt=function(n){function t(){var t=this,i={};return t=n.call(this,i)||this,i.defineProperty("name",function(n,i){t._onNameChanged(n,i)}),i.defineProperty("originalName",function(n,i){t._onOriginalNameChanged(n,i)}),i.defineProperty("description",function(n,i){t._onDescriptionChanged(n,i)}),i.defineProperty("address",function(n,i){t._onAddressChanged(n,i)}),i.defineProperty("addressFields",function(n,i){t._onAddressFieldsChanged(n,i)}),i.defineProperty("phone",function(n,i){t._onPhoneChanged(n,i)}),i.defineProperty("businesslistingid",function(n,i){t._onBusinesslistingidChanged(n,i)}),i.defineProperty("photoUrl",function(n,i){t._onPhotoUrlChanged(n,i)}),i.defineProperty("url",function(n,i){t._onUrlChanged(n,i)}),i.defineProperty("geometry",function(n,i){t._onGeometryChanged(n,i)}),i.defineProperty("isHomeOrWork",function(n,i){t._onIsHomeOrWorkChanged(n,i)}),i.defineProperty("showOnMap",function(n,i){t._onShowOnMapChanged(n,i)}),i.defineProperty("iconText"),i.defineProperty("iconSource"),i.defineProperty("displayOrder"),t.id="",t._place=null,t.setIsHomeOrWork(""),t}return w(t,n),t.prototype.dispose=function(){n.prototype.dispose.call(this);this._place=null},t.prototype.getTitle=function(){switch(this.getIsHomeOrWork()){case"home":return v.L_HomeFavorite_Text;case"work":return v.L_WorkFavorite_Text;default:return this.getName()}},t.prototype.getPlace=function(){return this._place},t.prototype.getPlaceId=function(){return this._place?this._place.Id:(this._isBusiness=this._checkIsBusiness(this.getBusinesslistingid()),this.getBusinesslistingid()&&this.getBusinesslistingid()!=="0"?this.getBusinesslistingid().replace("ypid:","").replace("sid:",""):this.getGeometry()&&this.getGeometry().y+"_"+this.getGeometry().x)},t.prototype.createFavoriteFromCollectionEntity=function(n){n&&(this.setName(n.name),this.setAddress(n.address),this.setDescription(n.description),this.setBusinesslistingid(n.businesslistingid),this.setPhotoUrl(n.photoUrl))},t.prototype.ToCollectionEntity=function(){var t={name:this.getName(),description:this.getDescription(),address:this.getAddress(),photoUrl:this.getPhotoUrl()},u=this.getGeometry(),r,n;return u&&(t.routableLocation=t.labelLocation=new y(u.y,u.x)),n=this.getBusinesslistingid(),n&&(n.indexOf("ypid:")!==-1||n.indexOf("sid:")!==-1?r=n:n!=="0"&&(i.hasSearchId(n)?r="ypid:"+n:n.split("_").length!==2&&(r="sid:"+n)),r&&(t.businesslistingid=n)),t},t.prototype.createFavoriteFromPlace=function(n){var t,r;n&&(n.Geometry||n.DisplayCoordinates)&&(n.Id&&(this.id=n.Id),n.Name&&this.setName(n.Name.Value),n.OriginalName&&this.setOriginalName(n.OriginalName.Value),!this.getName()&&this.getOriginalName()&&this.setName(this.getOriginalName()),n.Description&&this.setDescription(n.Description.Value),n.Address&&(n.Address.AddressSingleLine&&this.setAddress(n.Address.AddressSingleLine.Value),t={addressLine:n.Address.StreetAddress&&n.Address.StreetAddress.Value,city:n.Address.AddressLocality&&n.Address.AddressLocality.Value,stateMunicipality:n.Address.AddressRegion&&n.Address.AddressRegion.Value,country:n.Address.AddressCountry&&n.Address.AddressCountry.Value,neighborhood:"",postalCode:n.Address.PostalCode&&n.Address.PostalCode.Value,formattedAddress:this.getAddress()},this.setAddressFields(t)),n.Phone&&this.setPhone(n.Phone.Value),n.BingEntityId&&(r=i.addIdPrefix(n.BingEntityId.Value),this.setBusinesslistingid(r)),n.BusinessType&&(this.categoryId=n.BusinessType.Value),n.ImageUri&&this.setPhotoUrl(n.ImageUri.Value),n.Url&&this.setUrl(n.Url.Value),n.ShowOnMap?this.setShowOnMap(n.ShowOnMap.Value):this.setShowOnMap(!0),n.Geometry?n.Geometry.Longitude&&n.Geometry.Latitude&&this.setGeometry({x:n.Geometry.Longitude.Value,y:n.Geometry.Latitude.Value,bounds:[n.Geometry.Latitude.Value,n.Geometry.Longitude.Value,n.Geometry.Latitude.Value,n.Geometry.Longitude.Value]}):n.DisplayCoordinates&&n.DisplayCoordinates.Longitude&&n.DisplayCoordinates.Latitude&&this.setGeometry({x:n.DisplayCoordinates.Longitude.Value,y:n.DisplayCoordinates.Latitude.Value,bounds:[n.DisplayCoordinates.Latitude.Value,n.DisplayCoordinates.Longitude.Value,n.DisplayCoordinates.Latitude.Value,n.DisplayCoordinates.Longitude.Value]}),n.DisplayOrder&&this.setDisplayOrder(n.DisplayOrder.Value),this._place=n)},t.prototype.createPlaceFromFavorite=function(){var i,n,r,t;return this._place||(i=this.getPlaceId(),n=graph.Me.Preferences.Favorites.Collections.Default.CreatePlace(i),n.Id&&(this.id=n.Id),this.getName()&&(n.Name=graph.CreateText(this.getName())),r=this.getOriginalName()?this.getOriginalName():this.getName(),r&&(n.OriginalName=graph.CreateText(r)),this.getDescription()&&(n.Description=graph.CreateText(this.getDescription())),this.getAddress()&&(n.Address=graph.CreateTyped(graph.Entities.PostalAddress,i),n.Address.AddressSingleLine=graph.CreateText(this.getAddress()),t=this.getAddressFields(),t&&(n.Address.AddressLocality=graph.CreateText(t.city),n.Address.AddressRegion=graph.CreateText(t.stateMunicipality),n.Address.AddressCountry=graph.CreateText(t.country),n.Address.PostalCode=graph.CreateText(t.postalCode),n.Address.StreetAddress=graph.CreateText(t.addressLine))),this.getPhone()&&(n.Phone=graph.CreateText(this.getPhone())),i&&(n.BingEntityId=graph.CreateText(i)),this._isBusiness&&(n.IsBusiness=graph.Create(!0)),this.categoryId&&(n.BusinessType=graph.CreateText(this.categoryId)),this.getPhotoUrl()&&(n.ImageUri=graph.CreateText(this.getPhotoUrl())),this.getUrl()&&(n.Url=graph.CreateText(this.getUrl())),this.getGeometry()&&(n.DisplayCoordinates=graph.CreateGeometryPoint(this.getGeometry().y,this.getGeometry().x)),this._place=n),this._place},t.prototype.removePlace=function(){if(this._place){var n=this._place;this._place=null;graph.Me.Preferences.Favorites.Collections.Default.Members.Remove(n);n.Delete()}},t.prototype._onNameChanged=function(n,t){var i=this;this.name=this.getTitle();this._updatePlaceFields(function(n){n&&(i._place.Name=graph.CreateText(t))})},t.prototype._onOriginalNameChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.OriginalName=graph.CreateText(t))})},t.prototype._onDescriptionChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.Description=graph.CreateText(t))})},t.prototype._onAddressChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.Address||(i._place.Address=graph.CreateTyped(graph.Entities.PostalAddress,i._place.BingEntityId.Value)),i._place.Address.AddressSingleLine=graph.CreateText(t))})},t.prototype._onAddressFieldsChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.Address||(i._place.Address=graph.CreateTyped(graph.Entities.PostalAddress,i._place.BingEntityId.Value)),i._place.Address.AddressLocality=graph.CreateText(t.city),i._place.Address.AddressRegion=graph.CreateText(t.stateMunicipality),i._place.Address.AddressCountry=graph.CreateText(t.country),i._place.Address.PostalCode=graph.CreateText(t.postalCode),i._place.Address.StreetAddress=graph.CreateText(t.addressLine))})},t.prototype._onPhoneChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.Phone=graph.CreateText(t))})},t.prototype._onBusinesslistingidChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._isBusiness=i._checkIsBusiness(t),i._isBusiness&&(i._place.IsBusiness=graph.Create(!0)),i._place.BingEntityId=graph.CreateText(t.replace("ypid:","").replace("sid:","")))})},t.prototype._onPhotoUrlChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.ImageUri=graph.CreateText(t))})},t.prototype._onUrlChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.Url=graph.CreateText(t))})},t.prototype._onGeometryChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.Geometry=graph.CreateGeometryPoint(t.y,t.x),i._place.DisplayCoordinates=graph.CreateGeometryPoint(t.y,t.x))})},t.prototype._onIsHomeOrWorkChanged=function(n,t){this.name=this.getTitle();this.homeOrWork=t},t.prototype._onShowOnMapChanged=function(n,t){var i=this;this._updatePlaceFields(function(n){n&&(i._place.ShowOnMap=graph.Create(t))})},t.prototype._updatePlaceFields=function(n){if(this._place&&graph){var t=function(t){n(t===200);et.ensureGraphCommit()};e.getFunctionalTestHooksEnabled()?t(200):et.ensureGraphCommit(t);return}n(!1)},t.prototype._checkIsBusiness=function(n){return n&&(n.indexOf("ypid:")!==-1||i.hasSearchId(n)&&n.indexOf("sid:")===-1)},t}(rt),yi=function(){function t(n){if(t._instance)return t._instance;this.labeledCollection=new c("labeled",v.AutoCollections_LabeledPlaces);this.nearHomeCollection=new c("nearHome",v.AutoCollections_NearHome);this.nearWorkCollection=new c("nearWork",v.AutoCollections_NearWork);this.nearbyCollections=new h;this._reverseGeocoder=n;t._instance=this}return t.prototype.generateAutoCollections=function(n,t,i){n&&!this.favorites&&(this.favorites=n);t&&!this.home&&(this.home=t);i&&!this.work&&(this.work=i);this._generateLabeledCollection();this._generateNearHomeCollection();this._generateNearWorkCollection();this._generateClusteredCityCollections();this._updateImageUrls()},t.prototype._generateLabeledCollection=function(){var n,r,t,i;for(this.labeledCollection.primitives.clear(),this.home&&this.labeledCollection.primitives.insert(this.home),this.work&&this.labeledCollection.primitives.insert(this.work),n=0,r=this.favorites.length;n<r;n++)t=this.favorites[n],i=t.entity,i.getName()!==i.getOriginalName()&&this.labeledCollection.primitives.insert(t)},t.prototype._generateNearHomeCollection=function(){if(this.nearHomeCollection.primitives.clear(),this.home){var n=this.home.geometry,t=new y(n.y,n.x);this._populateNearHomeOrWorkCollection(this.nearHomeCollection,t)}},t.prototype._generateNearWorkCollection=function(){if(this.nearWorkCollection.primitives.clear(),this.work){var n=this.work.geometry,t=new y(n.y,n.x);this._populateNearHomeOrWorkCollection(this.nearWorkCollection,t)}},t.prototype._populateNearHomeOrWorkCollection=function(t,i){for(var r=0,u=this.favorites.length;r<u;r++){var f=this.favorites[r],e=f.geometry,o=new y(e.y,e.x),s=ut.greatCircleDistance(o,i);s<n.nearHomeWorkDistance&&t.primitives.insert(f)}},t.prototype._generateClusteredCityCollections=function(){var i,r,t,u;for(this.nearbyCollections.clear(),this._seedInitialClusters(),i=!0,r=0;i&&r<n.maxIterations;)i=this._iterateCluster(),r++;for(this._pruneClusters(),t=0;t<this.nearbyCollections.length;t++)u=this.nearbyCollections[t],u.collection.id="nearby"+t,this._setClusterName(u)},t.prototype._seedInitialClusters=function(){for(var n,i,r,t=0,u=this.favorites.length;t<u;t++)if(n=this.favorites[t],i=this._findClosestCluster(n),i)this._insertAndUpdateCenterpoint(i,n);else{r=new c("nearby"+this.nearbyCollections.length,v.AutoCollections_Nearby.replace("{0}",n.entity.getName()));r.primitives.insert(n);var f=n.geometry,e=new y(f.y,f.x),o={centerpoint:e,collection:r};this.nearbyCollections.insert(o)}},t.prototype._iterateCluster=function(){for(var n,t,i,u,f=!1,r=this.nearbyCollections.length-1;r>=0;r--)for(n=this.nearbyCollections[r],t=n.collection.primitives.length-1;t>=0;t--)i=n.collection.primitives[t],u=this._findClosestCluster(i,n),u&&(this._insertAndUpdateCenterpoint(u,i),n.collection.primitives.remove(i),f=!0);return f},t.prototype._pruneClusters=function(){for(var t,i=this.nearbyCollections.length-1;i>=0;i--)t=this.nearbyCollections[i],t.collection.primitives.length<n.minimumClusterSize&&(t.collection.primitives.clear(),this.nearbyCollections.remove(t),t.collection.dispose())},t.prototype._findClosestCluster=function(t,i){for(var o,u,s=t.geometry,h=new y(s.y,s.x),f=-1,e=-1,r=0,c=this.nearbyCollections.length;r<c;r++)(o=this.nearbyCollections[r],o!==i)&&(u=ut.greatCircleDistance(h,o.centerpoint),u<n.maxNearbyDistance&&(f===-1||u<f)&&(f=u,e=r));return e===-1?null:this.nearbyCollections[e]},t.prototype._insertAndUpdateCenterpoint=function(n,t){n.collection.primitives.insert(t);n.centerpoint=this._computeCenterpoint(n.collection.primitives)},t.prototype._computeCenterpoint=function(n){var t=r.SpatialMath,i=t.Geometry;return i.centroid(n.slice())},t.prototype._setClusterName=function(n){this._reverseGeocoder.reverseGeocodeWithNetworkId(n.centerpoint,function(t){t&&t.addressList.length>0&&(n.collection.name=v.AutoCollections_Nearby.replace("{0}",t.addressList[0].locality||t.addressList[0].adminDistrict2),n.collection.changed.invoke())},["PopulatedPlace","Postcode1","AdminDivision1","AdminDivision2"])},t.prototype._updateImageUrls=function(){this._addImagesToCollectionMeta(this.labeledCollection);this._addImagesToCollectionMeta(this.nearHomeCollection);this._addImagesToCollectionMeta(this.nearWorkCollection);for(var n=0,t=this.nearbyCollections.length;n<t;n++)this._addImagesToCollectionMeta(this.nearbyCollections[n].collection)},t.prototype._addImagesToCollectionMeta=function(n){for(var u,i,r=n.collageImages.length,t=0,f=n.primitives.length;t<f&&r<3;t++)u=n.primitives[t],i=u.entity.getPhotoUrl(),i&&(n.collageImages.insert(i),r++)},t}(),k=function(){function t(){}return t.convertTravelItineraryToItineraryCollection=function(i){var e,r,h,o,u,c,f,l,s;if(!i)return null;if(e=i.Days?i.Days.length:0,r={$type:"ItineraryCollection",Name:i.Name,CollectionId:i.CollectionId,Description:i.Description,ItineraryDays:e||i.DayCount,Properties:{ItineraryDays:e||i.DayCount},InterestTypes:i.InterestTypes,Url:i.SeeAllPoisUrl,Image:i.Image&&i.Image.Url,ETag:i.ETag,ItineraryMetaETag:i.ItineraryMetaETag,CanShare:!0,Items:[]},n.enableMyPlacesUxRedesign&&(i.CollageImages&&(r.Properties.ImageUrls=b.Internals.stringify(i.CollageImages.slice())),i.ItineraryAttractions&&(r.Properties.AttractionNames=b.Internals.stringify(i.ItineraryAttractions.slice()))),i.gettyID&&(r.Properties.GettyId=i.gettyID,r.Properties.Photographer=i.photographer),i.startDate&&(r.Properties.StartDate=""+i.startDate),i.endDate&&(r.Properties.EndDate=""+i.endDate),i.Destinations&&i.Destinations.length){for(h=[],o=0;o<i.Destinations.length;o++)h.push(t.convertTravelItemToPlace(i.Destinations[o]));r.Properties.Destinations=b.Internals.stringify(h)}for(u=0;u<e;u++)for(c=i.Days[u],f=0;f<c.length;f++)l=c[f],s=t.convertTravelItemToPlace(l),s.ItineraryInformation.DayIndex=u+1,s.DisplayOrder=f,r.Items.push(s);return r.ItemsCount=r.Items.length,r},t.convertTravelItemToPlace=function(n){var u={$type:"GeometryPoint",Latitude:n.Lat,Longitude:n.Lon},f={InterestTypes:n.InterestTypes,StayDurationInMinutes:n.StayDurationInMinutes,TimeToNextInSeconds:n.TimeToNext,KmToNext:n.KmToNext,ModeToNext:n.ModeToNext,DayIndex:n.DayIndex+1},t={$type:"Place",RoutableCoordinates:u,DisplayCoordinates:u,Geometry:u,ShowOnMap:!0,Name:n.Name,OriginalName:n.OriginalName||n.Name,Description:n.Description,Image:n.Image&&n.Image.Url,ItineraryInformation:f,ItemId:n.CloudGraphId,DisplayOrder:n.ItemIndex,BusinessType:n.CategoryId},r;return n.EntityTypes&&n.EntityTypes.length&&(t.EntityType=n.EntityTypes[0]),r=n.Id,i.hasSatoriId(r)?(t.EntityIdType="SatoriID",t.EntityId=r):i.hasSearchId(r)&&(t.EntityIdType="YPID",t.EntityId=r),t},t.convertItineraryCollectionToTravelItinerary=function(i){var h,r,e,c,l,o,a,y,s,f,u;if(!i)return null;if(h=i.ItineraryDays||i.Properties.ItineraryDays,r={Image:{Url:i.Image},InterestTypes:i.InterestTypes,Name:i.Name,CollectionId:i.CollectionId,SeeAllPoisUrl:i.Url,Description:i.Description,ETag:i.ETag,ItineraryMetaETag:i.ItineraryMetaETag,GuideUrl:"",DayCount:h,AttractionCount:i.ItemsCount,Days:[]},n.enableMyPlacesUxRedesign&&(this.listFromStringToObservable("collage",i,r),this.listFromStringToObservable("attractions",i,r)),i.Properties.GettyId&&(r.gettyID=i.Properties.GettyId,r.photographer=i.Properties.Photographer),i.Properties.StartDate&&(r.startDate=parseInt(i.Properties.StartDate)),i.Properties.EndDate&&(r.endDate=parseInt(i.Properties.EndDate)),e=i.Properties.Destinations,e&&e.length){for(c=b.Internals.parseJSON(e),l=[],o=0;o<c.length;o++)l.push(t.convertPlaceToTravelItem(c[o]));r.Destinations=l}for(a=0;a<h;a++)r.Days.push([]);for(y=i.Items?i.Items.length:0,s=0;s<y;s++){for(var p=i.Items[s],v=t.convertPlaceToTravelItem(p),w=p.ItineraryInformation.DayIndex-1;w>=r.Days.length;)r.Days.push([]);if(f=r.Days[w],f){for(u=0;u<v.ItemIndex;)if(f[u]&&f[u].ItemIndex<v.ItemIndex)u++;else break;f.splice(u,0,v)}}return r},t.listFromStringToObservable=function(n,t,i){var f=t.Properties&&(n==="collage"?t.Properties.ImageUrls:t.Properties.AttractionNames),e,r,u;if(f&&f.length){for(e=b.Internals.parseJSON(f),r=new h,u=0;u<e.length;u++)r.insert(e[u]);n==="collage"?i.CollageImages=r:i.ItineraryAttractions=r}},t.convertPlaceToTravelItem=function(n){var t=n.Geometry,i={Name:n.Name,OriginalName:n.OriginalName||n.Name,Description:n.Description,Id:n.EntityId,Lat:t&&t.Latitude,Lon:t&&t.Longitude,Image:{Url:n.Image},InterestTypes:n.ItineraryInformation.InterestTypes,StayDurationInMinutes:n.ItineraryInformation.StayDurationInMinutes,TimeToNext:n.ItineraryInformation.TimeToNextInSeconds,KmToNext:n.ItineraryInformation.KmToNext,ModeToNext:n.ItineraryInformation.ModeToNext,CloudGraphId:n.ItemId,ItemIndex:n.DisplayOrder,CategoryId:n.BusinessType};return n.EntityType&&(i.EntityTypes=[n.EntityType]),i},t}(),ot=function(){function n(){if(n.instance)return n.instance;this._mostRecentlyUsed=new h}return n.prototype.pushItinerary=function(n){var t={IsItinerary:!0,Itinerary:n};this._dedupeItem(t);this._pushItem(t);this._trimList()},n.prototype.pushCollection=function(n){var t={IsItinerary:!1,Collection:n};this._dedupeItem(t);this._pushItem(t);this._trimList()},n.prototype.pushOpenItinerary=function(n,t){var i={IsItinerary:!0,IsOpenTask:!0,TaskId:n,TaskTitle:t};this._dedupeItem(i);this._pushItem(i);this._trimList()},n.prototype.removeItinerary=function(n){for(var i,t=0,r=this._mostRecentlyUsed.length;t<r;t++)if(i=this._mostRecentlyUsed[t],i.IsItinerary&&i.Itinerary.collectionId===n.collectionId){this._mostRecentlyUsed.removeAt(t);break}},n.prototype.removeOpenItinerary=function(n){for(var i,t=0,r=this._mostRecentlyUsed.length;t<r;t++)if(i=this._mostRecentlyUsed[t],i.IsOpenTask&&i.TaskId===n){this._mostRecentlyUsed.removeAt(t);break}},n.prototype.getLength=function(){return this._mostRecentlyUsed.length},n.prototype.getList=function(){return this._mostRecentlyUsed.slice()},n.prototype._pushItem=function(n){this._mostRecentlyUsed.insert(n,0)},n.prototype._dedupeItem=function(n){for(var i,r=n.IsItinerary,u=n.IsOpenTask,t=0,f=this._mostRecentlyUsed.length;t<f;t++)if(i=this._mostRecentlyUsed[t],r&&!u&&i.Itinerary===n.Itinerary||!r&&i.Collection===n.Collection){this._mostRecentlyUsed.removeAt(t);break}},n.prototype._trimList=function(){var n=this._mostRecentlyUsed.length;n>3&&this._mostRecentlyUsed.removeAt(3,n-3)},n.instance=new n,n}(),g=function(t){function i(){return t!==null&&t.apply(this,arguments)||this}return w(i,t),i.makeRetrieveAllItinerariesMetadataRequest=function(t,i){var u={RequestType:1,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,CollectionType:"ItineraryCollection"},r=null;e.getFunctionalTestHooksEnabled()&&(r=n.retrieveAllItinerariesBag);o._makeCgRequest(t,i,u,r)},i.makeRetrieveItineraryRequest=function(t,i,r,u,f){var h={RequestType:f?10:3,CollectionId:t,ClientETag:i,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,CollectionType:"ItineraryCollection"},s;f&&(h.ExternalUserId=f);s=null;e.getFunctionalTestHooksEnabled()&&(s=n.retrieveItineraryBag);o._makeCgRequest(r,u,h,s)},i.makeCreateItineraryRequest=function(t,i,r){var f={RequestType:5,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:"0",ItineraryMetaClientETag:"0",CollectionToBeWritten:t,MetaToBeWritten:{},CollectionType:"ItineraryCollection"},u=null;e.getFunctionalTestHooksEnabled()&&(u=n.insertItineraryBag);o._makeCgRequest(i,r,f,u)},i.makeUpdateItineraryRequest=function(t,i,r){var f={RequestType:5,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:t.ETag,ItineraryMetaClientETag:t.ItineraryMetaETag,CollectionId:t.CollectionId,CollectionToBeWritten:t,CollectionType:"ItineraryCollection"},u=null;e.getFunctionalTestHooksEnabled()&&(u=n.updateItineraryBag);o._makeCgRequest(i,r,f,u)},i.makeUpdateItineraryMetadataRequest=function(t,i,r){t.Items=null;var f={RequestType:6,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:t.ETag,ItineraryMetaClientETag:t.ItineraryMetaETag,CollectionId:t.CollectionId,MetaToBeWritten:t,CollectionType:"ItineraryCollection"},u=null;e.getFunctionalTestHooksEnabled()&&(u=n.updateItineraryMetaBag);o._makeCgRequest(i,r,f,u)},i.makeDeleteItineraryRequest=function(t,i,r){var f={RequestType:7,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:t.ETag,ItineraryMetaClientETag:t.ItineraryMetaETag,CollectionId:t.CollectionId,CollectionType:"ItineraryCollection"},u=null;e.getFunctionalTestHooksEnabled()&&(u=n.deleteItineraryBag);o._makeCgRequest(i,r,f,u)},i.makeItineraryUpsertPrimitiveRequest=function(t,i,r,u,f){if(i){var s={RequestType:4,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:t.ETag,ItineraryMetaClientETag:t.ItineraryMetaETag,CollectionId:t.CollectionId,ItemToBeWritten:i,CollectionType:"ItineraryCollection"},h=null;e.getFunctionalTestHooksEnabled()&&(h=n.insertItineraryItemBag);f&&(s.ItemId=i.ItemId);o._makeCgRequest(r,u,s,h)}},i.makeItineraryDeletePrimitiveRequest=function(t,i,r,u){var s={RequestType:8,RequestOrigin:n.cgApiRequestOrigin,SchemaVersion:n.cgApiSchemaVersion,ClientETag:i.ETag,ItineraryMetaClientETag:i.ItineraryMetaETag,CollectionId:i.CollectionId,ItemId:t,CollectionType:"ItineraryCollection"},f=null;e.getFunctionalTestHooksEnabled()&&(f=n.deleteItineraryItemBag);o._makeCgRequest(r,u,s,f)},i}(o),pt=function(t){function i(){var n=this;return i.itineraryInstance?i.itineraryInstance:t.call(this,!0)||this}return w(i,t),i.prototype.retrieveAllItinerariesMetaData=function(n){var t=this;this._itineraries&&this._itinerariesRetrieved?n&&n(this._itineraries,0):g.makeRetrieveAllItinerariesMetadataRequest(function(i){t._handleItineraryRetrieveAllResponse(i,n)},function(i,r,u){r===null||r.CollectionsMetaMap?n&&n(null,i?9:0):t._handleItineraryRetrieveAllResponse(r,n,u)})},i.prototype.retrieveItinerary=function(n,t,i){var u=this,r,f,e,o;!n&&t?t(null,7):(r=this.getItineraryIndexFromCache(n),f=null,r!==this._invalidIndex&&this._itineraries[r].itemsRetrieved&&(f=this._itineraries[r].eTag),e=function(n){return u._handleSingleItineraryResponse(n,t)},o=function(n,i){i!==null&&i.CollectionsMap?u._handleSingleItineraryResponse(i,t):n===0?t&&t(u._itineraries[r],0):t&&t(null,n?9:0)},g.makeRetrieveItineraryRequest(n,f,e,o,i))},i.prototype.createItinerary=function(t,i){var r=this,u,f;!t&&i?i(null,7):(u=this.getItineraryIndexFromCache(t.collectionId),this._itineraries&&this._itineraries.length>=et._getMaxAllowedCollections()?i&&i(null,2):u===this._invalidIndex?(this._compareItineraryNames(t),f=k.convertTravelItineraryToItineraryCollection(tt.serialize(t)),g.makeCreateItineraryRequest(f,function(u){var o,f,c,s,e,l,a;for(r._itineraries||(r._itineraries=new h),t.collectionId=u.CollectionId,t.eTag=u.ServerETag,t.itineraryMetaETag=u.ItineraryMetaServerETag,t.itemsRetrieved=!0,t.externalUserId=u.ExternalUserId,o=t.getDays(),f=0,c=o.length;f<c;f++)for(s=o[f],e=0,l=s.length;e<l;e++)a=s[e],a.setCollectionId(u.CollectionId);r._itineraries.insert(t,0);n.enableMostRecentlyUsedList&&ot.instance.pushItinerary(t);i(t,0)},function(n){i&&i(null,n?9:0)})):i&&i(null,8))},i.prototype.deleteItinerary=function(t,i){var e=this,u,r,f;!t&&i?i(7):(u=this.getItineraryIndexFromCache(t),u!==this._invalidIndex?(r=this._itineraries[u],f=k.convertTravelItineraryToItineraryCollection(tt.serialize(r)),g.makeDeleteItineraryRequest(f,function(){n.enableMostRecentlyUsedList&&ot.instance.removeItinerary(r);r.collectionId="";r.changed.invoke();e._itineraries.removeAt(u);i(0)},function(n){i&&i(n?9:0)})):i&&i(5))},i.prototype.updateItinerary=function(n,t){var u=this,i,r;!n&&t?t(null,7):(i=this.getItineraryIndexFromCache(n.collectionId),r=k.convertTravelItineraryToItineraryCollection(tt.serialize(n)),g.makeUpdateItineraryRequest(r,function(n){return u._handleUpdateItineraryResponse(n,t,i)},function(n){t&&t(null,n?9:0)}))},i.prototype.updateItineraryMeta=function(n,t){var u=this,i,r;!n&&t?t(null,7):(i=this.getItineraryIndexFromCache(n.collectionId),r=k.convertTravelItineraryToItineraryCollection(tt.serialize(n)),g.makeUpdateItineraryMetadataRequest(r,function(n){var r=function(n){var i=function(i){i.ServerETag&&(n.eTag=i.ServerETag);i.ItineraryMetaServerETag&&(n.itineraryMetaETag=i.ItineraryMetaServerETag);t&&t(n,0)},r=function(n){t&&t(null,n?9:0)};g.makeRetrieveItineraryRequest(n.collectionId,n.eTag,i,r)};return u._handleUpdateItineraryResponse(n,r,i)},function(n){t&&t(null,n?9:0)}))},i.prototype.addItineraryItem=function(t,i,r){var f,u,e;if(r){if(t){if(!i){r(null,10);return}}else{r(null,7);return}if(f=this.getItineraryIndexFromCache(t),f===this._invalidIndex){r(null,5);return}if(u=this._itineraries[f],u.itemsRetrieved&&u.getAttractionCount()>=et._getMaxAllowedCollectionEntites()){r(null,3);return}e=k.convertTravelItineraryToItineraryCollection(tt.serialize(u));g.makeItineraryUpsertPrimitiveRequest(e,k.convertTravelItemToPlace(i.getItineraryItemMeta()),function(t){i.cloudGraphId=t.ItemId;t.ServerETag&&(u.eTag=t.ServerETag);t.ItineraryMetaServerETag&&(u.itineraryMetaETag=t.ItineraryMetaServerETag);n.enableMostRecentlyUsedList&&ot.instance.pushItinerary(u);r&&r(u,0,t.ItemId)},function(n){r(null,n===0?0:9)})}},i.prototype.deleteItineraryItem=function(n,t,i){if(i){if(!n){i(7);return}if(!t){i(10);return}var u=this.getItineraryIndexFromCache(n),r=this._itineraries[u],f=k.convertTravelItineraryToItineraryCollection(tt.serialize(r));g.makeItineraryDeletePrimitiveRequest(t,f,function(n){n.ServerETag&&(r.eTag=n.ServerETag);n.ItineraryMetaServerETag&&(r.itineraryMetaETag=n.ItineraryMetaServerETag);i(0)},function(){i(9)})}},i.prototype.updateItineraryItem=function(n,t,i){if(i){if(!n){i(7);return}if(!t){i(10);return}var u=this.getItineraryIndexFromCache(n),r=this._itineraries[u],f=k.convertTravelItineraryToItineraryCollection(tt.serialize(r));g.makeItineraryUpsertPrimitiveRequest(f,k.convertTravelItemToPlace(t.getItineraryItemMeta()),function(n){n.ServerETag&&(r.eTag=n.ServerETag);n.ItineraryMetaServerETag&&(r.itineraryMetaETag=n.ItineraryMetaServerETag);i&&i(0)},function(n){i(n===0?0:9)},!0)}},i.prototype._handleItineraryRetrieveAllResponse=function(n,t,i){var u=new h,f=n&&n.CollectionsMetaMap,e,c,r;if(f){for(e in f)if(f.hasOwnProperty(e)){var o=f[e],l=k.convertItineraryCollectionToTravelItinerary(o),s=this.getItineraryIndexFromCache(o.CollectionId);s!==this._invalidIndex?(c=this._itineraries[s],u.insert(c)):(r=new tt(l),r&&(r.externalUserId=n.ExternalUserId,r.eTag="",r.itineraryMetaETag=o.ETag,u.insert(r)))}this._itinerariesRetrieved=!0;this._itineraries=u;t&&t(this._itineraries,0)}else n&&i===404?(this._itinerariesRetrieved=!0,this._itineraries=u,t&&t(this._itineraries,0)):t&&t(this._itineraries,9)},i.prototype._handleSingleItineraryResponse=function(n,t){var u=n.CollectionsMap,r=u[n.CollectionId],f,e,i,o;if(!r)for(f in u)if(u.hasOwnProperty(f)){r=u[f];break}if(this._itineraries||(this._itineraries=new h),e=this.getItineraryIndexFromCache(r.CollectionId),r&&(o=k.convertItineraryCollectionToTravelItinerary(r),e!==this._invalidIndex?(i=this._itineraries[e],i.deserializeItineraryProperties(o)):(i=new tt(o),this._itineraries.insert(i))),!i){t&&t(null,5);return}i.externalUserId=n.ExternalUserId;i.eTag=n.ServerETag;i.itineraryMetaETag=n.ItineraryMetaServerETag;t&&t(i,0)},i.prototype._handleUpdateItineraryResponse=function(n,t,i){var r=this._itineraries[i];n.ServerETag&&(r.eTag=n.ServerETag);n.ItineraryMetaServerETag&&(r.itineraryMetaETag=n.ItineraryMetaServerETag);t&&t(r,0)},i.prototype.getItineraryIndexFromCache=function(n){var i=this._invalidIndex,r,t,u;if(n&&this._itineraries)for(r=this._itineraries.length,t=0;t<r;t++)if(u=this._itineraries[t],u.collectionId.toLowerCase()===n.toLowerCase()){i=t;break}return i},i.prototype._compareItineraryNames=function(n){var e=this._invalidIndex,r,i,t,u,f;if(n&&this._itineraries)for(r=1,i=n.getName(),t=0,u=this._itineraries.length;t<u;t++)f=this._itineraries[t],f.getName().indexOf(i)!==-1&&n.setName(i+" "+ ++r)},i.itineraryInstance=new i,i}(et),t=function(){function n(){}return n.id="id",n.ypid="ypid",n.sid="sid",n.eventId="eventId",n.nameField="name",n.description="description",n.address="address",n.isPublic="isPublic",n.entity="entity",n.primitives="primitives",n.geometry="geometry",n.geometryType="geometryType",n.geometryLongitudes="x",n.geometryLatitudes="y",n.bounds="bounds",n.area="area",n.style="style",n.displayOrder="displayOrder",n.routableLocation="routableLocation",n.labelLocation="labelLocation",n.photoId="photoId",n.photoUrl="photourl",n.businesslistingid="businesslistingid",n.serviceEndPoint="{ServiceEndPoint}",n.market="{Market}",n.collectionId="{CollectionId}",n.entityId="{EntityId}",n.logFeatureName="CX",n.defaultStyle={fillStyle:"rgba(189, 213, 245, .3)",strokeStyle:"#00ff00",lineWidth:6,strokeWidth:6,dashes:[0]},n.latLongPrecision=6,n}(),a=function(){function n(){}return n.viewMyPlaces="VMP",n.viewCollection="VCO",n.viewCollectionItemDetails="VCID",n.viewTemporaryCollection="VTC",n.processCollections="PC",n.viewAddNewCollection="VANC",n.newCollectionSave="NCS",n.saveButtonClicked="SBC",n.deleteButtonClicked="DBC",n.saveTemporaryCollection="STC",n.temporaryCollectionStatus="TCS",n.editCollection="ECO",n.editMyPlaces="EMP",n.routeCollection="RC",n.privacySharingState="PSS",n.itemCounts="CNT",n.favorites="FAV",n.pdpRequestFailure="PDPERR",n.seeAllCollectionClick="SAC",n.viewUpcomingEvents="VUE",n.loadUpcomingEvents="LUE",n.hasHomeWork="HWS",n.clickEntity="CE",n.SaveOnSerpClick="SOSC",n}(),pi=function(){function n(){}return n.getCollections="GC",n.getCollectionList="GCL",n.getCollectionDetails="GCD",n.loadMyPlacesView="LMPV",n.loadCollectionEntitiesView="LCEV",n.loadCollectionDetailsView="LCDV",n.renderCollectionPois="RCP",n.getFavorites="GFL",n}(),s=function(){function n(n,t,r){this.description=r;this.id=n;this.name=t;this.originalName=t;this.dateCreated=i.convertJavascriptDateToDateInTicks(new Date);this.dateModified=this.dateCreated;this.dateAccessed=this.dateCreated;this.addressFields={addressLine:"",formattedAddress:"",city:"",stateMunicipality:"",country:"",postalCode:"",neighborhood:""}}return n.deserialize=function(i){var r;return i&&i.id&&i.name&&(r=new n(i.id,i.name,i.description),r.displayOrder=i.displayOrder,r.routableLocation=i.routableLocation,r.routableLocation||(r.routableLocation=new y(0,0)),r.labelLocation=i.labelLocation,r.photoId=i.photoId,r.photoUrl=i.photoUrl||i[t.photoUrl],r.businesslistingid=i.businesslistingid,r.address=i.address,r.originalName=i.originalName),r},n.deserializeCgEntity=function(r,u){var e=r.Name?r.Name:r.OriginalName,f;if(u||(u=new n(r.ItemId,e,r.Description)),r.OriginalName&&(u.originalName=r.OriginalName),u.routableLocation=new y(0,0),f=r.DisplayCoordinates||r.RoutableCoordinates||r.Geometry,u.routableLocation.latitude=f.Latitude,u.routableLocation.longitude=f.Longitude,u.displayOrder=r.DisplayOrder,u.labelLocation=u.routableLocation,u.photoUrl=r.Image,u.metadataString=r.Properties&&r.Properties.MetadataString,u.segmentType=r.Properties&&r.Properties.SegmentType,r.DateAccessed&&(u.dateAccessed=r.DateAccessed),r.DateCreated&&(u.dateCreated=r.DateCreated),r.DateModified&&(u.dateModified=r.DateModified),u.categoryId=r.BusinessType,r.Address&&(u.address=r.Address.SingleLine,u.addressFields={formattedAddress:r.Address.SingleLine,city:r.Address.Locality,stateMunicipality:r.Address.Region,country:r.Address.Country,addressLine:r.Address.StreetAddress,postalCode:r.Address.PostalCode,neighborhood:""}),r.EntityIdType){switch(r.EntityIdType.toLowerCase()){case"ypid":u.businesslistingid=t.ypid+":";r.EntityId.toLowerCase().indexOf("yn")===-1&&(u.businesslistingid+="YN");u.businesslistingid+=r.EntityId;break;case"satoriid":u.businesslistingid=t.sid+":";u.businesslistingid+=r.EntityId;break;case"eventid":u.businesslistingid=t.eventId+":";u.businesslistingid+=r.EntityId}u.entityId=r.EntityId;u.entityIdType=r.EntityIdType}else i.hasSatoriId(r.EntityId)?u.businesslistingid=t.sid+":"+r.EntityId:i.hasEventId(r.EntityId)?u.businesslistingid=t.eventId+":"+r.EntityId:i.hasSearchId(r.EntityId)&&(u.businesslistingid=t.ypid+":"+r.EntityId);return u},n.serialize=function(n){var i,r,u;return n&&(i={},i[t.nameField]=n.name,i[t.id]=n.id,i[t.address]=n.address,i[t.description]=n.description,i[t.displayOrder]=n.displayOrder,i[t.routableLocation]=n.routableLocation,i[t.labelLocation]=n.labelLocation,i[t.photoId]=n.photoId,i.originalName=n.originalName,n.photoUrl&&n.photoUrl!==""&&(r=n.photoUrl,u=n.photoUrl.match("^/th/?"),u&&u.length>-1&&(r=location.protocol+"//"+location.hostname+n.photoUrl),i[t.photoUrl]=r),i[t.businesslistingid]=n.businesslistingid),i},n.serializeCgEntity=function(n,r){var u="Unknown",f,e,o;n.entityId&&n.entityIdType?(u=n.entityIdType,r.EntityId=n.entityId):n.businesslistingid&&(n.businesslistingid.indexOf(t.ypid)!==-1?u="YPID":n.businesslistingid.indexOf(t.sid)!==-1?u="SatoriID":n.businesslistingid.indexOf(t.eventId)!==-1&&(u="EventID"),r.EntityId=n.businesslistingid.replace("ypid:","").replace("sid:","").replace("eventId:",""));r.Name=n.name;r.OriginalName=n.originalName;r.ItemId=n.id;r.Description=n.description;r.EntityIdType=u;r.Address=n.addressFields?{SingleLine:n.address,Locality:n.addressFields.city,Region:n.addressFields.stateMunicipality,Country:n.addressFields.country,PostalCode:n.addressFields.postalCode,StreetAddress:n.addressFields.addressLine}:{SingleLine:n.address};r.DisplayOrder=n.displayOrder;r.BusinessType=n.categoryId;f=i.convertJavascriptDateToDateInTicks(new Date);r.DateCreated=n.dateCreated;r.DateModified=f;r.DateAccessed=f;r.Properties={MetadataString:n.metadataString,SegmentType:n.segmentType};n.photoUrl&&n.photoUrl!==""&&(e=n.photoUrl,o=n.photoUrl.match("^/th/?"),o&&o.length>-1&&(e=location.protocol+"//"+location.hostname+n.photoUrl),r.Image=e)},n.buildEntityDataTaskOptions=function(n){var r={},i={};return i.entryPoint=ri.Collections,i.descriptionList=[],n&&(n.businesslistingid&&(n.businesslistingid.indexOf("ypid:")!==-1||n.businesslistingid.indexOf("sid:")!==-1||n.businesslistingid.indexOf("eventId:")!==-1?i.id=n.businesslistingid:n.businesslistingid!=="0"&&(i.id="ypid:"+n.businesslistingid)),i.query=!i.id&&n.routableLocation?n.routableLocation.latitude.toFixed(t.latLongPrecision)+", "+n.routableLocation.longitude.toFixed(t.latLongPrecision):n.originalName,i.taskTitle=n.name,n.name!==n.originalName&&(i.originalName=n.originalName),n.description&&n.name!==n.description&&i.descriptionList.push(n.description),n.categoryId&&(i.selectedCategoryId=n.categoryId)),r.type=hi.localDetailsTask,r.state=i,r},n.prototype.getTitle=function(){return this.name},n.prototype.getOriginalName=function(){return this.originalName},n.prototype.getDescription=function(){return this.description},n.prototype.getAddress=function(){return this.address},n.prototype.getPhotoUrl=function(){return this.photoUrl},n.localEntityId="",n}(),kt=function(n){function t(t,i,r){var u=n.call(this,t,i,r)||this;return u.entityShown=!0,u}return w(t,n),t.deserializeCgEntity=function(r,u){if(r){var f=r.Name?r.Name:r.OriginalName;return u||(u=new t(r.ItemId||r.EntityId,f,r.Description)),n.deserializeCgEntity.call(this,r,u),u.type=r.$type,r.TimeInformationLocal&&(u.startDate=i.convertDateInTicksToJavascriptDate(r.TimeInformationLocal.StartTime),u.endDate=i.convertDateInTicksToJavascriptDate(r.TimeInformationLocal.EndTime)),r.ReservationDetails&&(u.emailLink=r.ReservationDetails.EmailDeepLinkId,u.reservationId=r.ReservationDetails.BookingConfirmationId),u}return null},t.prototype.getPrimaryLabelText=function(){return this.name},t.prototype.getSecondaryLabelText=function(){return v.L_UpcomingEventEntity_TimeLabelFormat.replace("{date}",d._formatLongDateString(this.startDate)).replace("{time}",d._formatTimeString(this.startDate))},t}(s),gt=function(n){function t(t,i,r){return n.call(this,t,i,r)||this}return w(t,n),t.deserializeCgEntity=function(i){var r,u;return i?(r=new t(i.ItemId||i.EntityId,i.Name,i.Description),n.deserializeCgEntity.call(this,i,r),i.ArrivalAirport&&(i.ArrivalAirport.$type="Airport",r.arrivalAirport=nt.deserialize(i.ArrivalAirport,!0),r.arrivalAirport.entity.flight=r,r.arrivalAirport.entity.startDate=r.endDate),i.DepartureAirport&&(i.DepartureAirport.$type="Airport",r.departureAirport=nt.deserialize(i.DepartureAirport,!0),r.departureAirport.entity.flight=r,r.name=r.departureAirport.entity.name,r.departureAirport.entity.startDate=r.startDate),i.FlightSegmentEvents&&i.FlightSegmentEvents.length>0&&(u=i.FlightSegmentEvents[0].FlightSegmentInformation,u&&(r.flightNumber=u.FlightNumber,r.airline=u.AirlineName)),r):null},t}(kt),wi=function(n){function t(t,i,r){return n.call(this,t,i,r)||this}return w(t,n),t.deserializeCgEntity=function(i){if(i){var u=i.Name?i.Name:i.OriginalName,r=new t(i.ItemId||i.EntityId,u,i.Description);return n.deserializeCgEntity.call(this,i,r),r.airportCode=i.AirportCode,r.city=i.Address.Locality,r}return null},t.prototype.getSecondaryLabelText=function(){return v.L_UpcomingEventEntity_TimeLabelFormat.replace("{date}",d._formatLongDateString(this.startDate)).replace("{time}",d._formatTimeString(this.startDate))},t}(s),bi=function(){function t(){}return t.deserializeEntity=function(t){var r=null,u,i;if(t&&t.$type){for(u=n.filteredEvents.split(";"),i=0;i<u.length;i++)if(t.$type===u[i])return r;r=t.$type.indexOf("Events")===0?t.$type.indexOf("FlightEvent")!==-1?gt.deserializeCgEntity(t):kt.deserializeCgEntity(t):t.$type.indexOf("Airport")===0?wi.deserializeCgEntity(t):s.deserializeCgEntity(t)}return r},t}(),l;(function(n){n[n.AddItem=1]="AddItem";n[n.DeleteItem=2]="DeleteItem";n[n.MetaUpdate=3]="MetaUpdate";n[n.ItineraryUpdate=4]="ItineraryUpdate"})(l||(l={}));var tt=function(t){function i(n){var i=t.call(this)||this;return i._privates.defineProperty("days",function(n,t){i.setDayCount(t.length)}),i._privates.defineProperty("cityName"),i._privates.defineProperty("image"),i._privates.defineProperty("guideUrl"),i._privates.defineProperty("interestTypes"),i._privates.defineProperty("attribution"),i._privates.defineProperty("itineraryId"),i._privates.defineProperty("gettyID"),i._privates.defineProperty("photographer"),i._privates.defineProperty("name",function(n,t){i._metaChangedHandler(n,t)}),i._privates.defineProperty("description",function(n,t){i._metaChangedHandler(n,t)}),i._privates.defineProperty("dayCount",function(n,t){i._updateAttractionCount();i._dayCountChangedHandler(n,t)}),i._privates.defineProperty("attractionCount"),i._privates.defineProperty("destinations",function(n,t){i._destinationsChangedHandler(n,t)}),i._privates.defineProperty("startDate",function(n,t){i._travelDatesChangedHandler(n,t)}),i._privates.defineProperty("endDate",function(n,t){i._travelDatesChangedHandler(n,t)}),i._dataManager=new pt,i.disposables=[],i._updateQueue=[],i.errorEvent=new it,i.itemsRetrieved=!1,i.isActive=!1,i.activeDay=0,n&&(i.deserializeItineraryProperties(n),i._initialized=!0),i.collageImages=n.CollageImages?n.CollageImages:new h,i.itineraryAttractions=n.ItineraryAttractions?n.ItineraryAttractions:new h,i}return w(i,t),i.prototype.dispose=function(){t.prototype.dispose.call(this);d._clearDisposables(this.disposables)},i.deserialize=function(n){return new i(n)},i.serialize=function(t){var i={CityName:t.getCityName(),GuideUrl:t.getGuideUrl(),InterestTypes:t.getInterestTypes(),Attribution:t.getAttribution(),ItineraryId:t.getItineraryId(),SeeAllPoisUrl:t.seeAllPoisUrl,CollectionId:t.collectionId,Name:t.getName(),Description:t.getDescription(),Image:{Url:t.getImage()},ETag:t.eTag,ItineraryMetaETag:t.itineraryMetaETag,Days:[],gettyID:t.getGettyID(),photographer:t.getPhotographer(),startDate:t.getStartDate(),endDate:t.getEndDate()},u,s,f,c,e,r,h,o;for(n.enableMyPlacesUxRedesign&&(t.collageImages&&(i.CollageImages=t.collageImages),t.itineraryAttractions&&(i.ItineraryAttractions=t.itineraryAttractions)),u=t.getDays(),s=0,f=0,c=u.length;f<c;f++){var l=u[f],a=l.length,v=[];for(e=0;e<a;e++)v.push(l[e].getItineraryItemMeta());i.Days.push(v);s+=a}if(i.DayCount=u.length,i.AttractionCount=s,r=t.getDestinations(),r&&r.length){for(h=[],o=0;o<r.length;o++)h.push(r[o].getItineraryItemMeta());i.Destinations=h}return i},i.prototype.deserializeItineraryProperties=function(t){var w=this,y,c,e,p,i,l,f,o,r,a;this.setCityName(t.CityName);this.setImage(t.Image&&t.Image.Url);this.setGuideUrl(t.GuideUrl);this.setInterestTypes(t.InterestTypes);this.setAttribution(t.Attribution);this.setItineraryId(t.ItineraryId);this.setName(t.Name);this.setDescription(t.Description||"");this.setGettyID(t.gettyID);this.setPhotographer(t.photographer);t.startDate&&this.setStartDate(t.startDate);t.endDate&&this.setEndDate(t.endDate);this.seeAllPoisUrl=t.SeeAllPoisUrl;this.collectionId=t.CollectionId;this.eTag=t.ETag;this.itineraryMetaETag=t.ItineraryMetaETag;var u=t.Days,s=[],v=0;if(n.enableMyPlacesUxRedesign&&(t.CollageImages&&(this.collageImages=t.CollageImages),t.ItineraryAttractions&&(this.itineraryAttractions=t.ItineraryAttractions)),!this.itemsRetrieved&&t.Destinations){for(y=new h,c=0;c<t.Destinations.length;c++)y.insert(new wt(t.Destinations[c],-1,0));this.setDestinations(y)}else this.itemsRetrieved||this.setDestinations(new h);if(u)if(e=this.getDays(),this.itemsRetrieved&&e&&e.length&&e.length===u.length&&this.getAttractionCount()===t.AttractionCount)for(i=0,l=u.length;i<l;i++)for(p=e[i],f=u[i],r=0,a=f.length;r<a;r++)p[r].cloudGraphId=f[r].CloudGraphId;else{for(i=0,l=u.length;i<l;i++){for(f=u[i],o=new h,r=0,a=f.length;r<a;r++)o.insert(new wt(f[r],i,r,this.collectionId));this.disposables.push(o.changed.add(function(n){return w._dayChangedHandler(n)}));s.push(o);v+=o.length}s.length&&t.AttractionCount===v&&(this.itemsRetrieved=!0);this.setDays(s);this.setDayCount(t.DayCount||s.length);this.setAttractionCount(t.AttractionCount||v)}},i.prototype.copy=function(n){var t=i.serialize(this);return n&&(t.Days=[]),new i(t)},i.prototype.addDay=function(){var i=this,n=new h,t;return this.disposables.push(n.changed.add(function(n){return i._dayChangedHandler(n)})),t=this.getDays(),t.push(n),this.setDayCount(t.length),n},i.prototype.removeDay=function(n){var t=this.getDays(),i;return n>=0&&n<t.length?(i=t.splice(n,1)[0],this.setDayCount(t.length),i):null},i.prototype.startReorder=function(){this._isReordering=!0},i.prototype.endReorder=function(){if(this.collectionId&&this._initialized){this._isReordering=!1;var n={UpdateType:l.ItineraryUpdate};this._updateQueue.push(n);this._requestOut||this._checkUpdateQueue()}},i.prototype.routeInfoUpdated=function(){if(this.collectionId&&this._initialized){var n={UpdateType:l.ItineraryUpdate};this._updateQueue.push(n);this._requestOut||this._checkUpdateQueue()}},i.prototype._checkUpdateQueue=function(){if(this._updateQueue.length>0){var n=this._updateQueue.splice(0,1)[0];switch(n.UpdateType){case l.AddItem:this._makeAddCall(n.ChangeEvent);break;case l.DeleteItem:this._makeDeleteCall(n.ChangeEvent);break;case l.MetaUpdate:this._makeUpdateMetaDataCall();break;case l.ItineraryUpdate:this._makeUpdateItineraryCall()}}},i.prototype._metaChangedHandler=function(n,t){if(t!==n&&this.collectionId&&this._initialized){var i={UpdateType:l.MetaUpdate};this._updateQueue.push(i);this._requestOut||this._checkUpdateQueue()}},i.prototype._travelDatesChangedHandler=function(n,t){if(t!==n&&this.collectionId&&this._initialized){var i={UpdateType:l.MetaUpdate};this._updateQueue.push(i);this._requestOut||this._checkUpdateQueue()}},i.prototype._destinationsChangedHandler=function(n,t){if(t&&t.length!==0&&this.collectionId&&this._initialized){var i={UpdateType:l.MetaUpdate};this._updateQueue.push(i);this._requestOut||this._checkUpdateQueue()}},i.prototype._dayCountChangedHandler=function(n,t){var i=t>n?l.MetaUpdate:t<n?l.ItineraryUpdate:null,r;i&&this.collectionId&&this._initialized&&(r={UpdateType:i},this._updateQueue.push(r),this._requestOut||this._checkUpdateQueue())},i.prototype._dayChangedHandler=function(n){var t=n.added&&n.added.length?l.AddItem:n.removed&&n.removed.length?l.DeleteItem:null,i,r;if(!t||!this.collectionId||!this._initialized||this._isReordering){t&&!this.collectionId&&this._initialized&&!this._isReordering&&(i=this.getAttractionCount()+(t===l.AddItem?1:-1),this.setAttractionCount(i));return}r={UpdateType:t,ChangeEvent:n};this._updateQueue.push(r);this._requestOut||this._checkUpdateQueue()},i.prototype._makeUpdateMetaDataCall=function(){var n=this;this._requestOut=!0;this._dataManager.updateItineraryMeta(this,function(t,i){n._requestOut=!1;i===0?n._checkUpdateQueue():n.errorEvent.invoke(i)})},i.prototype._makeUpdateItineraryCall=function(){for(var r,t,f,e,i=this,u=this.getDays(),n=0,o=u.length;n<o;n++)for(r=u[n],t=0,f=r.length;t<f;t++)e=r[t],e.dayIndex=n;this._requestOut=!0;this._dataManager.updateItinerary(this,function(n,t){i._requestOut=!1;t===0?i._checkUpdateQueue():i.errorEvent.invoke(t)})},i.prototype._makeAddCall=function(t){var i=this,r=t.added[0];this._requestOut=!0;this._dataManager.addItineraryItem(this.collectionId,r,function(u,f){if(i._requestOut=!1,f===0){if(n.enableMyPlacesUxRedesign){i._updateItineraryMetaWithNewImageAndInformation(!0,r);i._updateItineraryMetaWithNewImageAndInformation(!1,r);var e={UpdateType:l.MetaUpdate};i._updateQueue.push(e)}i.setAttractionCount(i.getAttractionCount()+t.added.length);i._checkUpdateQueue()}else i.errorEvent.invoke(f)})},i.prototype._makeDeleteCall=function(t){var i=this,r=t.removed[0];this._requestOut=!0;this._dataManager.deleteItineraryItem(this.collectionId,r.cloudGraphId,function(u){if(i._requestOut=!1,u===0){if(i.setAttractionCount(i.getAttractionCount()-t.removed.length),n.enableMyPlacesUxRedesign){i._removeMetadataForEntity(!0,r);i._removeMetadataForEntity(!1,r);var f={UpdateType:l.MetaUpdate};i._updateQueue.push(f)}i._checkUpdateQueue()}else i.errorEvent.invoke(u)})},i.prototype._updateAttractionCount=function(){for(var t=this.getDays(),i=0,n=0,r=t.length;n<r;n++)i+=t[n].length;this.setAttractionCount(i)},i.prototype._removeMetadataForEntity=function(n,t){var r=n?this.collageImages:this.itineraryAttractions,h,c,o,u,s,f,i,e;if(r.remove(n?t.imageUrl:t.getOriginalName()),h=this.getAttractionCount(),c=this.getDays(),r.length<3&&h>=3)for(o=!1,u=0,s=c;u<s.length;u++){for(f=s[u],i=0;i<f.length;i++)if(e=n?f[i].imageUrl:f[i].getOriginalName(),e&&r.indexOf(e)===-1){r.insert(e);o=!0;break}if(o)break}},i.prototype._updateItineraryMetaWithNewImageAndInformation=function(n,t){var i=n?t.imageUrl:t.getOriginalName(),u=n?this.collageImages.length:this.getAttractionCount(),r;i&&u<3&&(r=n?this.collageImages:this.itineraryAttractions,r.insert(i,0))},i}(rt),wt=function(n){function t(t,i,r,u,f){var e=this,o={},h,a,c,l,s;return e=n.call(this,o)||this,h=ft.features,a=h&&h.directions&&h.directions.unit,e._useKm=a===2,o.defineProperty("name",function(n,t){return e._updateItineraryItem(n,t)},null,{defaultValue:t.Name||t.OriginalName}),o.defineProperty("originalName",null,null,{defaultValue:t.OriginalName||t.Name}),o.defineProperty("description",function(n,t){return e._updateItineraryItem(n,t)},null,{defaultValue:t.Description||""}),o.defineProperty("interestTypes",null,null,{defaultValue:t.InterestTypes}),o.defineProperty("stayDuration",null,null,{defaultValue:t.StayDuration||t.StayDurationInMinutes&&d._formatDurationString(t.StayDurationInMinutes*60)}),o.defineProperty("modeToNext",function(){e._updatePrimitiveModeToNext()},null,{defaultValue:t.ModeToNext}),o.defineProperty("itemIndex",function(){e._updatePrimitiveIndex()},null,{defaultValue:r}),o.defineProperty("timeToNext",function(){e._updateDirectionsText()},null,{defaultValue:t.TimeToNext}),o.defineProperty("kmToNext",function(){e._updateDirectionsText()},null,{defaultValue:t.KmToNext}),o.defineProperty("directionsText"),e._dataManager=new pt,e._updateDirectionsText(),e.errorEvent=new it,c=t.Image.Url,li.isCardified&&(c=e._formatImageUrl(c)),e.imageUrl=c,e.cloudGraphId=t.CloudGraphId||"",e._collectionId=u||"",e._stayDurationInMinutes=t.StayDurationInMinutes,e.dayIndex=i,e.categoryId=t.CategoryId,e.entityTypes=t.EntityTypes,e.destination=t.Destination,t.Lat&&t.Lon&&(l=new y(t.Lat,t.Lon),s=new ci(t.Name,"",t.Id,l),s.modeToNext=t.ModeToNext,s.dayIndex=i,s.itemIndex=e.getItemIndex(),s.iconText=(e.getItemIndex()+1).toString(),s.isActiveDay=f,s.originalName=e.getOriginalName(),s.imageUrl=e.imageUrl,e._primitive=new si(l,s)),e}return w(t,n),t.getItemFromLocalSearchEntity=function(n){var f=n.getImageUrl()||"",u=f.match("/th/??"),r,i;return u&&u.length>-1&&n.setImageUrl(f.substr(u.index)),r={Name:n.getTitle(),Id:n.id,Lat:n.getLocation().latitude,Lon:n.getLocation().longitude,Image:{Url:n.getImageUrl()},CategoryId:n.getSelectedCategoryForIcon()},i=n.addressFields,r.Destination=i&&(i.city||i.stateMunicipality||i.country),r.EntityTypes=n.getSegmentTypes(),new t(r,-1,0)},t.prototype.setIsActive=function(n){this._primitive&&this._primitive.entity&&(this._primitive.entity.isActiveDay=n)},t.prototype.updatePrimitiveHTMLElement=function(n){this._primitive&&this._primitive.entity&&(this._primitive.entity.htmlElement=n)},t.prototype.getPrimitive=function(){return this._primitive},t.prototype.getPrimitiveLocation=function(){var n=this._primitive&&this._primitive.entity&&this._primitive.entity;return n&&n.getLocation()},t.prototype.getId=function(){var n=this._primitive&&this._primitive.entity&&this._primitive.entity;return n&&n.id},t.prototype.dispose=function(){n.prototype.dispose.call(this);this._primitive.dispose();this._primitive=null},t.prototype.getItineraryItemMeta=function(){var i=this._primitive&&this._primitive.entity&&this._primitive.entity,n,t;return i?(n={Url:this.imageUrl},t={Name:this.getName(),OriginalName:this.getOriginalName(),Description:this.getDescription(),Id:this._primitive.entity.id,Lat:this._primitive.getLocation().latitude,Lon:this._primitive.getLocation().longitude,StayDuration:this.getStayDuration(),StayDurationInMinutes:this._stayDurationInMinutes,Image:n,InterestTypes:this.getInterestTypes(),TimeToNext:this.getTimeToNext(),KmToNext:this.getKmToNext(),ModeToNext:this.getModeToNext(),CloudGraphId:this.cloudGraphId,DayIndex:this.dayIndex,ItemIndex:this.getItemIndex(),CategoryId:this.categoryId,EntityTypes:this.entityTypes,Destination:this.destination},t):null},t.prototype.setCollectionId=function(n){this._collectionId=n},t.prototype._updateDirectionsText=function(){var n=d._formatDurationString(this.getTimeToNext())+" · "+d._readableTextFromDistance(this.getKmToNext()*1e3,this._useKm);this.setDirectionsText(n)},t.prototype._updatePrimitiveIndex=function(){if(this._primitive&&this._primitive.entity){var n=this._primitive.entity;n.itemIndex=this.getItemIndex();n.iconText=(this.getItemIndex()+1).toString()}},t.prototype._updatePrimitiveModeToNext=function(){if(this._primitive&&this._primitive.entity){var n=this._primitive.entity;n.modeToNext=this.getModeToNext()}},t.prototype._updateItineraryItem=function(n,t,i){var r=this;(t!==n||i)&&this._collectionId&&(this._updateRequestOut?this._updateAgain=!0:(this._updateAgain=!1,this._updateRequestOut=!0,this._dataManager.updateItineraryItem(this._collectionId,this,function(n){n===0?(r._updateRequestOut=!1,r._updateAgain&&r._updateItineraryItem("","",!0)):r.errorEvent.invoke(n)})))},t.prototype._formatImageUrl=function(n){return n&&n.indexOf("h=80&w=80")>=0&&(n=n.replace("h=80&w=80","h=112&w=92")),n},t}(rt),st=function(r){function u(){var n=r.call(this)||this;return n.geometryType=3,n.crs=vt.instance,n}return w(u,r),u.prototype.getGeometry=function(){return this.geometry},u.prototype.setGeometry=function(n){this.geometry=n;this._length=i.calculateLength(this.geometry);this._area=i.calculateArea(this.geometry)},u.prototype.getArea=function(){return this._area||(this._area=i.calculateArea(this.geometry)),this._area},u.prototype.getLength=function(){return this._length||(this._length=i.calculateLength(this.geometry)),this._length},u.prototype.getLengthText=function(){var n=ft.features,t=n&&n.directions&&n.directions.unit;return d._createLengthText(this.getLength(),t===2)},u.prototype.getAreaText=function(){var n=ft.features,t=n&&n.directions&&n.directions.unit;return d._createAreaText(this.getArea(),t===2)},u.deserialize=function(n,t){if(t)return u.deserializeCgPolygon(n);var i;return n&&(i=new u,i.setGeometry(n.geometry),i.entity=s.deserialize(n.entity),i.polyShapeStyle=n.style,i.template=new at(n.style),i.entity.routableLocation.latitude&&i.entity.routableLocation.longitude||(i.entity.routableLocation.latitude=i.geometry.rings[0].y[0],i.entity.routableLocation.longitude=i.geometry.rings[0].x[0])),i},u.deserializeCgPolygon=function(n){var o,h,r,f,e,c,l,a;if(n&&n.Geometry){for(h=n.Geometry,r=h.OuterBoundary,o=new u,f={rings:[{x:[r[0].Longitude],y:[r[0].Latitude]}],bounds:[r[0].Latitude,r[0].Longitude,r[0].Latitude,r[0].Longitude]},e=1;e<r.length;e++)c=r[e].Latitude,l=r[e].Longitude,f.rings[0].x[e]=l,f.rings[0].y[e]=c,c>f.bounds[0]?f.bounds[0]=c:c<f.bounds[2]&&(f.bounds[2]=c),l>f.bounds[1]?f.bounds[1]=l:l<f.bounds[3]&&(f.bounds[3]=l);if(r=h.InnerBoundary,r&&r.length)for(f.rings[1]={x:[],y:[]},e=0;e<r.length;e++)c=r[e].Latitude,l=r[e].Longitude,f.rings[1].x[e]=l,f.rings[1].y[e]=c;o.setGeometry(f);o.entity=s.deserializeCgEntity(n);h.Style?(a=i.convertStrokeWeightToLineWidth(h.Style.StrokeWeight),o.polyShapeStyle={fillStyle:h.Style.FillColor,strokeStyle:h.Style.StrokeColor,lineWidth:a,strokeWidth:a,dashes:i.convertStrokeDashStyleToDashes(h.Style.StrokeDashStyle)}):o.polyShapeStyle=t.defaultStyle;o.template=new at(o.polyShapeStyle)}return o},u.serialize=function(n,i){if(i)return u.serializeCgPolygon(n);var r;return n&&(r={},r[t.geometryType]=n.geometryType,r[t.geometry]=n.getGeometry(),r[t.entity]=s.serialize(n.entity),r[t.style]=n.polyShapeStyle),r},u.serializeCgPolygon=function(n){var u,f,r,t;if(n){for(f=n.entity,r={$type:"GeometryPolygon",OuterBoundary:[],InnerBoundary:[],Style:{FillColor:n.polyShapeStyle.fillStyle,StrokeColor:n.polyShapeStyle.strokeStyle,StrokeWeight:i.convertLineWidthToStrokeWeight(n.polyShapeStyle.lineWidth),StrokeDashStyle:i.convertDashesToStrokeDashStyle(n.polyShapeStyle.dashes)}},t=0;t<n.geometry.rings[0].x.length;t++)r.OuterBoundary[t]={Latitude:n.geometry.rings[0].y[t],Longitude:n.geometry.rings[0].x[t]};if(n.geometry.rings[1])for(t=0;t<n.geometry.rings[1].x.length;t++)r.InnerBoundary[t]={Latitude:n.geometry.rings[1].y[t],Longitude:n.geometry.rings[1].x[t]};u={$type:"GeoAnnotation",Geometry:r,RoutableCoordinates:r.OuterBoundary[0],DisplayCoordinates:r.OuterBoundary[0],ShowOnMap:!0};s.serializeCgEntity(f,u)}return u},u.prototype.isTapEnabled=function(){return n.polygonTapEnabled},u}(rt),ht=function(r){function u(){var n=r.call(this)||this;return n.geometryType=2,n.crs=vt.instance,n}return w(u,r),u.prototype.getGeometry=function(){return this.geometry},u.prototype.setGeometry=function(n){this.geometry=n;this._length=i.calculateLength(this.geometry)},u.prototype.getArea=function(){return 0},u.prototype.getLength=function(){return this._length||(this._length=i.calculateLength(this.geometry)),this._length},u.prototype.getLengthText=function(){var n=ft.features,t=n&&n.directions&&n.directions.unit;return d._createLengthText(this.getLength(),t===2)},u.deserialize=function(n,t){if(t)return u.deserializeCgPolyline(n);var i;return n&&(i=new u,i.setGeometry(n.geometry),i.entity=s.deserialize(n.entity),i.polyShapeStyle=n.style,i.template=new at(n.style),i.entity.routableLocation.latitude&&i.entity.routableLocation.longitude||(i.entity.routableLocation.latitude=i.geometry.y[0],i.entity.routableLocation.longitude=i.geometry.x[0])),i},u.deserializeCgPolyline=function(n){var e,o,f,r,h,c,l,a;if(n&&n.Geometry){for(o=n.Geometry,f=o.Points,e=new u,r={x:[f[0].Longitude],y:[f[0].Latitude],bounds:[f[0].Latitude,f[0].Longitude,f[0].Latitude,f[0].Longitude]},h=1;h<f.length;h++)c=f[h].Latitude,l=f[h].Longitude,r.x[h]=l,r.y[h]=c,c>r.bounds[0]?r.bounds[0]=c:c<r.bounds[2]&&(r.bounds[2]=c),l>r.bounds[1]?r.bounds[1]=l:l<r.bounds[3]&&(r.bounds[3]=l);e.setGeometry(r);e.entity=s.deserializeCgEntity(n);o.LineStyle?(a=i.convertStrokeWeightToLineWidth(o.LineStyle.StrokeWeight),e.polyShapeStyle={fillStyle:o.LineStyle.FillColor,strokeStyle:o.LineStyle.StrokeColor,strokeWidth:a,lineWidth:a,dashes:i.convertStrokeDashStyleToDashes(o.LineStyle.StrokeDashStyle)}):e.polyShapeStyle=t.defaultStyle;e.template=new at(e.polyShapeStyle)}return e},u.serialize=function(n,i){if(i)return u.serializeCgPolyline(n);var r;return n&&(r={},r[t.geometryType]=n.geometryType,r[t.geometry]=n.getGeometry(),r[t.entity]=s.serialize(n.entity),r[t.style]=n.polyShapeStyle),r},u.serializeCgPolyline=function(n){var u,f,r,t;if(n){for(f=n.entity,r={$type:"GeometryLine",Points:[],LineStyle:{FillColor:n.polyShapeStyle.fillStyle,StrokeColor:n.polyShapeStyle.strokeStyle,StrokeWeight:i.convertLineWidthToStrokeWeight(n.polyShapeStyle.lineWidth),StrokeDashStyle:i.convertDashesToStrokeDashStyle(n.polyShapeStyle.dashes)}},t=0;t<n.geometry.x.length;t++)r.Points[t]={Latitude:n.geometry.y[t],Longitude:n.geometry.x[t]};u={$type:"GeoAnnotation",Geometry:r,RoutableCoordinates:r.Points[0],DisplayCoordinates:r.Points[0],ShowOnMap:!0};s.serializeCgEntity(f,u)}return u},u.prototype.isTapEnabled=function(){return n.polylineTapEnabled},u}(rt),nt=function(i){function r(){var n=i.call(this)||this;return n.geometryType=1,n.crs=vt.instance,n}return w(r,i),r.simplePointFactory=function(n){var o=n.location,f=o?+o.latitude.toFixed(6):0,e=o?+o.longitude.toFixed(6):0,c=n.title?n.title:f+", "+e,v=n.description?n.description:"",l=n.photoUrl?n.photoUrl:"",i=new s(s.localEntityId,c,v),u,h;if(i.address=n.address,n.addressFields&&(i.addressFields=n.addressFields),i.metadataString=n.metadataString,i.segmentType=n.segmentType,l!==""&&(i.photoUrl=l),i.routableLocation=i.labelLocation=new y(f,e),i.displayOrder=1,i.categoryId=n.categoryId,u=n.id,u&&u.length<=50){var a=u.toLowerCase().indexOf(t.ypid)===0,p=u.toLowerCase().indexOf(t.sid)===0,w=u.toLowerCase().indexOf(t.eventId.toLowerCase())===0;a&&u.toLowerCase().indexOf("yn")===-1&&(u=u.replace(":",":YN"));(a||p||w)&&(i.businesslistingid=u)}return n.nickName&&(i.originalName=c,i.name=n.nickName),h=new r,h.setGeometry({x:e,y:f,bounds:[f,e,f,e]}),h.entity=i,h},r.createSimplePointFromSearchEntity=function(n){var h=n.getTitle(),c=n.getAddress(),l=n.getDescription(),a=n.id&&n.id.length<=50&&(n.id.toLowerCase().indexOf(t.ypid)===0||n.id.toLowerCase().indexOf(t.sid)===0)?n.id:null,u=n.getLocation(),f=u?u.latitude:0,e=u?u.longitude:0,i=new s(s.localEntityId,h,l),o;return i.address=c,i.routableLocation=i.labelLocation=new y(f,e),i.displayOrder=1,i.businesslistingid=a,o=new r,o.setGeometry({x:e,y:f,bounds:[f,e,f,e]}),o.entity=i,o},r.prototype.getGeometry=function(){return this.geometry},r.prototype.setGeometry=function(n){this.geometry=n},r.prototype.getArea=function(){return 0},r.prototype.getLength=function(){return 0},r.deserialize=function(n,t){var i,u;return t?r.deserializeCgPoint(n):(n&&(i=new r,i.setGeometry(n.geometry),i.entity=s.deserialize(n.entity),i.entity.routableLocation.latitude&&i.entity.routableLocation.longitude&&(i.entity.routableLocation.latitude!==0||i.entity.routableLocation.longitude!==0)||(i.entity.routableLocation.latitude=i.geometry.y,i.entity.routableLocation.longitude=i.geometry.x),u=i.entity),i)},r.deserializeCgPoint=function(t){var u,i,f;if(t)if(i=t.Geometry||t.DisplayCoordinates||t.RoutableCoordinates,u=new r,u.setGeometry({x:i.Longitude,y:i.Latitude,bounds:[i.Latitude,i.Longitude,i.Latitude,i.Longitude]}),n.enableUpcomingEvents)if(f=bi.deserializeEntity(t),f)u.entity=f;else return null;else u.entity=s.deserializeCgEntity(t);return u},r.serialize=function(n,i){if(i)return r.serializeCgPoint(n);var u;return n&&(u={},u[t.geometryType]=n.geometryType,u[t.geometry]=n.getGeometry(),u[t.entity]=s.serialize(n.entity)),u},r.serializeCgPoint=function(n){var i,r,t;return n&&(r=n.entity,t={$type:"GeometryPoint",Latitude:n.geometry.y,Longitude:n.geometry.x},i={$type:"Place",RoutableCoordinates:t,DisplayCoordinates:t,Geometry:t,ShowOnMap:!0},s.serializeCgEntity(r,i)),i},r.prototype.isTapEnabled=function(){return n.simplePointTapEnabled},r}(rt),ki=function(n){function r(t){var r=this,i={};return r=n.call(this,i)||this,i.defineProperty("showDropdown",function(n,t){return r._onShowPopOutChanged(n,t)}),i.defineProperty("showSaveButton",null,null,{defaultValue:!0}),i.defineProperty("itineraries"),i.defineProperty("collections"),i.defineProperty("entityName"),i.defineProperty("entityAddress"),i.defineProperty("entityId"),i.defineProperty("entityLat"),i.defineProperty("entityLong"),i.defineProperty("entityCatId"),i.defineProperty("entityImage"),i.defineProperty("topPosition"),i.defineProperty("leftPosition"),r.signInState=new oi,r.controlTemplateFactory=t,r._templateName=vi,r.disposables=[],r.resources=v,r._dataManager=new pt,r._windowClickEventHandler=function(n){r._hideDropdown(n)},r}return w(r,n),r.prototype.setEntityInformation=function(n){var i,r;if(this._currentEntityState=n,i=n.data,i){this.setEntityName(i.title);r=i.id;switch(i.entityIdType){case 2:r=t.sid+":"+r;break;case 1:default:r=t.ypid+":"+r}this.setEntityId(r);this.setEntityLat(i.location.latitude);this.setEntityLong(i.location.longitude);this.setEntityCatId(i.categoryId);this.setEntityImage(i.photoUrl);this.setEntityAddress(i.address)}},r.prototype.saveOnSerpClicked=function(n){var t=this,u=this.signInState.getIsSignedIn();if(i.logAction(a.SaveOnSerpClick,{SI:u}),u){if(!this._isSaved)this.onFavoritesClick(null,function(){t._isSaved=!0;t._launchConfirmationTip();n(t.resources.SaveOnSerp_SavedButtonText)})}else p&&p.isEnabled()&&p.setItem(r.localStorageKey,JSON.stringify(this._currentEntityState)),sj_cook&&sj_cook.set("SRCHUSR","POEX","W",!0,"/"),window.location.assign(this.signInUrl)},r.prototype.saveOnSerpMouseEnter=function(){this._isSaved?this._launchConfirmationTip():this._showHoverTip()},r.prototype.saveOnSerpMouseLeave=function(){var n=this;this._isSaved?this._hoverTimeout=Microsoft.Maps.setTimeout(function(){n.confirmationTip&&n.confirmationTip.removeTip()},100):this.hoverTip&&this.hoverTip.removeTip()},r.prototype.checkSignInSave=function(n){var t=p&&p.isEnabled()&&p.getItem(r.localStorageKey);t&&this.signInState.getIsSignedIn()&&(this.setEntityInformation(JSON.parse(t)),this.saveOnSerpClicked(n),p&&p.isEnabled()&&p.removeItem(r.localStorageKey))},r.prototype.boolToDisplay=function(n){return n?"":"none"},r.prototype.boolToNotDisplay=function(n){return n?"none":""},r.prototype.fetchItineraries=function(){var n=this;this._dataManager.retrieveAllItinerariesMetaData(function(t){t&&n.setItineraries(t)})},r.prototype.fetchCollections=function(){var n=this;this._dataManager.retrieveAllCollectionsMetaData(function(t){t&&t.collections&&n.setCollections(t.collections)})},r.prototype.getControl=function(){if(!this._control){if(!this.controlTemplateFactory)throw"control template factory must be defined.";var n=this.controlTemplateFactory({templateText:this._templateName,staticResources:this});this._control=n.applyDataTemplate(this);this.disposables.push(n)}return this._control},r.prototype.dispose=function(){for(var n=0;n<this.disposables.length;n++)this.disposables[n].dispose();this.disposables=[]},r.prototype.onSaveClick=function(n){this.setShowDropdown(!0);n.stopPropagation();n.preventDefault()},r.prototype.onItineraryClick=function(n){var u=this,t,r,e,o;if(n){n.stopPropagation();n.preventDefault();var s=n.currentTarget,f=s.attributes["data-entityId"],i=f&&f.value;for(t=0,r=this.getItineraries();t<r.length;t++)e=r[t],o={Name:this.getEntityName(),Id:this.getEntityId(),Lat:this.getEntityLat(),Lon:this.getEntityLong(),StayDuration:"",InterestTypes:[],Image:{Url:this.getEntityImage()},CategoryId:this.getEntityCatId()},e.collectionId===i&&this._dataManager.retrieveItinerary(i,function(n,t){n&&t===0&&u._dataManager.addItineraryItem(i,new wt(o,0,0),function(){u.setShowDropdown(!1)})})}},r.prototype.onCollectionClick=function(n){var u=this,t,r,e;if(n){n.stopPropagation();n.preventDefault();var o=n.currentTarget,f=o.attributes["data-entityId"],i=f&&f.value,s=nt.simplePointFactory({title:this.getEntityName(),id:this.getEntityId(),categoryId:this.getEntityCatId(),location:new y(this.getEntityLat(),this.getEntityLong()),photoUrl:this.getEntityImage()});for(t=0,r=this.getCollections();t<r.length;t++)e=r[t],e.id===i&&this._dataManager.retrieveCollection(i,function(n,t){n&&t===0&&u._dataManager.addPrimitive(i,s,function(){u.setShowDropdown(!1)})})}},r.prototype.onTemporaryCollectionClick=function(n){if(n){n.stopPropagation();n.preventDefault();var t=nt.simplePointFactory({title:this.getEntityName(),id:this.getEntityId(),categoryId:this.getEntityCatId(),location:new y(this.getEntityLat(),this.getEntityLong()),photoUrl:this.getEntityImage()}),i=Math.floor(Math.random()*1e3)+"_"+Math.floor(Math.random()*1e3);t.entity.id=i;ni.addPoint(t);this.setShowDropdown(!1)}},r.prototype.onFavoritesClick=function(n,t){var i=this;n&&(n.stopPropagation(),n.preventDefault());this._dataManager.syncFavorites(function(n){var e,s;if(n===0){var u=i.getEntityLat(),f=i.getEntityLong(),o=i.getEntityName(),r=new ct;r.entity=new yt;r.entity.setOriginalName(o);r.entity.setName(o);r.entity.categoryId=i.getEntityCatId();r.entity.setAddress(i.getEntityAddress());e=i.getEntityId();e&&r.entity.setBusinesslistingid(e);r.entity.setPhotoUrl(i.getEntityImage());r.setGeometry({x:f,y:u,bounds:[u,f,u,f]});s=function(){i.setShowDropdown(!1);t&&t()};i._dataManager.createFavorite(r,s,2)}})},r.prototype.saveRootClass=function(n){return"bm_saveRoot"+(n?"":" noButton")},r.prototype._onShowPopOutChanged=function(n,t){var r=this,i=b(window);t?Microsoft.Maps.setTimeout(function(){i.add_event("click,contextmenu",r._windowClickEventHandler)},1):n&&i.remove_event("click,contextmenu",this._windowClickEventHandler)},r.prototype._hideDropdown=function(){this.getShowDropdown()?this.setShowDropdown(!1):b(window).remove_event("click,contextmenu",this._windowClickEventHandler)},r.prototype._launchConfirmationTip=function(){var i=this,n=new ei(v.SaveOnSerp_SavedButtonText,v.SaveOnSerp_ConfirmationLink),t=n.getRootElement(),r;this.disposables.push(n.tipRemoved.add(function(){i.confirmationTip=null}));this.disposables.push(n.tipHovered.add(function(){window.clearTimeout(i._hoverTimeout)}));this.disposables.push(n.messageLinkClicked.add(function(){i.confirmationTip.removeTip();sj_evt.fire("ShowSaveMapOverlay")}));this._control.append(t);t.set_style({top:this.getTopPosition()+6,left:this.getLeftPosition()-t[0].offsetWidth/2});r=b(".tooltipsLink",t[0]);r.length&&r[0].focus();this.confirmationTip&&this.confirmationTip.removeTip();this.confirmationTip=n},r.prototype._showHoverTip=function(){var i=this,n=new ai(null,null,[v.SaveOnSerp_HoverTip],!0,!0,!0,!1),t;n.setShowBeak(!0);n.setShowClose(!1);t=n.getRootElement();this.disposables.push(n.tipRemoved.add(function(){i.hoverTip=null}));this._control.append(t);t.set_style({top:this.getTopPosition()+6,left:this.getLeftPosition()-t[0].offsetWidth/2});this.hoverTip&&this.hoverTip.removeTip();this.hoverTip=n},r.localStorageKey="MyPlacesSaveOnSerp",r}(rt),ni=function(){function t(){}return t.addPoint=function(n){if(t._temporaryCollectionEnabled()){t.temporaryCollection&&t.syncedFromStorage||t.getCollection();var i=t._findExistingPoint(n.entity.id);return i===-1?(t.temporaryCollection.primitives.insert(n),t.commitChanges(),0):12}return 1},t.removePoint=function(n){if(t._temporaryCollectionEnabled()){var i=t._findExistingPoint(n);i!==-1&&t.temporaryCollection.primitives.removeAt(i);t.commitChanges()}},t.updatePoint=function(n,i,r){var f,u;t._temporaryCollectionEnabled()&&(f=t._findExistingPoint(n),f!==-1&&(u=t.temporaryCollection.primitives[f],u.entity.name=i,u.entity.description=r,u.changed.invoke(),t.temporaryCollection.primitives.changed.invoke()),t.commitChanges())},t.getCollection=function(){if(t._temporaryCollectionEnabled()){if(t.temporaryCollection||t._resetTemporaryCollection(),!t.syncedFromStorage){var i=p.getItem(t.collectionsLocalStorageKey),n=c.deserialize(JSON.parse(i));n&&n.primitives&&(t.temporaryCollection.primitives=n.primitives);t.syncedFromStorage=!0}return t.temporaryCollection}return null},t.commitChanges=function(){if(t._temporaryCollectionEnabled()){var n=JSON.stringify(c.serialize(t.temporaryCollection));p.setItem(t.collectionsLocalStorageKey,n)}},t.clearCollection=function(){t._temporaryCollectionEnabled()&&(p.removeItem(t.collectionsLocalStorageKey),t._resetTemporaryCollection())},t.logTemporaryCollection=function(){if(t._temporaryCollectionEnabled()&&!t.alreadyLogged){var r=p.getItem(t.collectionsLocalStorageKey),n=c.deserialize(JSON.parse(r));n&&n.primitives&&i.logAction(a.temporaryCollectionStatus,{ENT:n.primitives.length});t.alreadyLogged=!0}},t._resetTemporaryCollection=function(){t.temporaryCollection?(t.temporaryCollection.primitives.clear(),t.temporaryCollection.description=""):t.temporaryCollection=new c("TEMP",v.L_TemporaryCollectionTitle)},t._temporaryCollectionEnabled=function(){return(ft.isMapsVertical||n.enableSaveOnSerp)&&p.isEnabled()},t._findExistingPoint=function(n){var r,u,i;if(t.temporaryCollection)for(r=t.temporaryCollection.primitives,u=r?r.length:0,i=0;i<u;i++)if(r[i].entity.id===n)return i;return-1},t.collectionsLocalStorageKey="BingMapsUserCollections",t.maxLimit=100,t.temporaryCollection=new c("TEMP",v.L_TemporaryCollectionTitle),t.syncedFromStorage=!1,t.alreadyLogged=!1,t}();f.ServerRequestFactory=o;f.AutoCollectionGenerator=yi;f.Collection=c;f.CollectionConstants=t;f.CollectionEntity=s;f.CollectionLogActionName=a;f.CollectionsDataManager=et;f.CollectionsLocalStorageHelper=ni;f.EventEntity=kt;f.FavoriteEntity=yt;f.FavoritePoint=ct;f.FlightEntity=gt;f.Itinerary=tt;f.ItineraryConverter=k;f.ItineraryDataManager=pt;f.ItineraryItem=wt;f.ItineraryRequestFactory=g;f.MostRecentlyUsedList=ot;f.MyPlaces=bt;f.PerfEventNames=pi;f.Polygon=st;f.Polyline=ht;f.SaveDropdownControl=ki;f.SimplePoint=nt;f.Utilities=i}catch(ti){if(r.logger)r.logger.logCriticalError(ti);else throw ti;}}).call(window)